<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.6" />
<title>The Waf Book</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
div.tableblock > table {
  border: 1px solid gray;
}

div#header h1 {
       background: url('waf-64x64.png') no-repeat left center;
       padding-left: 80px;
       line-height: 80px;
       height: 80px;
}

div.title, caption.title {
	text-align: center;
	margin-bottom: 0.2em;
}

div.tableblock > table th {
	background-color: #F4F4F4;
}

h1, h2, h3, h4, h5, h6, span#author, div.title, caption.title, div.admonitionblock .icon, div#toctitle, div.sidebar-title, div.image-title {
	color: #333;
}

body, div.sectionbody, div#toctitle {
	font-family: 'Lucida Grande', Verdana, Arial, sans-serif;
}

</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
<h1>The Waf Book</h1>
<span id="author">Thomas Nagy</span><br />
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p></p></div>
</div>
</div>
<div class="sect1">
<h2 id="_イントロダクション">イントロダクション</h2>
<div class="sectionbody">
<div class="paragraph"><p>Copyright &#169; 2010-2011 Thomas Nagy</p></div>
<div class="paragraph"><p>この本のコピーは非商用目的で再配布できます。
ライセンスは
<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">by-nc-nd license</a>
に従います。</p></div>
<div class="sect2">
<h3 id="_ビルドシステムについて一言">ビルドシステムについて一言</h3>
<div class="paragraph"><p>ソフトウェアの複雑化に伴い、ソフトウェア作成のプロセスもさらに複雑になってきている。
今日のソフトウェアは様々な言語、コンパイラ、多くの分散した入力データファイルを必要とする。</p></div>
<div class="paragraph"><p>ソフトウェアは今やソフトウェアのビルドプロセスを表現するのに用いられており、それは簡単なスクリプト(シェルスクリプトやMakefile)やコンパイラ(CMakeやQMake)、完全なアプリケーション(SCons, Maven, Waf)の形態である。
ビルドシステムという用語は、アプリケーションのビルドに用いられるツールの設計、として使われる。</p></div>
</div>
<div class="sect2">
<h3 id="_wafのフレームワーク">Wafのフレームワーク</h3>
<div class="paragraph"><p>ビルドシステムはビルドするソフトウェアに関していくつかの想定をし、異なる言語やプロジェクトをビルドする際にそれらの想定は典型的に限定される。
例えば、AntはMakeよりもJavaのプロジェクトにおいては適しているが、単純なC言語のプロジェクトの管理に関してはMakeよりも制限されている。
プログラミング言語は一貫して進化しており、エンドユーザーにとって完全なビルドシステムを作ることは不可能である。</p></div>
<div class="paragraph"><p>Wafフレームワークは伝統的なビルドシステムと比べて幾分異なっており、 特定の言語のサポートを提供しない。
ソフトウェアプロジェクトで遭遇する主なユースケースのサポートに焦点をおいている。
本質的に拡張性を強調した、ビルドシステムの使用に適したコンポーネントのライブラリである。
しかしながら、デフォルトのディストリビューションが様々なプログラミング言語(C言語やD言語, Ocaml, Javaなど)やツールへのプラグインを含んでおり、柔軟性を失った製品ではない。
新たな拡張を作ることが標準的かつ推奨されているプラクティスである。</p></div>
</div>
<div class="sect2">
<h3 id="_この本の目的">この本の目的</h3>
<div class="paragraph"><p>この本の目的は実践を通してWafを使い、Waf拡張を記述し、Wafの内部構造を概観していくことで、Wafビルドシステムの使い方を明らかにすることである。
一般的なビルドシステムについては扱わないが、第二の目的は少数ではあるが、新しいテクニックやパターンをいくつかの例を通して示すことである。</p></div>
<div class="paragraph"><p>章立ては難易度順に並べられており、WafとPythonの基本的な使い方から始まり、徐々により難しいトピックに掘り下げていくため、章立て順に読んでいくことを推奨する。
また、本書を読む前にWafのディストリビューションにある例 <a href="http://code.google.com/p/waf/source/browse/trunk/demos/">examples</a> を見ることから始めるのもよいだろう。</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ダウンロードおよびインストール">2. ダウンロードおよびインストール</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_wafファイルの入手">2.1. Wafファイルの入手</h3>
<div class="paragraph"><p>Wafプロジェクト <a href="http://code.google.com/p/waf">Google Code</a> から入手できる。
現行のWafは <a href="http://www.python.org">cPython</a> の2.3から3.1、もしくは <a href="http://www.jython.org">Jython</a> の2.5以上を必要とする。</p></div>
<div class="sect3">
<h4 id="_wafバイナリのダウンロードおよび使い方">2.1.1. Wafバイナリのダウンロードおよび使い方</h4>
<div class="paragraph"><p>WafのバイナリはPythonのスクリプトで、その以外のインストールは必要はない。
書き込み可能なフォルダから実行できる。
必要ならば <tt>waf</tt> と名前を変更するとよい。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ wget http://waf.googlecode.com/files/waf-1.6.10</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ mv waf-1.6.10 waf</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ python waf --version</span></span>
<span style="color: #000000">waf 1.6.10 (54dc13ba5f51bfe2ae277451ec5ac1d0a91c7aaf)</span></tt></pre></div></div>
<div class="paragraph"><p><tt>waf</tt> ファイルのライブラリは圧縮されたバイナリストリームとしてファイル内に存在する。
実行されると、ライブラリはカレントディレクトリの隠しフォルダに展開される。
もしフォルダが削除されると、実行時に再度作成される。
この仕組みにより、異なるバージョンのWafを同じフォルダで実行できる。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ ls -ld .waf*</span></span>
<span style="color: #000000">.waf-1.6.10-2c924e3f453eb715218b9cc852291170</span></tt></pre></div></div>
<div class="paragraph"><p>備考: バイナリファイルは自前でビルドしインストールされたcPythonでは利用できないかもしれない。 <a href="http://docs.python.org/library/bz2.html">bzip2</a> による圧縮サポートが必要である。</p></div>
</div>
<div class="sect3">
<h4 id="_ソースコードからのwafのビルド">2.1.2. ソースコードからのWafのビルド</h4>
<div class="paragraph"><p>WafのビルドにはPythonインタプリタのバージョンが2.6から3.1の範囲であることが要求される。
ソースコードはPython2.3, 2.4および2.5をサポートするように処理される。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ wget http://waf.googlecode.com/files/waf-1.6.10.tar.bz2</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ tar xjvf waf-1.6.10.tar.bz2</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ cd waf-1.6.10</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ python waf-light</span></span>
<span style="color: #000000">Configuring the project</span>
<span style="color: #000000">'build' finished successfully (0.001s)</span>
<span style="color: #000000">Checking for program python              : /usr/bin/python</span>
<span style="color: #000000">Checking for python version              : (2, 6, 5, 'final', 0)</span>
<span style="color: #000000">'configure' finished successfully (0.176s)</span>
<span style="color: #000000">Waf: Entering directory `/waf-1.6.10/build'</span>
<span style="color: #000000">[1/1] create_waf:  -&gt; waf</span>
<span style="color: #000000">Waf: Leaving directory `/waf-1.6.10/build'</span>
<span style="color: #000000">'build' finished successfully (2.050s)</span></tt></pre></div></div>
<div class="paragraph"><p>古いインタプリタについては、bzip2の替わりにgzipの圧縮で <tt>waf</tt> をビルドすることができる。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ python waf-light --zip-type=gz</span></span></tt></pre></div></div>
<div class="paragraph"><p><em>waflib/extras</em> フォルダに存在するファイルはテストの段階にあるWafツールの拡張だ。
これらの拡張は <em>--tools</em> スイッチによってWafバイナリに追加される。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ python waf-light --tools=compat15,swig,doxygen</span></span></tt></pre></div></div>
<div class="paragraph"><p><em>compat15</em> は以前のWafのバージョンとの互換性を提供するツールだ。
削除するには <em>--prelude</em> スイッチを変えることによって初期化を変更する必要がある。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ python waf-light --make-waf --prelude='' --tools=swig</span></span></tt></pre></div></div>
<div class="paragraph"><p>最後に、外部ツールをインポートし、初期化時に読み込む方法を示す。
<tt>aba.py</tt> はカレントディレクトリに存在すると仮定する。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">foo</span><span style="color: #000000">():</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Context </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> WAFVERSION</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">"This is Waf %s"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> WAFVERSION</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>次のように実行することで、実行時に <em>foo</em> をインポートして実行する独自のWafファイルが作られる。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ python waf-light --make-waf --tools=compat15,$PWD/aba.py</span></span>
<span style="color: #000000">   --prelude=$'\tfrom waflib.extras import aba\n\taba.foo()'</span>
<span style="font-weight: bold"><span style="color: #993399">$ ./waf --help</span></span>
<span style="color: #000000">This is Waf 1.6.10</span>
<span style="color: #000000">[...]</span></tt></pre></div></div>
<div class="paragraph"><p><em>extras</em> に追加される外部ファイルは <em>--tools</em> スイッチに絶対パスで指定する。
それらのファイルはPythonファイルである必要はないが、Wafモジュールに存在する関数やクラスを変更する初期化コードの追加が典型的な用途だ。
<a href="http://code.google.com/p/waf/source/browse/trunk/build_system_kit/">build system kit</a>にはWafから派生した独自のビルドシステムを作る様々な例がある。</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_wafファイルの使い方">2.2. Wafファイルの使い方</h3>
<div class="sect3">
<h4 id="_パーミッションとエイリアス">2.2.1. パーミッションとエイリアス</h4>
<div class="paragraph"><p>WafスクリプトはPythonのスクリプトなので、通常 <tt>python</tt> を呼ぶことで実行される。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ python waf</span></span></tt></pre></div></div>
<div class="paragraph"><p>Unix系のシステムでは、実行権限を付与することで毎回 <tt>python</tt> を呼ぶ必要はなく、便利である。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ chmod 755 waf</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ ./waf --version</span></span>
<span style="color: #000000">waf 1.6.10 (54dc13ba5f51bfe2ae277451ec5ac1d0a91c7aaf)</span></tt></pre></div></div>
<div class="paragraph"><p>コマンドラインインタプリタがエイリアスをサポートするならば、次のようにエイリアスを設定することを推奨する。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ alias waf=$PWD/waf</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ waf --version</span></span>
<span style="color: #000000">waf 1.6.10 (54dc13ba5f51bfe2ae277451ec5ac1d0a91c7aaf)</span></tt></pre></div></div>
<div class="paragraph"><p>もしくは、実行パスにWafバイナリの位置を追加することもできる。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ export PATH=$PWD:$PATH</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ waf --version</span></span>
<span style="color: #000000">waf 1.6.10 (54dc13ba5f51bfe2ae277451ec5ac1d0a91c7aaf)</span></tt></pre></div></div>
<div class="paragraph"><p>本書の次のセクションでは、 <tt>waf</tt> で直接コマンドが呼べるように、エイリアスもしくは実行形式へのパスが設定されているものとする。</p></div>
</div>
<div class="sect3">
<h4 id="_ローカルのwaflibフォルダ">2.2.2. ローカルのwaflibフォルダ</h4>
<div class="paragraph"><p>バイナリファイルから自動的にWafのライブラリがアンパックされるが、ライブラリを可視フォルダに入れておく必要があることがある。
例えば、 <tt>waf-light</tt> はライブラリファイルを含まないので、 <tt>waf</tt> を作る際に <tt>waflib</tt> ディレクトリが使われる。</p></div>
<div class="paragraph"><p>次のダイアグラムで <tt>waflib</tt> ディレクトリを探索する過程を示す。</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="waflib.png" alt="waflibの探索" />
</div>
</div>
</div>
<div class="sect3">
<h4 id="_移植性に関する懸念">2.2.3. 移植性に関する懸念</h4>
<div class="paragraph"><p>デフォルトでは、推奨されるインタプリタはcPythonであるが、ユーザーの利便性のために、<a href="http://www.jython.org">Jython</a>インタプリタのバージョン2.5のコピーをWafの実行形式と一緒に再配布することができる。</p></div>
<div class="paragraph"><p>備考: <em>waf</em>, <em>jython2.5.jar</em> およびソースコードを含むプロジェクトはほぼどこでも使うことができる</p></div>
<div class="paragraph"><p>注意: <em>waf</em> スクリプトはキャッシュファイルをアンパックするため、書込み可能なフォルダに配置されなくてはならない</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_プロジェクトとコマンド">3. プロジェクトとコマンド</h2>
<div class="sectionbody">
<div class="paragraph"><p><em>waf</em> スクリプトはソフトウェアプロジェクトのビルドを意味し、単独で使われたときにはあまり役に立たない。
この章ではWafプロジェクトのセットアップに必要なもの、そして <em>waf</em> スクリプトの使い方について述べる。</p></div>
<div class="sect2">
<h3 id="_wafコマンド">3.1. wafコマンド</h3>
<div class="paragraph"><p>WafプロジェクトはWafが使うことができる関数と変数を含むPythonスクリプトである <em>wscript</em> という名前のファイルを使う。
<em>waf commands</em> という名前の特別な関数をコマンドラインで使うことができる。</p></div>
<div class="sect3">
<h4 id="_wafコマンドの宣言">3.1.1. wafコマンドの宣言</h4>
<div class="paragraph"><p>wafコマンドは本当にシンプルな関数で他の関数を呼び出すような任意のPythonコードを実行できる。
これらのコマンドは一つのパラメータを入力としてとり、次の例のように、特に値を返す必要はない：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #808080">#! /usr/bin/env python</span>
<span style="color: #808080"># encoding: utf-8</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span><span style="color: #000000"> </span><span style="color: #000000">hello</span><span style="color: #000000">(</span><span style="color: #000000">ctx </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'hello world'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
<em>waf コマンド</em> <strong>hello</strong>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
スクリプト間でのデータの共有に使われるWafコンテキスト
</td></tr>
</table></div>
<div class="paragraph"><p>そして、これがコマンドラインから <tt>waf</tt> に関数helloを呼び出させる方法だ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf hello</span></span>
<span style="color: #000000">hello world</span>
<span style="color: #000000">'hello' finished successfully (0.001s)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_wafコマンドの連鎖">3.1.2. wafコマンドの連鎖</h4>
<div class="paragraph"><p>複数のコマンドを同一の <em>wscript</em> ファイルで宣言するとができる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">ping</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">' ping! %d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">id</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">))</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">pong</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">' pong! %d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">id</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">))</span></tt></pre></div></div>
<div class="paragraph"><p>そして実行を連鎖させることができる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf ping pong ping ping</span></span>
<span style="color: #000000"> ping! 140704847272272</span>
<span style="color: #000000">'ping' finished successfully (0.001s)</span>
<span style="color: #000000"> pong! 140704847271376</span>
<span style="color: #000000">'pong' finished successfully (0.001s)</span>
<span style="color: #000000"> ping! 140704847272336</span>
<span style="color: #000000">'ping' finished successfully (0.001s)</span>
<span style="color: #000000"> ping! 140704847272528</span>
<span style="color: #000000">'ping' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="paragraph"><p>備考: コンテキストパラメータはそれぞれの実行されるコマンドのための新しいオブジェクトだ。また、クラスも異なる: configureのためのConfigureContext、ビルドのためのBuildContext、オプションのためのOptionContext、他のコマンドのためのContext。</p></div>
</div>
<div class="sect3">
<h4 id="_複数のスクリプトとフォルダの使用">3.1.3. 複数のスクリプトとフォルダの使用</h4>
<div class="paragraph"><p>Wafプロジェクトは最上位のディレクトリ階層に <em>wscript</em> を含まなくてはならないが、中身を複数のサブプロジェクトファイルに分割することができる。
ここでこのコンセプトを小さなプロジェクトで示す：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">|-- src</span>
<span style="color: #000000">|   `-- wscript</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="paragraph"><p>最上位のディレクトリ階層の <em>wscript</em> は同じコマンドをコンテキストオブジェクトの <em>recurse</em> という名前のメソッドを呼び出すことで、サブプロジェクトの <em>wscript</em> から呼び出す：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">ping</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ ping from '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">recurse</span><span style="color: #000000">(</span><span style="color: #009900">'src'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>そしてこれが <em>src/wscript</em> の内容だ</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">ping</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ ping from '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span></tt></pre></div></div>
<div class="paragraph"><p>実行すると結果が得られる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/execution_recurse</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf ping</span></span>
<span style="color: #000000">→ ping from /tmp/execution_recurse</span>
<span style="color: #000000">→ ping from /tmp/execution_recurse/src</span>
<span style="color: #000000">'ping' finished successfully (0.002s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ cd src</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf ping</span></span>
<span style="color: #000000">→ ping from /tmp/execution_recurse/src</span>
<span style="color: #000000">'ping' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="paragraph"><p>備考: メソッド <em>recurse</em> 、そして、アトリビュート <em>path</em> はすべてのWafコンテキストクラスから利用できる</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_wafプロジェクトの定義">3.2. Wafプロジェクトの定義</h3>
<div class="sect3">
<h4 id="_プロジェクトのconfigure_em_configure_em_コマンド">3.2.1. プロジェクトのconfigure (<em>configure</em> コマンド)</h4>
<div class="paragraph"><p>Wafは <em>wscript</em> を含むいかなるファルダからも呼び出すことができるが、通常単一のエントリーポイントを持つことはよい考えだ。
その上、整合的な振舞いを保証するために、同一のインポートの再定義と関数の再定義をすべてのwscriptファイルにも保存する。
次のコンセプトはWafプロジェクトの構造を考える上で助けになる：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
プロジェクトディレクトリ: パッケージ化され他の開発者やエンドユーザーに再配布されるソースファイルを含むディレクトリ
</p>
</li>
<li>
<p>
ビルドディレクトリ: プロジェクトから生成されたファイルを含むディレクトリ(コンフィギュレーションセット、ビルドファイル、ログなど)
</p>
</li>
<li>
<p>
システムファイル: プロジェクトに属さないファイルやフォルダ(オペレーティングシステムファイルなど)
</p>
</li>
</ol></div>
<div class="paragraph"><p><em>configure</em> という名前の既に定義されたコマンドはこれらのフォルダに関する情報を集めて保存するために使われる。
ここで前のセクションの例を次の最上位層のwscriptファイルで拡張する:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ configuring the project in '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">ping</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ ping from '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">recurse</span><span style="color: #000000">(</span><span style="color: #009900">'src'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
プロジェクトディレクトリを表現する文字列。一般に、topは <em>.</em> に設定され、最上位にwscriptを追加できないいくつかのプロリエタリなプロジェクトを除いて、topは <em>../..</em> または <em>/checkout/perforce/project</em> のような他のフォルダにも設定できる。
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ビルドディレクトリを表現する文字列。一般に、ビルドディレクトリが <em>/tmp/build</em> のような絶対パスに設定されているようないくつかのプロプリエタリなロジェクトを除いて <em>build</em> に設定される。安全にビルドディレクトリを削除できることが重要で、 <em>.</em> や <em>..</em> に設定してはならない。
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
<em>configure</em> 関数は <em>configure</em> コマンドによって呼び出される。
</td></tr>
</table></div>
<div class="paragraph"><p>スクリプト <em>src/wscript</em> は変更なし:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">ping</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ ping from '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span></tt></pre></div></div>
<div class="paragraph"><p>実行結果は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/execution_configure <img src="./callouts/1.png" alt="1" /></span></span>
<span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">|-- src</span>
<span style="color: #000000">|   `-- wscript</span>
<span style="color: #000000">`-- wscript</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf configure <img src="./callouts/2.png" alt="2" /></span></span>
<span style="color: #000000">→ configuring the project in /tmp/execution_configure</span>
<span style="color: #000000">'configure' finished successfully (0.021s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree -a</span></span>
<span style="color: #000000">|-- build_directory/ <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">|   |-- c4che/ <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">|   |   |-- build.config.py <img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">|   |   `-- _cache.py <img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">|   `-- config.log <img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">|--.lock-wafbuild <img src="./callouts/8.png" alt="8" /></span>
<span style="color: #000000">|-- src</span>
<span style="color: #000000">|   `-- wscript</span>
<span style="color: #000000">`-- wscript</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf ping</span></span>
<span style="color: #000000">→ ping from /tmp/execution_configure</span>
<span style="color: #000000">→ ping from /tmp/execution_configure/src</span>
<span style="color: #000000">'ping' finished successfully (0.001s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ cd src</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ waf ping <img src="./callouts/9.png" alt="9" /></span></span>
<span style="color: #000000">→ ping from /tmp/execution_configure</span>
<span style="color: #000000">→ ping from /tmp/execution_configure/src</span>
<span style="color: #000000">'ping' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
プロジェクトのconfigureを行うため、最上位のプロジェクトファイルを含むディレクトリに移動
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
<em>waf configure</em> を呼び出すことで実行される
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
ビルドディレクトリが作られた
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
コンフィギュレーションデータは <em>c4che/</em> に保存される
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
コマンドラインオプションと使われる環境変数は <em>build.config.py</em> に保存される
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
ユーザーのコンフィギュレーションセットは <em>_cache.py</em> に保存される
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
コンフィギュレーションログ(コンフィギュレーション中に生成された出力の複製)
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
関連のあるプロジェクトファイルとビルドディレクトリを指し示す隠しファイル
</td></tr>
<tr><td><img src="./callouts/9.png" alt="9" /></td><td>
サブフォルダから <em>waf</em> を呼出すとconfigureに使用したのと同一のwscriptファイルからコマンドを実行する
</td></tr>
</table></div>
<div class="paragraph"><p>備考: <em>waf configure</em> は常にwscriptファイルを含むディレクトリから呼び出される</p></div>
</div>
<div class="sect3">
<h4 id="_生成されたファイルの削除_em_distclean_em_コマンド">3.2.2. 生成されたファイルの削除(<em>distclean</em> コマンド)</h4>
<div class="paragraph"><p>コマンド <em>distclean</em> はビルドディレクトリとコンフィギュレーションで生成されたロックファイルを削除するために提供されている。
前のセクションでの例：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">→ configuring the project in /tmp/execution_configure</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree -a</span></span>
<span style="color: #000000">|-- build_directory/</span>
<span style="color: #000000">|   |-- c4che/</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   `-- config.log</span>
<span style="color: #000000">|--.lock-wafbuild</span>
<span style="color: #000000">`-- wscript</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf distclean <img src="./callouts/1.png" alt="1" /></span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree <img src="./callouts/2.png" alt="2" /></span></span>
<span style="color: #000000">|-- src</span>
<span style="color: #000000">|   `-- wscript</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
<em>distclean</em> コマンドの定義は暗黙的(wscriptファイルで宣言されない)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ツリーは元の状態に戻される: ビルドディレクトリもロックファイルもない
</td></tr>
</table></div>
<div class="paragraph"><p><em>distclean</em> の振舞はごく一般的で、対応する関数はwscriptで定義される必要はない。
振舞を変更するには次の例を参照：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ configuring the project'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">distclean</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">' Not cleaning anything!'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>実行する:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean</span></span>
<span style="color: #000000"> Not cleaning anything!</span>
<span style="color: #000000">'distclean' finished successfully (0.000s)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_プロジェクトソースのパッケージ化_em_dist_em_コマンド">3.2.3. プロジェクトソースのパッケージ化(<em>dist</em> コマンド)</h4>
<div class="paragraph"><p><em>dist</em> コマンドはプロジェクトのアーカイブを生成するために提供されている。
前掲のスクリプトを使って：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ configuring the project in '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span></tt></pre></div></div>
<div class="paragraph"><p><em>dist</em> コマンドを実行:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/execution_dist</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">→ configuring the project in /tmp/execution_dist</span>
<span style="color: #000000">'configure' finished successfully (0.005s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf dist</span></span>
<span style="color: #000000">New archive created: noname-1.0.tar.bz2 (sha='a4543bb438456b56d6c89a6695f17e6cb69061f5')</span>
<span style="color: #000000">'dist' finished successfully (0.035s)</span></tt></pre></div></div>
<div class="paragraph"><p>デフォルトでは, プロジェクト名とバージョンはそれぞれ <em>noname</em> と <em>1.0</em> にセットされる。
これらを変更するには、トップレベルのプロジェクトファイルで2つの変数を追加的に与える必要がある：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">APPNAME </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'webe'</span>
<span style="color: #000000">VERSION </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'2.0'</span>

<span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ configuring the project in '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span></tt></pre></div></div>
<div class="paragraph"><p>プロジェクトのconfigureは一度行われたため、もう一度configureを行う必要はない：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf dist</span></span>
<span style="color: #000000">New archive created: webe-2.0.tar.bz2 (sha='7ccc338e2ff99b46d97e5301793824e5941dd2be')</span>
<span style="color: #000000">'dist' finished successfully (0.006s)</span></tt></pre></div></div>
<div class="paragraph"><p>スクリプトで <em>dist</em> 関数を追加することでアーカイブを変更するために他にもパラメータを与えることができる；</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">dist</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">base_name </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo_2.0'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">algo      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'zip'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">excl      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">' **/.waf-1* **/*~ **/*.pyc **/*.swp **/.lock-w*'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">files     </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'**/wscript'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
アーカイブ名は <em>APPNAME</em> と <em>VERSION</em> から計算されるのではなく直接与えられる。
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
デフォルトの圧縮フォーマットは <em>tar.bz2</em> 。他の有効なフォーマットは <em>zip</em> と <em>tar.gz</em> だ
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
ファイルを探すために使われる <em>ctx.path.ant_glob()</em> に与えるための除外パターン
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
アーカイブに追加するファイルはWafのノードオブジェクトとして与えることができる(そのため <em>excl</em> は無視される)
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_コマンドラインオプションの定義_em_options_em_コマンド">3.2.4. コマンドラインオプションの定義(<em>options</em> コマンド)</h4>
<div class="paragraph"><p>Wafスクリプトはさまざまなデフォルトのコマンドラインオプションを提供し、 <tt>waf --help</tt> を実行することで使い方を確認することができる:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --help</span></span>
<span style="color: #000000">waf [command] [options]</span>

<span style="color: #000000">Main commands (example: ./waf build -j4)</span>
<span style="color: #000000">  build    : executes the build</span>
<span style="color: #000000">  clean    : cleans the project</span>
<span style="color: #000000">  configure: configures the project</span>
<span style="color: #000000">  dist     : makes a tarball for redistributing the sources</span>
<span style="color: #000000">  distcheck: checks if the project compiles (tarball from 'dist')</span>
<span style="color: #000000">  distclean: removes the build directory</span>
<span style="color: #000000">  install  : installs the targets on the system</span>
<span style="color: #000000">  list     : lists the targets to execute</span>
<span style="color: #000000">  step     : executes tasks in a step-by-step fashion, for debugging</span>
<span style="color: #000000">  uninstall: removes the targets installed</span>

<span style="color: #000000">Options:</span>
<span style="color: #000000">  --version             show program's version number and exit</span>
<span style="color: #000000">  -h, --help            show this help message and exit</span>
<span style="color: #000000">  -j JOBS, --jobs=JOBS  amount of parallel jobs (2)</span>
<span style="color: #000000">  -k, --keep            keep running happily even if errors are found</span>
<span style="color: #000000">  -v, --verbose         verbosity level -v -vv or -vvv [default: 0]</span>
<span style="color: #000000">  --nocache             ignore the WAFCACHE (if set)</span>
<span style="color: #000000">  --zones=ZONES         debugging zones (task_gen, deps, tasks, etc)</span>

<span style="color: #000000">  configure options:</span>
<span style="color: #000000">    -o OUT, --out=OUT   build dir for the project</span>
<span style="color: #000000">    -t TOP, --top=TOP   src dir for the project</span>
<span style="color: #000000">    --prefix=PREFIX     installation prefix [default: '/usr/local/']</span>
<span style="color: #000000">    --download          try to download the tools if missing</span>

<span style="color: #000000">  build and install options:</span>
<span style="color: #000000">    -p, --progress      -p: progress bar; -pp: ide output</span>
<span style="color: #000000">    --targets=TARGETS   task generators, e.g. "target1,target2"</span>

<span style="color: #000000">  step options:</span>
<span style="color: #000000">    --files=FILES       files to process, by regexp, e.g. "*/main.c,*/test/main.o"</span>

<span style="color: #000000">  install/uninstall options:</span>
<span style="color: #000000">    --destdir=DESTDIR   installation root [default: '']</span>
<span style="color: #000000">    -f, --force         force file installation</span></tt></pre></div></div>
<div class="paragraph"><p>コマンドラインオプションへのアクセスはどのコマンドからでも可能だ。
ここに値 <em>prefix</em> にアクセスする方法を示す：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ prefix is '</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">prefix</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>実行すると、次の結果が観測されるだろう：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">→ prefix is /usr/local/</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="paragraph"><p>プロジェクトのコマンドラインオプションを定義するには、特別なコマンド名 <em>options</em> をユーザースクリプトで定義する。
このコマンドは他のコマンドが実行される前に一度呼び出される。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_option</span><span style="color: #000000">(</span><span style="color: #009900">'--foo'</span><span style="color: #000000">,</span><span style="color: #000000"> action</span><span style="color: #000000">=</span><span style="color: #009900">'store'</span><span style="color: #000000">,</span><span style="color: #000000"> default</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">,</span><span style="color: #000000"> help</span><span style="color: #000000">=</span><span style="color: #009900">'Silly test'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ the value of foo is %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">foo</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>実行すると、次の結果が観測されるだろう：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure --foo=test</span></span>
<span style="color: #000000">→ the value of foo is 'test'</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="paragraph"><p>オプションのためのコマンドコンテキストはoptparseの機能へアクセスするためのショートカットだ。
optparseの詳細については<a href="http://docs.python.org/library/optparse.html">Python documentation</a>を参照。</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_em_build_em_コマンド">3.3. <em>build</em> コマンド</h3>
<div class="sect3">
<h4 id="_building_targets_em_build_em_コマンド">3.3.1. Building targets (<em>build</em> コマンド)</h4>
<div class="paragraph"><p><em>build</em> コマンドはターゲットのビルドに使われる。
ここで新しいプロジェクトを <em>/tmp/execution_build/</em> に作り、空のファイル <tt>foo.txt</tt> を作って別のファイル <tt>bar.txt</tt> にコピーするためのスクリプトを追加する：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'bar.txt'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p><em>waf build</em> を直接呼ぶとエラーになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/execution_build/</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf build</span></span>
<span style="color: #000000">The project was not configured: run "waf configure" first!</span></tt></pre></div></div>
<div class="paragraph"><p>ビルドはソースファイルを探す場所および作成されたファイルをアウトプットする場所を知るためにconfigureされたフォルダを必要とする。
再びトライしよう：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure build</span></span>
<span style="color: #000000">'configure' finished successfully (0.007s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/execution_build/build_directory'</span>
<span style="color: #000000">[1/2] foo.txt:  -&gt; build_directory/foo.txt <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">[2/2] bar.txt: build_directory/foo.txt -&gt; build_directory/bar.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/examples/execution_build/build_directory'</span>
<span style="color: #000000">'build' finished successfully (0.041s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree -a</span></span>
<span style="color: #000000">|-- build_directory/</span>
<span style="color: #000000">|   |-- bar.txt <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">|   |-- c4che/</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   |-- foo.txt</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- .wafpickle <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">|--.lock-wafbuild</span>
<span style="color: #000000">`-- wscript</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf build</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/execution_build/build_directory'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/execution_build/build_directory'</span>
<span style="color: #000000">'build' finished successfully (0.008s) <img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
<tt>bar.txt</tt> は <tt>foo.txt</tt> の後に作成されなくてはならないことをビルドから演繹される
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ターゲットはビルドディレクトリに作成される
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
ピックル化されたファイルはターゲットに関する情報を格納するために使われる
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
ターゲットが最新の状態にあるため、もう一度作成される必要はない
</td></tr>
</table></div>
<div class="paragraph"><p>コマンド <em>waf build</em> は通常非常に頻繁に実行されるため、暗黙に呼び出すショートカットが提供されている：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/execution_build/build_directory'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/execution_build/build_directory'</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_ターゲットのクリーン_em_clean_em_コマンド">3.3.2. ターゲットのクリーン (<em>clean</em> コマンド)</h4>
<div class="paragraph"><p><em>clean</em> コマンドはファイルとビルドで生成されたターゲットに関する情報を削除するために使われる。
wscriptの関数 <em>build</em> を使うのでwscriptに <em>clean</em> という名前の関数を追加する必要はない。</p></div>
<div class="paragraph"><p>クリーンの後、最新の状態であったとしてもターゲットはもう一度作られる。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf clean build -v</span></span>
<span style="color: #000000">'clean' finished successfully (0.003s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/execution_build/build_directory' <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">[1/2] foo.txt:  -&gt; build_directory/foo.txt <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">14:58:34 runner 'touch foo.txt' <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">[2/2] bar.txt: build_directory/foo.txt -&gt; build_directory/bar.txt</span>
<span style="color: #000000">14:58:34 runner 'cp foo.txt bar.txt'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/execution_build/build_directory'</span>
<span style="color: #000000">'build' finished successfully (0.040s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
デファルトですべてのコマンドはビルドディレクトリから実行される
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
<tt>foo.txt</tt> に関する情報が失われたのでリビルドされる
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
<em>-v</em> フラグを使うと、実行されるコマンドラインは表示される
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_さらなるbuildコマンド">3.3.3. さらなるbuildコマンド</h4>
<div class="paragraph"><p>次のすべてのコマンドはwscriptファイル中の同一の関数 <em>build</em> を使う：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<tt>build:</tt> ソースコードを処理してオブジェクトファイルを生成する
</p>
</li>
<li>
<p>
<tt>clean:</tt> buildで生成されたオブジェクトファイルを削除する(distcleanとは異なり、configurationは削除しない)
</p>
</li>
<li>
<p>
<tt>install:</tt> 生成されたすべてのオブジェクトファイルをチェックし、システムにコピーする(プログラム、ライブラリ、データファイルなど)
</p>
</li>
<li>
<p>
<tt>uninstall:</tt> ビルドディレクトリ中のファイルには触れずにシステムからオブジェクトファイルを削除し, インストールを元に戻す
</p>
</li>
<li>
<p>
<tt>list:</tt> ビルドセクション中のタスクジェネレータを列挙(waf --targets=nameで使うため)
</p>
</li>
<li>
<p>
<tt>step:</tt> デバッグのために特定のファイルを強制的にリビルドする
</p>
</li>
</ol></div>
<div class="paragraph"><p>アトリビュート<em>cmd</em> は実行されるコマンドの名前を保持する：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build_directory'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">cmd</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">cmd </span><span style="color: #000000">==</span><span style="color: #000000"> </span><span style="color: #009900">'clean'</span><span style="color: #000000">:</span>
<span style="color: #000000">                </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'cleaning!'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">else</span><span style="color: #000000">:</span>
<span style="color: #000000">                </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">cmd</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>実行結果の出力は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure clean build</span></span>
<span style="color: #000000">Setting top to : /tmp/execution_cmd</span>
<span style="color: #000000">Setting out to : /tmp/execution_cmd/build_directory</span>
<span style="color: #000000">configure</span>
<span style="color: #000000">'configure' finished successfully (0.002s)</span>
<span style="color: #000000">cleaning!</span>
<span style="color: #000000">'clean' finished successfully (0.002s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/execution_cmd/build_directory'</span>
<span style="color: #000000">build</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/execution_cmd/build_directory'</span>
<span style="color: #000000">'build' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="paragraph"><p>buildコマンドの利用方法については次章で詳しく述べる。</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_プロジェクトのconfigure">4. プロジェクトのconfigure</h2>
<div class="sectionbody">
<div class="paragraph"><p><em>configuration</em> コマンドはプロジェクトが要求するものを満しているかチェックし、その情報を格納するために使われる。
buildコマンドのような他のコマンドで使われるパラメータが格納される。</p></div>
<div class="sect2">
<h3 id="_永続データの使用">4.1. 永続データの使用</h3>
<div class="sect3">
<h4 id="_ビルドとのデータの共有">4.1.1. ビルドとのデータの共有</h4>
<div class="paragraph"><p>コンフィギュレーションコンテキストはビルドフェーズにおいて再利用することができるデータを格納するために使われる。
次の例から始めよう：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_option</span><span style="color: #000000">(</span><span style="color: #009900">'--foo'</span><span style="color: #000000">,</span><span style="color: #000000"> action</span><span style="color: #000000">=</span><span style="color: #009900">'store'</span><span style="color: #000000">,</span><span style="color: #000000"> default</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">,</span><span style="color: #000000"> help</span><span style="color: #000000">=</span><span style="color: #009900">'Silly test'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FOO </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">foo </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">find_program</span><span style="color: #000000">(</span><span style="color: #009900">'touch'</span><span style="color: #000000">,</span><span style="color: #000000"> var</span><span style="color: #000000">=</span><span style="color: #009900">'TOUCH'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">TOUCH</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FOO</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'${TOUCH} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
<em>env</em> 変数(dictに似た構造)にオプション <em>foo</em> を格納
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
プログラム <em>touch</em> を探して <em>ctx.env.TOUCH</em> に格納するためのコンフィギュレーションルーチン <span class="footnote"><br />[<em>find_program</em> は探索中にOSの環境と同じ変数を使うことができる、たとえば <em>CC=gcc waf configure</em>]<br /></span>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
configureでセットされた <em>ctx.env.FOO</em> の値を表示
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
変数 <em>${TOUCH}</em> は <em>ctx.env.TOUCH</em> に対応
</td></tr>
</table></div>
<div class="paragraph"><p>実行結果：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --foo=abcd -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.005s)</span>
<span style="color: #000000">Checking for program touch               : /usr/bin/touch <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">'configure' finished successfully (0.007s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/configuration_build/build'</span>
<span style="color: #000000">/usr/bin/touch <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">abcd</span>
<span style="color: #000000">[1/1] foo.txt:  -&gt; build/foo.txt</span>
<span style="color: #000000">10:56:41 runner '/usr/bin/touch foo.txt' <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/configuration_build/build'</span>
<span style="color: #000000">'build' finished successfully (0.021s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
コンフィギュレーションテスト <em>find_program</em> のアウトプット
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
<em>TOUCH</em> の値
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
ターゲット <em>foo.txt</em> を作成するためのコマンドライン
</td></tr>
</table></div>
<div class="paragraph"><p>変数 <em>ctx.env</em> は <strong>コンフィギュレーションセット</strong> と呼ばれ、 <em>ConfigSet</em> クラスのインスタンスだ。
このクラスはPythonのdictをラップし、シリアライズ処理をする。
そのため、(関数やクラスではない)単純な値に対してのみ使われる
値はPythonに似たフォーマットでビルドディレクトリに格納される：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">build/</span>
<span style="color: #000000">|-- foo.txt</span>
<span style="color: #000000">|-- c4che</span>
<span style="color: #000000">|   |-- build.config.py</span>
<span style="color: #000000">|   `-- _cache.py</span>
<span style="color: #000000">`-- config.log</span>

<span style="font-weight: bold"><span style="color: #993399">$ cat build/c4che/_cache.py</span></span>
<span style="color: #000000">FOO = 'abcd'</span>
<span style="color: #000000">PREFIX = '/usr/local'</span>
<span style="color: #000000">TOUCH = '/usr/bin/touch'</span></tt></pre></div></div>
<div class="paragraph"><p>備考: <em>ctx.env</em> への値の読み書きはconfigureおよびbuildコマンドにおいて可能であるが、コンフィギュレーションフェーズにおいてのみ、値はファイルに格納される。</p></div>
</div>
<div class="sect3">
<h4 id="_コンフィギュレーションセットの使い方">4.1.2. コンフィギュレーションセットの使い方</h4>
<div class="paragraph"><p>ここでコンフィギュレーションセットの使い方に関するより多くの例を提供する。
オブジェクト <strong>ctx.env</strong> はその中身にアクセスするための便利なメソッドを提供している：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">[</span><span style="color: #009900">'CFLAGS'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CFLAGS </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">append_value</span><span style="color: #000000">(</span><span style="color: #009900">'CXXFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O2'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'-g'</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">append_unique</span><span style="color: #000000">(</span><span style="color: #009900">'CFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'-O2'</span><span style="color: #000000">])</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">prepend_value</span><span style="color: #000000">(</span><span style="color: #009900">'CFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O3'</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">type</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">))</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FOO</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
キーに基づいたアクセス; リストを格納
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
アトリビュートに基づいたアクセス(2つの形態は等価)
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
それぞれの要素をリスト <em>ctx.env.CXXFLAGS</em> に追加。リストであることを想定
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
先頭に値を挿入。 <em>prepend_unique</em> のようなメソッドは存在しないので注意
</td></tr>
</table></div>
<div class="paragraph"><p>実行すると次のアウトプットが生成される：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">&lt;class 'waflib.ConfigSet.ConfigSet'&gt; <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">'CFLAGS' ['-O3', '-g', '-O2'] <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">'CXXFLAGS' ['-O2', '-g']</span>
<span style="color: #000000">'PREFIX' '/usr/local'</span>
<span style="color: #000000">[] <img src="./callouts/3.png" alt="3" /></span>

<span style="font-weight: bold"><span style="color: #993399">$ cat build/c4che/_cache.py <img src="./callouts/4.png" alt="4" /></span></span>
<span style="color: #000000">CFLAGS = ['-O3', '-g', '-O2']</span>
<span style="color: #000000">CXXFLAGS = ['-O2', '-g']</span>
<span style="color: #000000">PREFIX = '/usr/local'</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
オブジェクト <em>conf.env</em> は <em>waflib/ConfigSet.py</em> で定義されているConfigSetクラスのインスタンス
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
変更後の <em>conf.env</em> の内容
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
キーが未定義の場合、これはリストであることが想定されている(上記の <strong>append_value</strong> で使われている)
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
オブジェクト <em>conf.env</em> はデフォルトでこのファイルに格納される
</td></tr>
</table></div>
<div class="paragraph"><p>コピーとシリアライズのAPIも提供されている：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FOO </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'TEST'</span>

<span style="color: #000000">        env_copy </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">derive</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">        node </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #009900">'test.txt'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        env_copy</span><span style="color: #000000">.</span><span style="color: #000000">store</span><span style="color: #000000">(</span><span style="color: #000000">node</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">ConfigSet </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> ConfigSet</span>
<span style="color: #000000">        env2 </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">ConfigSet</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        env2</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #000000">node</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>

<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">node</span><span style="color: #000000">.</span><span style="color: #000000">read</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
<em>ctx.env</em> のコピーを生成 - これは浅いコピー
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ファイル <tt>test.txt</tt> を表すノードオブジェクトを生成するために <strong>ctx.path</strong> を使う
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
<tt>test.txt</tt> に <strong>env_copy</strong> の内容を格納
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
空の新たなConfigSetオブジェクトを生成
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
<tt>test.txt</tt> から値を読み込む
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
<tt>test.txt</tt> の内容を表示
</td></tr>
</table></div>
<div class="paragraph"><p>実行すると次のアウトプットが得られる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure</span></span>
<span style="color: #000000">'distclean' finished successfully (0.005s)</span>
<span style="color: #000000">FOO = 'TEST'</span>
<span style="color: #000000">PREFIX = '/usr/local'</span>
<span style="color: #000000">'configure' finished successfully (0.006s)</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_configureのユーティリティ">4.2. configureのユーティリティ</h3>
<div class="sect3">
<h4 id="_コンフィギュレーションメソッド">4.2.1. コンフィギュレーションメソッド</h4>
<div class="paragraph"><p>以前に見た <em>ctx.find_program</em> メソッドはコンフィギュレーションメソッドの例だ。
ここで他の例も示す：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">find_program</span><span style="color: #000000">(</span><span style="color: #009900">'touch'</span><span style="color: #000000">,</span><span style="color: #000000"> var</span><span style="color: #000000">=</span><span style="color: #009900">'TOUCH'</span><span style="color: #000000">)</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">check_waf_version</span><span style="color: #000000">(</span><span style="color: #000000">mini</span><span style="color: #000000">=</span><span style="color: #009900">'1.6.10'</span><span style="color: #000000">)</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">find_file</span><span style="color: #000000">(</span><span style="color: #009900">'fstab'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/opt'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'/etc'</span><span style="color: #000000">])</span></tt></pre></div></div>
<div class="paragraph"><p>コンテキストクラス <em>waflib.Configure.ConfigurationContext</em> によってこれらのメソッドは提供されるが、 <a href="http://docs.waf.googlecode.com/git/apidocs_16/index.html">API documentation</a> には掲載されていない。
モジュール性の理由により、これらは単純な関数として定義され動的に束縛される：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Configure </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> conf </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">@conf </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">hi</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ hello, world!'</span><span style="color: #000000">)</span>

<span style="color: #808080"># hi = conf(hi) <img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">hi</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
デコレータ <strong>conf</strong> をインポート
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
メソッド <em>hi</em> をコンフィギュレーションコンテキストクラスにバインドするためにデコレータを使う。 実際には、コンフィギュレーションメソッドはconfigureフェーズでのみ使われる。
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
デコレータは単純なPythonの関数。 Python2.3は <strong>@</strong> の構文をサポートしないため、関数は関数の宣言の後に呼ばなくてはならない
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
コンフィギュレーションコンテキストクラスにバインドしたメソッドを使う
</td></tr>
</table></div>
<div class="paragraph"><p>実行すると次のアウトプットが得られる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">→ hello, world!</span>
<span style="color: #000000">'configure' finished successfully (0.005s)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_wafツールのロードと使い方">4.2.2. Wafツールのロードと使い方</h4>
<div class="paragraph"><p>効率性のため、少数のメソッドのみがWafのコアに存在する。
ほとんどのコンフィギュレーションメソッドは <strong>Wafツール</strong> と呼ばれる拡張によってロードされる。
主要なツールはフォルダ <tt>waflib/Tools</tt> にあり、 <tt>waflib/extras</tt> にテストフェーズでのツールがある。
しかし、Wafツールはファイルシステムのどこからでも使うことができる。</p></div>
<div class="paragraph"><p>ここでコマンドラインオプションから <em>ctx.env.DANG</em> に値をセットする <tt>dang.py</tt> という名前の非常に単純なWafツールのデモをおこなう：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #808080">#! /usr/bin/env python</span>
<span style="color: #808080"># encoding: utf-8</span>

<span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ loading the dang tool'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Configure </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> conf</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">add_option</span><span style="color: #000000">(</span><span style="color: #009900">'--dang'</span><span style="color: #000000">,</span><span style="color: #000000"> action</span><span style="color: #000000">=</span><span style="color: #009900">'store'</span><span style="color: #000000">,</span><span style="color: #000000"> default</span><span style="color: #000000">=</span><span style="color: #009900">''</span><span style="color: #000000">,</span><span style="color: #000000"> dest</span><span style="color: #000000">=</span><span style="color: #009900">'dang'</span><span style="color: #000000">)</span>

<span style="color: #000000">@conf</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">read_dang</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">start_msg</span><span style="color: #000000">(</span><span style="color: #009900">'Checking for the variable DANG'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">dang</span><span style="color: #000000">:</span>
<span style="color: #000000">                ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">DANG </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">dang </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                ctx</span><span style="color: #000000">.</span><span style="color: #000000">end_msg</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">DANG</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">else</span><span style="color: #000000">:</span>
<span style="color: #000000">                ctx</span><span style="color: #000000">.</span><span style="color: #000000">end_msg</span><span style="color: #000000">(</span><span style="color: #009900">'DANG is not set'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">read_dang</span><span style="color: #000000">()</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
コマンドラインオプションを提供
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
関数 <em>read_dang</em> をctx.read_dang()を下で呼ぶための新たなコンフィギュレーションメソッドにバインド
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
現在のコマンドラインオプションから永続的な値をセットする
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
ビルドコンテキストのインスタンスをパラメータとして受け付ける <em>configure</em> という名前のコマンドを提供する
</td></tr>
</table></div>
<div class="paragraph"><p>ツールを読み込むために、configureの中でメソッド <em>load</em> を使わなくてはならない：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'dang'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'dang'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">DANG</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
<em>dang.py</em> で定義されたオプションをロード
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ツールdang.pyを読み込む。デフォルトでは、loadはツールで定義されている <em>configure</em> を呼び出す
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
configure中に <em>ctx.env.DANG</em> の値を変更する
</td></tr>
</table></div>
<div class="paragraph"><p>実行すると、次のアウトプットになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure --dang=hello</span></span>
<span style="color: #000000">→ loading the dang tool</span>
<span style="color: #000000">Checking for DANG                        : hello <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">'configure' finished successfully (0.006s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">→ loading the dang tool <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">Waf: Entering directory `/tmp/configuration_dang/build'</span>
<span style="color: #000000">hello</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/configuration_dang/build'</span>
<span style="color: #000000">'build' finished successfully (0.004s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
最初にツールはPythonモジュールとしてインポートされ、メソッド <em>configure</em> は <em>load</em> から呼び出される
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
configure中にロードされたツールはビルドフェーズでロードされる
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_複数のconfigure">4.2.3. 複数のconfigure</h4>
<div class="paragraph"><p><em>conf.env</em> オブジェクトはWafツールもしくはユーザーが提供するコンフィギュレーション関数によってアクセスされ修正される、configureの重要なポイントだ。
Wafツールはビルドスクリプトのために特別な構造を強制しないので、ツールはデフォルトオブジェクトの内容の修正を行うだけだ。
ユーザースクリプトは複数の <em>env</em> オブジェクトをconfigfureで提供することができ、前後で特定の値をセットすることができる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        env </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">env </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">setenv</span><span style="color: #000000">(</span><span style="color: #009900">'debug'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CC </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'gcc'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'gcc'</span><span style="color: #000000">)</span>

<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">setenv</span><span style="color: #000000">(</span><span style="color: #009900">'release'</span><span style="color: #000000">,</span><span style="color: #000000"> env</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'msvc'</span><span style="color: #000000">)</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CFLAGS </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/O2'</span><span style="color: #000000">]</span>

<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">all_envs</span><span style="color: #000000">[</span><span style="color: #009900">'debug'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
<em>conf.env</em> への参照を保存
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
コピーして <em>conf.env</em> を置き換える
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
<em>conf.env</em> を変更
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
再びコピーして <em>conf.env</em> を最初の値に置き換える
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
名前でコンフィギュレーションセットを呼び出す
</td></tr>
</table></div>
</div>
</div>
<div class="sect2">
<h3 id="_例外処理">4.3. 例外処理</h3>
<div class="sect3">
<h4 id="_コンフィギュレーション例外の発生と補足">4.3.1. コンフィギュレーション例外の発生と補足</h4>
<div class="paragraph"><p>configureのヘルパーはconfオブジェクトが提供するメソッドで、例えば <em>conf.find_program</em> メソッドのように、パラメータを探すのを助ける。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">find_program</span><span style="color: #000000">(</span><span style="color: #009900">'some_app'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>テストが正常に完了しない場合、 <em>waflib.Errors.ConfigurationError</em> 型の例外が発生する。
これはオペレーティングシステムの環境で何かが欠けている場合や、特定の条件が満されない場合によく起きる。
例えば：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Checking for program some_app         : not found</span>
<span style="color: #000000"> error: The program some_app could not be found</span></tt></pre></div></div>
<div class="paragraph"><p>これらの例外は <em>conf.fatal</em> を使って手動で発生させることができる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">fatal</span><span style="color: #000000">(</span><span style="color: #009900">"I'm sorry Dave, I'm afraid I can't do that"</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>これは同じようなエラーを表示する：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000"> error: I'm sorry Dave, I'm afraid I can't do that</span>
<span style="font-weight: bold"><span style="color: #993399">$ echo $?</span></span>
<span style="color: #000000">1</span></tt></pre></div></div>
<div class="paragraph"><p>次はコンフィギュレーション例外の補足の仕方だ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">try</span><span style="color: #000000">:</span>
<span style="color: #000000">                ctx</span><span style="color: #000000">.</span><span style="color: #000000">find_program</span><span style="color: #000000">(</span><span style="color: #009900">'some_app'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">except</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">errors</span><span style="color: #000000">.</span><span style="color: #000000">ConfigurationError</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                self</span><span style="color: #000000">.</span><span style="color: #000000">to_log</span><span style="color: #000000">(</span><span style="color: #009900">'some_app was not found (ignoring)'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
利便性のために、モジュール <em>waflib.Errors</em> は <em>ctx.errors</em> にバインドされている
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ログファイルに情報を追加
</td></tr>
</table></div>
<div class="paragraph"><p>実行結果は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="color: #000000">Checking for program some_app            : not found</span>
<span style="color: #000000">'configure' finished successfully (0.029s) <img src="./callouts/1.png" alt="1" /></span>

<span style="font-weight: bold"><span style="color: #993399">$ cat build/config.log <img src="./callouts/2.png" alt="2" /></span></span>
<span style="font-weight: bold"><span style="color: #993399"># project  configured on Tue Jul 13 19:15:04 2010 by</span></span>
<span style="font-weight: bold"><span style="color: #993399"># waf 1.6.10 (abi 98, python 20605f0 on linux2)</span></span>
<span style="font-weight: bold"><span style="color: #993399"># using /home/waf/bin/waf configure</span></span>
<span style="font-weight: bold"><span style="color: #993399">#</span></span>
<span style="color: #000000">Checking for program some_app</span>
<span style="color: #000000">not found</span>
<span style="color: #000000">find program=['some_app'] paths=['/usr/local/bin', '/usr/bin'] var=None -&gt; ''</span>
<span style="color: #000000">from /tmp/configuration_exception: The program ['some_app'] could not be found</span>
<span style="color: #000000">some_app was not found (ignoring) <img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
configureがエラーなしで完了
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
configureの実行に関する有用な情報を含んだログファイル
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
追加したログのエントリ
</td></tr>
</table></div>
<div class="paragraph"><p>手動でエラーを補足するのは不便なため、すべての <strong>@conf</strong> メソッドは <em>mandatory</em> という名前のパラメータを受け付け、コンフィギュレーションエラーを抑制する。
前のコードスニペットは次と等価だ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">find_program</span><span style="color: #000000">(</span><span style="color: #009900">'some_app'</span><span style="color: #000000">,</span><span style="color: #000000"> mandatory</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>一般的なルールとして、クライアントは決して終了コードや戻値を信頼してはならず、コンフィギュレーション例外を補足しなくてはならない。
ツールは常にコンフィギュレーションエラーを発生させることでエラーを表示し、クライアントに例外を処理する機会を与える。</p></div>
</div>
<div class="sect3">
<h4 id="_トランザクション">4.3.2. トランザクション</h4>
<div class="paragraph"><p>configureで呼ばれるWafツールは <em>conf.env</em> の内容を意図的に使用、変更することができる。
これらの変更は複雑で追跡やアンドゥができなくなる。
幸運なことに、コンフィギュレーション例外によってロジックを簡略化し、前の状態に簡単に戻ることができる。
次の例では一度に複数のツールを使うためのトランザクションの使い方を示す：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> compiler </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">(</span><span style="color: #009900">'gcc'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'msvc'</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #000080">try</span><span style="color: #000000">:</span>
<span style="color: #000000">                        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">stash</span><span style="color: #000000">()</span>
<span style="color: #000000">                        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #000000">compiler</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000080">except</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">errors</span><span style="color: #000000">.</span><span style="color: #000000">ConfigurationError</span><span style="color: #000000">:</span>
<span style="color: #000000">                        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">revert</span><span style="color: #000000">()</span>
<span style="color: #000000">                </span><span style="color: #000080">else</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #000080">break</span>
<span style="color: #000000">        </span><span style="color: #000080">else</span><span style="color: #000000">:</span>
<span style="color: #000000">                ctx</span><span style="color: #000000">.</span><span style="color: #000000">fatal</span><span style="color: #000000">(</span><span style="color: #009900">'Could not find a compiler'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p><em>stash</em> の複数の呼出しを作ることができるが、コピーは浅く、(リストなどの)複雑なオブジェクトの変更は永続的だ。
そのため、次のコードはconfigureのアンチパターンだ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CFLAGS </span><span style="color: #000000">+=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O2'</span><span style="color: #000000">]</span></tt></pre></div></div>
<div class="paragraph"><p>代わりに常にこのメソッドを使うべきだ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">append_value</span><span style="color: #000000">(</span><span style="color: #009900">'CFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'-O2'</span><span style="color: #000000">)</span></tt></pre></div></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ビルド">5. ビルド</h2>
<div class="sectionbody">
<div class="paragraph"><p>ここではビルドターゲットを処理するのに用られるビルドフェーズに関して詳細を提供する。</p></div>
<div class="sect2">
<h3 id="_エッセンシャルなビルドの概念">5.1. エッセンシャルなビルドの概念</h3>
<div class="sect3">
<h4 id="_ビルドの順序と依存性">5.1.1. ビルドの順序と依存性</h4>
<div class="paragraph"><p>ビルドプロセスの部分をなす、いくつかの概念を説明するため、ここでは新たな例を使う。
ファイル <tt>foo.txt</tt> と <tt>bar.txt</tt> は <tt>wscript</tt> のコピーによって作られ、ファイル <tt>foobar.txt</tt> は生成されたファイルの結合によって作られる。
ここに要約する: <span class="footnote"><br />[この例はデモ用であるが、実際、ファイルのコピーを避けるためのベストプラクティスと考えられる]<br /></span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">cp: wscript -&gt; foo.txt</span>
<span style="color: #000000">cp: wscript -&gt; bar.txt</span>
<span style="color: #000000">cat: foo.txt, bar.txt -&gt; foobar.txt</span></tt></pre></div></div>
<div class="paragraph"><p>3行のそれぞれの行は実行されるコマンドを表す。
<em>cp</em> コマンドがいかなる順序、もしくは並列に実行されようが、<em>cat</em> コマンドは他のすべてのコマンドの実行後に実行される。
<strong>ビルド順序</strong> に対する制約は次で表現される <a href="http://en.wikipedia.org/wiki/Directed_acyclic_graph">非循環有向グラフ</a>:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="dag_tasks.png" alt="同一のビルドのタスク表現" />
</div>
</div>
<div class="paragraph"><p>入力ファイルである <tt>wscript</tt> が変更されると、出力ファイルの <tt>foo.txt</tt> はもう一度作られる。
ファイル <tt>foo.txt</tt> は ファイル <tt>wscript</tt> に依存しているといえる。
<strong>ファイルの依存性</strong> も非循環有向グラフで表現される：</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="dag_nodes.png" alt="単純なビルドにおける依存関係" />
</div>
</div>
<div class="paragraph"><p>プロジェクトのビルドは、これらの制約を考慮したスケジュールによるコマンドの実行から構成される。
ビルド順序を保ちならが並列に実行し、依存関係を用いて不要なコマンドの実行がスキップされると、ビルドは高速化される。</p></div>
<div class="paragraph"><p>Wafでは、コマンドは <strong>task objects</strong> で表現される。
依存性はタスククラスによって使われ、それはファイルに基づくものか、特別な制約を課す抽象である。</p></div>
</div>
<div class="sect3">
<h4 id="_直接的なタスク宣言">5.1.2. 直接的なタスク宣言</h4>
<div class="paragraph"><p>ここでは、ビルドセクションで直接的にタスクを宣言することで、前のセクションのビルドを表現している:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">cp</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                </span><span style="color: #000080">return</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">exec_command</span><span style="color: #000000">(</span><span style="color: #009900">'cp %s %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">(</span>
<span style="color: #000000">                                self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">(),</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                                self</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span>
<span style="color: #000000">                        </span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000000">)</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">cat</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #000080">return</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">exec_command</span><span style="color: #000000">(</span><span style="color: #009900">'cat %s %s &gt; %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">(</span>
<span style="color: #000000">                                self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">(),</span>
<span style="color: #000000">                                self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">1</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">(),</span>
<span style="color: #000000">                                self</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span>
<span style="color: #000000">                        </span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>

<span style="color: #000000">        cp_1 </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">cp</span><span style="color: #000000">(</span><span style="color: #000000">env</span><span style="color: #000000">=</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        cp_1</span><span style="color: #000000">.</span><span style="color: #000000">set_inputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        cp_1</span><span style="color: #000000">.</span><span style="color: #000000">set_outputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">))</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_to_group</span><span style="color: #000000">(</span><span style="color: #000000">cp_1</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="color: #000000">        cp_2 </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">cp</span><span style="color: #000000">(</span><span style="color: #000000">env</span><span style="color: #000000">=</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span>
<span style="color: #000000">        cp_2</span><span style="color: #000000">.</span><span style="color: #000000">set_inputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">))</span>
<span style="color: #000000">        cp_2</span><span style="color: #000000">.</span><span style="color: #000000">set_outputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #009900">'bar.txt'</span><span style="color: #000000">))</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_to_group</span><span style="color: #000000">(</span><span style="color: #000000">cp_2</span><span style="color: #000000">)</span>

<span style="color: #000000">        cat_1 </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">cat</span><span style="color: #000000">(</span><span style="color: #000000">env</span><span style="color: #000000">=</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span>
<span style="color: #000000">        cat_1</span><span style="color: #000000">.</span><span style="color: #000000">set_inputs</span><span style="color: #000000">(</span><span style="color: #000000">cp_1</span><span style="color: #000000">.</span><span style="color: #000000">outputs </span><span style="color: #000000">+</span><span style="color: #000000"> cp_2</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">)</span>
<span style="color: #000000">        cat_1</span><span style="color: #000000">.</span><span style="color: #000000">set_outputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #009900">'foobar.txt'</span><span style="color: #000000">))</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_to_group</span><span style="color: #000000">(</span><span style="color: #000000">cat_1</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
タスククラスの宣言
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
Wafのタスクはターゲットを生成するための <strong>run</strong> メソッドをもつ
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
<em>waflib.Task.Task</em> のインスタンスは使用するファイルを表す入力および出力ファイルのオブジェクト(ノードオブジェクト)をもつ
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
手動による新たなタスクインスタンスの作成
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
<em>waflib.Node.Node</em> オブジェクトとして表現された入力および出力ファイルの設定
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
実行のためのビルドコンテキストにタスクを追加(しかしながら、すぐには実行されない)
</td></tr>
</table></div>
<div class="paragraph"><p>実行の出力結果は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf clean build <img src="./callouts/1.png" alt="1" /></span></span>
<span style="color: #000000">'clean' finished successfully (0.003s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_manual_tasks/build'</span>
<span style="color: #000000">[1/3] cp: wscript -&gt; build/foo.txt</span>
<span style="color: #000000">[2/3] cp: wscript -&gt; build/bar.txt</span>
<span style="color: #000000">[3/3] cat: build/foo.txt build/bar.txt -&gt; build/foobar.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/build_manual_tasks/build'</span>
<span style="color: #000000">'build' finished successfully (0.047s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf build <img src="./callouts/2.png" alt="2" /></span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_manual_tasks/build'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/build_manual_tasks/build'</span>
<span style="color: #000000">'build' finished successfully (0.007s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ echo " " &gt;&gt; wscript <img src="./callouts/3.png" alt="3" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf build</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_manual_tasks/build'</span>
<span style="color: #000000">[1/3] cp: wscript -&gt; build/foo.txt <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">[2/3] cp: wscript -&gt; build/bar.txt</span>
<span style="color: #000000">[3/3] cat: build/foo.txt build/bar.txt -&gt; build/foobar.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/build_manual_tasks/build'</span>
<span style="color: #000000">'build' finished successfully (0.043s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
このタスクは <em>clean</em> コマンドでは実行されない
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ビルドは再度生成されるのを避けるために、ファイルの痕跡を保つ
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
ソースファイルのひつとを変更する
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
依存関係グラフによりリビルドされる
</td></tr>
</table></div>
<div class="paragraph"><p>覚えておくべきこと:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
実行順序はタスクインスタンスの入力と出力のセットから <strong>自動計算</strong> される
</p>
</li>
<li>
<p>
依存関係はノードオブジェクト(ビルドとビルドの間にファイルのハッシュが保存され、比較される)から <strong>自動計算</strong> (ファイルは必要なときにリビルド)される
</p>
</li>
<li>
<p>
順序制約のないタスクはデフォルトで並列に実行される
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_タスクジェネレータによるタスクのカプセル化">5.1.3. タスクジェネレータによるタスクのカプセル化</h4>
<div class="paragraph"><p>直接タスクを宣言するのはtediousでスクリプトが長くなる。
機能的には、次は前の例と同等だ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'bar.txt'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cat ${SRC} &gt; ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt bar.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foobar.txt'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p><strong>ctx(&#8230;)</strong> コールはクラス <em>waflib.TaskGen.task_gen</em> へのショートカットで、このクラスのインスタンスは <strong>タスクジェネレータオブジェクト</strong> と呼ばれる.
タスクジェネレータは遅延コンテナで、必要なときにタスクとタスククラスの生成のみを行う：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        tg </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">type</span><span style="color: #000000">(</span><span style="color: #000000">tg</span><span style="color: #000000">))</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">tg</span><span style="color: #000000">.</span><span style="color: #000000">tasks</span><span style="color: #000000">)</span>
<span style="color: #000000">        tg</span><span style="color: #000000">.</span><span style="color: #000000">post</span><span style="color: #000000">()</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">tg</span><span style="color: #000000">.</span><span style="color: #000000">tasks</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">type</span><span style="color: #000000">(</span><span style="color: #000000">tg</span><span style="color: #000000">.</span><span style="color: #000000">tasks</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">]))</span></tt></pre></div></div>
<div class="paragraph"><p>出力結果：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">waf configure build</span>
<span style="color: #000000">Setting top to   : /tmp/build_lazy_tg</span>
<span style="color: #000000">Setting out to   : /tmp/build_lazy_tg/build</span>
<span style="color: #000000">'configure' finished successfully (0.204s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_lazy_tg/build'</span>
<span style="color: #000000">&lt;class 'waflib.TaskGen.task_gen'&gt; <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">[] <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">[{task: foo  -&gt; foo}] <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">&lt;class 'waflib.Task.foo'&gt; <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">[1/1] foo:  -&gt; build/foo</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/build_lazy_tg/build'</span>
<span style="color: #000000">'build' finished successfully (0.023s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
タスクジェネレータ型
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
生成されたタスクはリスト <em>tasks</em> (0..nタスクが追加され得る)に保存される
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
タスクはメソッドpost()の呼出後に作られる - 通常自動で内部的に呼び出される
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
ターゲット <tt>foo</tt> のために新しいタスククラスが作られる
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_ビルドフェーズの外観">5.1.4. ビルドフェーズの外観</h4>
<div class="paragraph"><p>ビルドプロセスの高レベルの外観は次のダイアグラムで表現される：</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="build_overview.png" alt="ビルドフェーズの外観" />
</div>
</div>
<div class="paragraph"><p>備考: すべてのタスクはすべての実行に先立って作られる。新しいタスクはビルド開始後に作られるが、依存関係は低レベルのAPIによって設定しなくてはならない。</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_さらなるビルドオプション">5.2. さらなるビルドオプション</h3>
<div class="paragraph"><p>いかなるオペレーションもタスクの一部として実行することができ、いくつかのシナリオは典型的で、便利な関数を提供することは理にかなっている。</p></div>
<div class="sect3">
<h4 id="_ビルド前後における特別なルーチンの実行">5.2.1. ビルド前後における特別なルーチンの実行</h4>
<div class="paragraph"><p>ユーザー関数はbuildコマンド(コールバック)中の2つの主要な時に実行されるようバインドすることができる：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
ビルド開始の直前(bld.add_pre_fun)
</p>
</li>
<li>
<p>
ビルド成功完了直後(bld.add_post_fun)
</p>
</li>
</ol></div>
<div class="paragraph"><p>これはビルド終了後のテストを実行する方法だ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_option</span><span style="color: #000000">(</span><span style="color: #009900">'--exe'</span><span style="color: #000000">,</span><span style="color: #000000"> action</span><span style="color: #000000">=</span><span style="color: #009900">'store_true'</span><span style="color: #000000">,</span><span style="color: #000000"> default</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">,</span>
<span style="color: #000000">                help</span><span style="color: #000000">=</span><span style="color: #009900">'execute the program after it is built'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">pre</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'before the build is started'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">post</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'after the build is complete'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">cmd </span><span style="color: #000000">==</span><span style="color: #000000"> </span><span style="color: #009900">'install'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                </span><span style="color: #000080">if</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">exe</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                        ctx</span><span style="color: #000000">.</span><span style="color: #000000">exec_command</span><span style="color: #000000">(</span><span style="color: #009900">'/sbin/ldconfig'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_pre_fun</span><span style="color: #000000">(</span><span style="color: #000000">pre</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_post_fun</span><span style="color: #000000">(</span><span style="color: #000000">post</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
コールバックはビルドコンテキストをユニークなパラメータ <em>ctx</em> として引数にとる
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
コマンドタイプにアクセス
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
コマンドラインオプションにアクセス
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
共通のシナリオとして、ファイルのインストール後にldconfigqを呼び出す
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
後の実行のために実行する関数のスケジューリング。Pythonの関数はオブジェクトでもある
</td></tr>
</table></div>
<div class="paragraph"><p>上記を実行すると、次の出力が得られる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build install --exe</span></span>
<span style="color: #000000">'distclean' finished successfully (0.005s)</span>
<span style="color: #000000">'configure' finished successfully (0.011s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_pre_post/build'</span>
<span style="color: #000000">before the build is started <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/build_pre_post/build'</span>
<span style="color: #000000">after the build is complete <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">'build' finished successfully (0.004s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_pre_post/build'</span>
<span style="color: #000000">before the build is started</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/build_pre_post/build'</span>
<span style="color: #000000">after the build is complete</span>
<span style="color: #000000">/sbin/ldconfig: Can't create temporary cache file /etc/ld.so.cache~: Permission denied <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">'install' finished successfully (15.730s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
<em>bld.add_pre_fun</em> によってバインドされた関数の出力
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
<em>bld.add_post_fun</em> によってバインドされた関数の出力
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
インストール時の実行
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_ファイルのインストール">5.2.2. ファイルのインストール</h4>
<div class="paragraph"><p>3つのビルドコンテキストメソッドはビルド中もしくは後に作られたファイルのインストールのために提供される：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
install_files: フォルダにいくつかのファイルをインストール
</p>
</li>
<li>
<p>
install_as: 異なる名前でターゲットをインストール
</p>
</li>
<li>
<p>
symlink_as: サポートされるプラットフォームにシンボリックリンクを作成
</p>
</li>
</ol></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">install_files</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/include'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'a1.h'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'a2.h'</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">install_as</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/dir/bar.png'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'foo.png'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">symlink_as</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/lib/libfoo.so.1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'libfoo.so.1.2.3'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">        env_foo </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">derive</span><span style="color: #000000">()</span>
<span style="color: #000000">        env_foo</span><span style="color: #000000">.</span><span style="color: #000000">PREFIX </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'/opt'</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">install_as</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/dir/test.png'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'foo.png'</span><span style="color: #000000">,</span><span style="color: #000000"> env</span><span style="color: #000000">=</span><span style="color: #000000">env_foo</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">        start_dir </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_dir</span><span style="color: #000000">(</span><span style="color: #009900">'src/bar'</span><span style="color: #000000">)</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">install_files</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/share'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'foo/a1.h'</span><span style="color: #000000">],</span>
<span style="color: #000000">                cwd</span><span style="color: #000000">=</span><span style="color: #000000">start_dir</span><span style="color: #000000">,</span><span style="color: #000000"> relative_trick</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">install_files</span><span style="color: #000000">(</span><span style="color: #009900">'${PREFIX}/share'</span><span style="color: #000000">,</span><span style="color: #000000"> start_dir</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'**/*.png'</span><span style="color: #000000">),</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">                cwd</span><span style="color: #000000">=</span><span style="color: #000000">start_dir</span><span style="color: #000000">,</span><span style="color: #000000"> relative_trick</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
ターゲットに様々なファイルをインストール
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
1つのファイルをインストールし、名前を変更
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
シンボリックリンクの作成
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
コンフィギュレーションセットの上書き(<em>env</em> は3つのメソッドinstall_files、install_as、symlink_asでoptionalだ)
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
スクリプトからsrc/bar/foo/a1.hとして見えるファイルを <em>${PREFIX}/share/foo/a1.h</em> にインストール
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
再帰的にpngファイルのインストールし、src/bar/のフォルダ構造を保つ
</td></tr>
</table></div>
<div class="paragraph"><p>備考: メソッド <em>install_files</em> 、 <em>install_as</em> 、 <em>symlink_as</em> は <em>waf install</em> か <em>waf uninstall</em> の間でのみ何かをなし、これらは他のbuildコマンドには影響を与えない</p></div>
</div>
<div class="sect3">
<h4 id="_タスクジェネレータの列挙と特定のタスクジェネレータの強制的実行">5.2.3. タスクジェネレータの列挙と特定のタスクジェネレータの強制的実行</h4>
<div class="paragraph"><p><em>list</em> コマンドは宣言されたタスクジェネレータを表示するのに使われる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">target</span><span style="color: #000000">=</span><span style="color: #009900">'bar.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'bar'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>デフォルトでは、タスクジェネレータの名前は <em>target</em> アトリビュートから決まる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure list</span></span>
<span style="color: #000000">'configure' finished successfully (0.005s)</span>
<span style="color: #000000">foo.txt</span>
<span style="color: #000000">bar</span>
<span style="color: #000000">'list' finished successfully (0.008s)</span></tt></pre></div></div>
<div class="paragraph"><p>名前の値の主な用途は <em>--targets</em> オプションによって強制的に部分的なビルドを行うことだ。
次を比較：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf clean build</span></span>
<span style="color: #000000">'clean' finished successfully (0.003s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_list/build'</span>
<span style="color: #000000">[1/2] foo.txt: wscript -&gt; build/foo.txt</span>
<span style="color: #000000">[2/2] bar:  -&gt; build/bar.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/build_list/build'</span>
<span style="color: #000000">'build' finished successfully (0.028s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf clean build --targets=foo.txt</span></span>
<span style="color: #000000">'clean' finished successfully (0.003s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_list/build'</span>
<span style="color: #000000">[1/1] foo.txt: wscript -&gt; build/foo.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/build_list/build'</span>
<span style="color: #000000">'build' finished successfully (0.022s)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_デバッグのためのステップバイステップの実行_em_step_em_コマンド">5.2.4. デバッグのためのステップバイステップの実行 ( <em>step</em> コマンド)</h4>
<div class="paragraph"><p><em>step</em> は特定のタスクの実行に使われ、終了コードとエラーメッセージを返す。
これは特にデバッグに有用だ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">waf step --files=test_shlib.c,test_staticlib.c</span>
<span style="color: #000000">Waf: Entering directory `/tmp/demos/c/build'</span>
<span style="color: #000000">c: shlib/test_shlib.c -&gt; build/shlib/test_shlib.c.1.o</span>
<span style="color: #000000"> -&gt; 0</span>
<span style="color: #000000">cshlib: build/shlib/test_shlib.c.1.o -&gt; build/shlib/libmy_shared_lib.so</span>
<span style="color: #000000"> -&gt; 0</span>
<span style="color: #000000">c: stlib/test_staticlib.c -&gt; build/stlib/test_staticlib.c.1.o</span>
<span style="color: #000000"> -&gt; 0</span>
<span style="color: #000000">cstlib: build/stlib/test_staticlib.c.1.o -&gt; build/stlib/libmy_static_lib.a</span>
<span style="color: #000000"> -&gt; 0</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/demos/c/build'</span>
<span style="color: #000000">'step' finished successfully (0.201s)</span></tt></pre></div></div>
<div class="paragraph"><p>この場合 <tt>.so</tt> ファイルもリビルドされる。
コマンドライン引数filesはカンマ区切りの正規表現のリストとして解釈されるため、次は異なる出力を生成する：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf step --files=test_shlib.c$</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/demos/c/build'</span>
<span style="color: #000000">c: shlib/test_shlib.c -&gt; build/shlib/test_shlib.c.1.o</span>
<span style="color: #000000"> -&gt; 0</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/demos/c/build'</span>
<span style="color: #000000">'step' finished successfully (0.083s)</span></tt></pre></div></div>
<div class="paragraph"><p>最後に、実行されるタスクはソースかターゲットかを特定するために、<em>in:</em> または <em>out:</em> を前につけることができる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf step --files=out:build/shlib/test_shlib.c.1.o</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/demos/c/build'</span>
<span style="color: #000000">cc: shlib/test_shlib.c -&gt; build/shlib/test_shlib.c.1.o</span>
<span style="color: #000000"> -&gt; 0</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/demos/c/build'</span>
<span style="color: #000000">'step' finished successfully (0.091s)</span></tt></pre></div></div>
<div class="paragraph"><p>備考: <em>waf step</em> を使うと、たとえいくつかのタスクが0以外のリターンコードを返しても、すべてのタスクはシーケンシャルに実行される</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ノードオブジェクト">6. ノードオブジェクト</h2>
<div class="sectionbody">
<div class="paragraph"><p>ノードオブジェクトはファイルやフォルダを表し、ファイルシステムの操作を簡単にする。
この章では使用方法の概観を示す。</p></div>
<div class="sect2">
<h3 id="_ノードクラスのデザイン">6.1. ノードクラスのデザイン</h3>
<div class="sect3">
<h4 id="_ノードツリー">6.1.1. ノードツリー</h4>
<div class="paragraph"><p>Wafのノードは <em>waflib.Node.Node</em> クラスを継承しファイルシステムを表現するツリー構造を提供する：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<strong>parent</strong>: 親ノード
</p>
</li>
<li>
<p>
<strong>children</strong>: フォルダの中身 - ノードがファイルならば空
</p>
</li>
</ol></div>
<div class="paragraph"><p>実際には、ファイルシステムツリーへのリファレンスは、Wafコマンドからのアクセスのためにコンテキストクラスにバインドされている。
ここで例示する：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">dosomething</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">"ctx.path contents %r"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">children</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">"ctx.path parent   %r"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">"ctx.root parent   %r"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
<strong>ctx.path</strong> は実行される <tt>wscript</tt> ファイルへのパスを表す
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
<strong>ctx.root</strong> はファイルシステムもしくはドライブレターを含むフォルダ(win32システム)のルート
</td></tr>
</table></div>
<div class="paragraph"><p>実行結果の出力は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure dosomething</span></span>
<span style="color: #000000">Setting top to    : /tmp/node_tree</span>
<span style="color: #000000">Setting out to    : /tmp/node_tree/build</span>
<span style="color: #000000">'configure' finished successfully (0.007s)</span>
<span style="color: #000000">/tmp/node_tree <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">/</span>
<span style="color: #000000">ctx.path contents {'wscript': /tmp/node_tree/wscript} <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">ctx.path parent   '/tmp' <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">ctx.root parent   None <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">'dosomething' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
しばしば絶対パスが使われる
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
フォルダの中身は名前をノードオブジェクトに結びつけるdict <em>children</em> に保存される
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
それぞれのノードはその <em>parent</em> ノードへの参照を保持する
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
ルートノードは <em>parent</em> をもたない
</td></tr>
</table></div>
<div class="paragraph"><p>備考: ノードとファイルシステムの要素には厳格な対応関係がある： 1つのノードは正確に1つのファイルか1つのフォルダを表し、1つのノードのみがあるファイルやフォルダを表現できる</p></div>
</div>
<div class="sect3">
<h4 id="_ノードキャッシング">6.1.2. ノードキャッシング</h4>
<div class="paragraph"><p>デフォルトでは必要なノードのみが作られる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">dosomething</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">children</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>ファイルシステムのルートはひとつのノードのみをもつが、現実のファイルシステムのルートは <tt>/tmp</tt> だけではなくそれ以外のフォルダを含む:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure dosomething</span></span>
<span style="color: #000000">Setting top to   : /tmp/nodes_cache</span>
<span style="color: #000000">Setting out to   : /tmp/nodes_cache/build</span>
<span style="color: #000000">'configure' finished successfully (0.086s)</span>
<span style="color: #000000">{'tmp': /tmp}</span>
<span style="color: #000000">'dosomething' finished successfully (0.001s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ ls /</span></span>
<span style="color: #000000">bin boot dev etc home tmp usr var</span></tt></pre></div></div>
<div class="paragraph"><p>これは特にいくつかのノードは使われる前にファイルシステムから読み込まれるか作成されなくてはならないことを意味する。</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_一般的な用途">6.2. 一般的な用途</h3>
<div class="sect3">
<h4 id="_ノードの探索と作成">6.2.1. ノードの探索と作成</h4>
<div class="paragraph"><p>ノードは手動もしくはファイルシステムから読み込まれることで作られる。
この目的のために3つのメソッドが用意されている：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">dosomething</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_node</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">        nd1 </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">nd1</span><span style="color: #000000">)</span>

<span style="color: #000000">        nd2 </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">search</span><span style="color: #000000">(</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">nd2</span><span style="color: #000000">)</span>

<span style="color: #000000">        nd3 </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">search</span><span style="color: #000000">(</span><span style="color: #009900">'bar.txt'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">nd3</span><span style="color: #000000">)</span>

<span style="color: #000000">        nd2</span><span style="color: #000000">.</span><span style="color: #000000">write</span><span style="color: #000000">(</span><span style="color: #009900">'some text'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">nd2</span><span style="color: #000000">.</span><span style="color: #000000">read</span><span style="color: #000000">())</span>

<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">listdir</span><span style="color: #000000">())</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
ファイルシステムを読み込むことでノードを探索
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ノードを探索し、存在しなければ作成する
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
ノードを探索するが、作成はしない
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
存在しないファイルの探索
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
ノードで指し示されるファイルへ書き出し、作成もしくは上書きする
</td></tr>
</table></div>
<div class="paragraph"><p>出力結果は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure dosomething</span></span>
<span style="color: #000000">'distclean' finished successfully (0.005s)</span>
<span style="color: #000000">Setting top to    : /tmp/nodes_search</span>
<span style="color: #000000">Setting out to    : /tmp/nodes_search/build</span>
<span style="color: #000000">'configure' finished successfully (0.006s)</span>
<span style="color: #000000">wscript</span>
<span style="color: #000000">foo.txt</span>
<span style="color: #000000">foo.txt</span>
<span style="color: #000000">None</span>
<span style="color: #000000">some text</span>
<span style="color: #000000">['.lock-wafbuild', 'foo.txt', 'build', 'wscript', '.git']</span></tt></pre></div></div>
<div class="paragraph"><p>備考: <a href="http://docs.waf.googlecode.com/git/apidocs_16/index.html">APIドキュメンテーション</a> でさらに多くのメソッドを見つけることができる</p></div>
<div class="paragraph"><p>警告: これらのメソッドは並行アクセスに対して安全ではない。ノードクラスメソッドはスレッドセーフではない。</p></div>
</div>
<div class="sect3">
<h4 id="_ファイルとフォルダの列挙">6.2.2. ファイルとフォルダの列挙</h4>
<div class="paragraph"><p>メソッド <strong>ant_glob</strong> はファイルや再帰的なフォルダの列挙に使われる；</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">dosomething</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'wsc*'</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'w?cr?p?'</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'usr/include/**/zlib*'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span><span style="color: #000000"> dir</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">,</span><span style="color: #000000"> src</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">([</span><span style="color: #009900">'**/*py'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'**/*p'</span><span style="color: #000000">],</span><span style="color: #000000"> excl</span><span style="color: #000000">=[</span><span style="color: #009900">'**/default*'</span><span style="color: #000000">]))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
メソッド ant_glob はビルドコンテキストではなく、ノードオブジェクトに対して呼ばれ、デフォルトではファイルのみを返す
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
<em>*</em> や <em>?</em> のようなワイルドカードを含むパターンだが、<a href="http://ant.apache.org/manual/dirtasks.html">Antパターン</a>で、正規表現ではない
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
シンボル <em>**</em> は再帰を有効にする。複雑なフォルダ階層には多くの時間がかかるため、使用には注意が必要だ
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
再帰が有効になったとしても、デフォルトではファイルのみが返る。フォルダを返すためには、'dir=True'を使う
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
パターンは文字列のリストかスペース区切の値だ。除外するパターンは <em>waflib.Node.exclude_regs</em> で定義される。
</td></tr>
</table></div>
<div class="paragraph"><p>実行結果の出力は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure dosomething</span></span>
<span style="color: #000000">Setting top to    : /tmp/nodes_ant_glob</span>
<span style="color: #000000">Setting out to    : /tmp/nodes_ant_glob/build</span>
<span style="color: #000000">'configure' finished successfully (0.006s)</span>
<span style="color: #000000">[/tmp/nodes_ant_glob/wscript]</span>
<span style="color: #000000">[/tmp/nodes_ant_glob/wscript]</span>
<span style="color: #000000">[/usr/include/zlib.h]</span>
<span style="color: #000000">[/tmp/nodes_ant_glob/build/c4che/build.config.py]</span></tt></pre></div></div>
<div class="paragraph"><p><em>..</em> は正確に2つのドット文字を表し、親ディレクトリではない。
これは探索が終了することを保証し、同じファイルが何度も列挙されることはない。
次を考慮：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'../wscript'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">ant_glob</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
無効、このパターンは何も返さない
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
親ディレクトリから <em>ant_glob</em> の呼出し
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_パスの操作_abspath_path_from">6.2.3. パスの操作: abspath, path_from</h4>
<div class="paragraph"><p>メソッド <em>abspath</em> はノードの絶対パスを取得するために使われる。
次の例では3つのノードが使われる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        dir </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        src </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">)</span>
<span style="color: #000000">        bld </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #009900">'out.out'</span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">src</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">))</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">dir</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">dir</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
ディレクトリノード、ソースノード、そしてビルドノード
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
パラメータにコンフィギュレーションセットをとり、ソースノードやビルドノードの絶対パスを計算
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
ディレクトリの絶対パスの計算にはコンフィギュレーションセットを使うこともできる
</td></tr>
</table></div>
<div class="paragraph"><p>これは実行のトレースだ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">'configure' finished successfully (0.005s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/nested/build'</span>
<span style="color: #000000">/tmp/nested/wscript <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">/tmp/nested/build/out.out <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">/tmp/nested/build/ <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">/tmp/nested <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/nested/build'</span>
<span style="color: #000000">'build' finished successfully (0.003s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
ソースノードへの絶対パス
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ビルドノードの絶対パスは使用中のvariantに依存する
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
コンフィギュレーションセットが与えられた場合、ディレクトリノードへの絶対パスはvariantを含むビルドディレクトリ表現だ
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
コンフィギュレーションセットが与えられない場合、ディレクトリノードへの絶対パスはソースディレクトリへの絶対パスとなる
</td></tr>
</table></div>
<div class="paragraph"><p>備考: <em>relpath_gen</em> や <em>srcpath</em> などの他のいくつかのメソッドが提供されている。 <a href="http://docs.waf.googlecode.com/git/apidocs_16/index.html">APIドキュメント</a>を参照。</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_buildcontext特有のメソッド">6.3. BuildContext特有のメソッド</h3>
<div class="sect3">
<h4 id="_ソースとビルドノード">6.3.1. ソースとビルドノード</h4>
<div class="paragraph"><p><tt>wscript</tt> ファイルの中で <em>sources</em> と <em>targets</em> はカレントディレクトリに存在するかのように宣言されるが 、ターゲットファイルはビルドディレクトリに出力される。
この振舞いを有効にするには、<em>top</em> ディレクトリ以下の構造が <em>out</em> ディレクトリ以下に複製されなくてはならない。
例えば、 <tt>demos/c</tt> の <strong>program</strong> フォルダは同等な構造をビルドディレクトリにもつ:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd demos/c</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- build</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   |-- config.h</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- program</span>
<span style="color: #000000">|       |-- main.c.0.o</span>
<span style="color: #000000">|       `-- myprogram</span>
<span style="color: #000000">|-- program</span>
<span style="color: #000000">|   |-- a.h</span>
<span style="color: #000000">|   |-- main.c</span>
<span style="color: #000000">|   `-- wscript_build</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="paragraph"><p>これをサポートするために、ビルドコンテキストは2つのノードを提供する：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
srcnode: 最上位ディレクトリを表すノード
</p>
</li>
<li>
<p>
bldnode: ビルドディレクトリを表すノード
</p>
</li>
</ol></div>
<div class="paragraph"><p>ソースノードからビルドノードを得る、およびその逆を行うには、次のメソッドが使える：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Node.get_src()
</p>
</li>
<li>
<p>
Node.get_bld()
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_ビルドフェーズ中のノードの使用">6.3.2. ビルドフェーズ中のノードの使用</h4>
<div class="paragraph"><p><em>srcnode</em> と <em>bldnode</em> を直接使うこともできるが、次の3つのラッパーメソッドがより使い易い。
これらはターゲットを表す文字列を入力として受け付け、単一のノードを返す：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<strong>find_dir</strong>: ノードを返す。フォルダがシステムに存在しない場合はNoneを返す。
</p>
</li>
<li>
<p>
<strong>find_resource</strong>: ソースディレクトリ次のノード、ビルドディレクトリ次のノード、もしくはそのようなノードが存在しない場合はNoneを返す。もしファイルがビルドディレクトリにない場合、ノードのシグネチャは計算されてキャッシュにいれられる(ファイルの中身のハッシュ).
</p>
</li>
<li>
<p>
<strong>find_or_declare</strong>: ノードを返すかビルドディレクトリに対応するノードを作る。
</p>
</li>
</ol></div>
<div class="paragraph"><p>そのうえ、それらはすべて、ビルドディレクトリに必要なディレクトリ構造を作る <em>find_dir</em> を内部的に使う。
なぜならば、ビルドが開始される前にビルドディレクトリでフォルダが複製され得るため、可能な場所ではすべてそれを使うことが推奨される：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    p </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">find_dir</span><span style="color: #000000">(</span><span style="color: #009900">'src'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">    p </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_dir</span><span style="color: #000000">(</span><span style="color: #009900">'../src'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
非推奨、 <em>find_dir</em> を代わりに使うべき
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
パスのセパレータはプラットフォームに応じて自動的に変換される
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_ノード_タスク_タスクジェネレータ">6.3.3. ノード、タスク、タスクジェネレータ</h4>
<div class="paragraph"><p>前の章で見たように、タスクオブジェクトは入力および出力ノードのリストとして表現されるファイルの処理を行う。
タスクジェネレータは通常、文字列で与えられた入力ファイルを処理し、ノードを生成してタスクにバインドする。</p></div>
<div class="paragraph"><p>ビルドディレクトリは有効、無効にできるため、次のファイルは不正である: <span class="footnote"><br />[ファイルのコピーを避けられない場合、ベストプラクティスはファイル名を変更することだ]<br /></span></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>実際に対応するビルドディレクトリに同じ名前でファイルをコピーするには、曖昧さをなくさなくてはならない：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">        rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        source </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">),</span>
<span style="color: #000000">        target </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">get_bld</span><span style="color: #000000">().</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #000000">)</span></tt></pre></div></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_一歩進んだビルド定義">7. 一歩進んだビルド定義</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_コマンドのカスタマイズ">7.1. コマンドのカスタマイズ</h3>
<div class="sect3">
<h4 id="_コンテキストの継承">7.1.1. コンテキストの継承</h4>
<div class="paragraph"><p><em>waflib.Context.Context</em> のインスタンスはカスタムコマンドにデフォルトで用いられる。
カスタムコンテキストのオブジェクトを提供するには、コンテキストのサブクラスを作る必要がある。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">type</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">))</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">foo</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">type</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">))</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">bar</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">type</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">))</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Context </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Context</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">one</span><span style="color: #000000">(</span><span style="color: #000000">Context</span><span style="color: #000000">):</span>
<span style="color: #000000">        cmd </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">two</span><span style="color: #000000">(</span><span style="color: #000000">Context</span><span style="color: #000000">):</span>
<span style="color: #000000">        cmd </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'tak'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        fun </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'bar'</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
デフォルトのコンンテキストを使ったコマンド
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
<em>foo</em> コマンドのためにコンテキストクラスを構築
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
<em>tak</em> という名前の新しいコマンドを宣言するが、スクリプト内の <em>bar</em> 関数を呼び出す
</td></tr>
</table></div>
<div class="paragraph"><p>実行結果の出力は次のようになるだろう。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure foo bar tak</span></span>
<span style="color: #000000">Setting top to    : /tmp/advbuild_subclass</span>
<span style="color: #000000">Setting out to    : /tmp/advbuild_subclass/build</span>
<span style="color: #000000">&lt;class 'waflib.Configure.ConfigurationContext'&gt;</span>
<span style="color: #000000">'configure' finished successfully (0.008s)</span>
<span style="color: #000000">&lt;class 'wscript.one'&gt;</span>
<span style="color: #000000">'foo' finished successfully (0.001s)</span>
<span style="color: #000000">&lt;class 'waflib.Context.Context'&gt;</span>
<span style="color: #000000">'bar' finished successfully (0.001s)</span>
<span style="color: #000000">&lt;class 'wscript.two'&gt;</span>
<span style="color: #000000">'tak' finished successfully (0.001s)</span></tt></pre></div></div>
<div class="paragraph"><p>カスタムコンテキストの典型的な応用例は <strong>ctx.env</strong> に読み込まれたコンフィギュレーションデータを使うためにビルドコンテキストのサブクラスを作ることだ。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FOO </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'some data'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'build command'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">foo</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FOO</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Build </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> BuildContext</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">one</span><span style="color: #000000">(</span><span style="color: #000000">BuildContext</span><span style="color: #000000">):</span>
<span style="color: #000000">        cmd </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo'</span>
<span style="color: #000000">        fun </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo'</span></tt></pre></div></div>
<div class="paragraph"><p>出力は次のようになる</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure foo</span></span>
<span style="color: #000000">Setting top to    : /tmp/advbuild_confdata</span>
<span style="color: #000000">Setting out to    : /tmp/advbuild_confdata/build</span>
<span style="color: #000000">'configure' finished successfully (0.006s)</span>
<span style="color: #000000">Waf: Entering directory `/disk/comp/waf/docs/book/examples/advbuild_confdata/build'</span>
<span style="color: #000000">some data</span>
<span style="color: #000000">Waf: Leaving directory `/disk/comp/waf/docs/book/examples/advbuild_confdata/build'</span>
<span style="color: #000000">'foo' finished successfully (0.004s)</span></tt></pre></div></div>
<div class="paragraph"><p>備考: buildコマンドはこのシステムを使っている： <em>waf install</em> → <em>waflib.Build.InstallContext</em>, <em>waf step</em> → <em>waflib.Build.StepContext</em>, など</p></div>
</div>
<div class="sect3">
<h4 id="_コマンドの合成">7.1.2. コマンドの合成</h4>
<div class="paragraph"><p>既存のコマンドと互換性のないコンテキストクラスを再利用するには、それらの互換性のないクラスを <em>コマンドスタック</em> に挿入する。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">cleanbuild</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Options</span>
<span style="color: #000000">        Options</span><span style="color: #000000">.</span><span style="color: #000000">commands </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'clean'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> Options</span><span style="color: #000000">.</span><span style="color: #000000">commands</span></tt></pre></div></div>
<div class="paragraph"><p>このテクニックはテストケースを書くときに便利だ。
<em>waf test</em> を実行することで、次のスクリプトはプロジェクトのconfigureを行い、ソースファイルをsourceディレクトリに作り、プログラムをビルドし、ソースを変更し、プログラムを再ビルドする。
このケースでは、ヘッダが変更されたため（暗黙的な依存性）、プログラムは再ビルドされる。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">setup</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        n </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #009900">'main.c'</span><span style="color: #000000">)</span>
<span style="color: #000000">        n</span><span style="color: #000000">.</span><span style="color: #000000">write</span><span style="color: #000000">(</span><span style="color: #009900">'#include "foo.h"\nint main() {return 0;}\n'</span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000080">global</span><span style="color: #000000"> v</span>
<span style="color: #000000">        m </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #009900">'foo.h'</span><span style="color: #000000">)</span>
<span style="color: #000000">        m</span><span style="color: #000000">.</span><span style="color: #000000">write</span><span style="color: #000000">(</span><span style="color: #009900">'int k = %d;\n'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> v</span><span style="color: #000000">)</span>
<span style="color: #000000">        v </span><span style="color: #000000">+=</span><span style="color: #000000"> </span><span style="color: #000000">1</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'app'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">test</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">global</span><span style="color: #000000"> v </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        v </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">12</span>

<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Options </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        lst </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'configure'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'setup'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'setup'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span><span style="color: #000000">]</span>
<span style="color: #000000">        Options</span><span style="color: #000000">.</span><span style="color: #000000">commands </span><span style="color: #000000">=</span><span style="color: #000000"> lst </span><span style="color: #000000">+</span><span style="color: #000000"> Options</span><span style="color: #000000">.</span><span style="color: #000000">commands</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
異なるコマンド間でデータを共有するためにグローバル変数を使う
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
testコマンドはコマンドを追加するために使われる
</td></tr>
</table></div>
<div class="paragraph"><p>次のような出力が見られるだろう。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf test</span></span>
<span style="color: #000000">'test' finished successfully (0.000s)</span>
<span style="color: #000000">Setting top to                           : /tmp/advbuild_testcase</span>
<span style="color: #000000">Setting out to                           : /tmp/advbuild_testcase/build</span>
<span style="color: #000000">Checking for 'gcc' (c compiler)          : ok</span>
<span style="color: #000000">'configure' finished successfully (0.092s)</span>
<span style="color: #000000">'setup' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/advbuild_testcase/build'</span>
<span style="color: #000000">[1/2] c: main.c -&gt; build/main.c.0.o</span>
<span style="color: #000000">[2/2] cprogram: build/main.c.0.o -&gt; build/app</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/advbuild_testcase/build'</span>
<span style="color: #000000">'build' finished successfully (0.137s)</span>
<span style="color: #000000">'setup' finished successfully (0.002s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/advbuild_testcase/build'</span>
<span style="color: #000000">[1/2] c: main.c -&gt; build/main.c.0.o</span>
<span style="color: #000000">[2/2] cprogram: build/main.c.0.o -&gt; build/app</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/advbuild_testcase/build'</span>
<span style="color: #000000">'build' finished successfully (0.125s)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_wafツールからのコマンドのバインディング">7.1.3. Wafツールからのコマンドのバインディング</h4>
<div class="paragraph"><p>トップレベルのwscriptが読み込まれると、Pythonのモジュールに変換され、メモリ上に保持される。
コマンドは関数をモジュールに加えることで、動的に追加される。
プロジェクト中のタスクジェネレータの数を数えるWafツールを披露しよう。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'some_tool'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span></tt></pre></div></div>
<div class="paragraph"><p>Wafはconfigureとビルドのために一度読み込まれる。
たとえ実際にはoptionsを提供しない場合でも、ツールが常に有効であることを確かなものにするために、optionsを読み込まなくてはならない。
<em>wscript</em> ファイルと同階層にある、我々のツール <em>some_tool.py</em> は次のコードを含む。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Context</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">cnt</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #808080">        """do something"""</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'just a test'</span><span style="color: #000000">)</span>

<span style="color: #000000">Context</span><span style="color: #000000">.</span><span style="color: #000000">g_module</span><span style="color: #000000">.</span><span style="color: #000000">__dict__</span><span style="color: #000000">[</span><span style="color: #009900">'cnt'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> cnt</span></tt></pre></div></div>
<div class="paragraph"><p>実行結果は次のようになる。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure cnt</span></span>
<span style="color: #000000">Setting top to   : /tmp/examples/advbuild_cmdtool</span>
<span style="color: #000000">Setting out to   : /tmp/advbuild_cmdtool/build</span>
<span style="color: #000000">'configure' finished successfully (0.006s)</span>
<span style="color: #000000">just a test</span>
<span style="color: #000000">'cnt' finished successfully (0.001s)</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_ビルド出力のカスタマイズ">7.2. ビルド出力のカスタマイズ</h3>
<div class="sect3">
<h4 id="_複数のconfigure_2">7.2.1. 複数のconfigure</h4>
<div class="paragraph"><p>環境変数 <em>WAFLOCK</em> はconfigureのロックやデフォルトのビルドディレクトリを指定するのに使われる。
次のプロジェクトを見てみよう。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo.txt'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>実行すると <em>WAFLOCK</em> は変更される。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ export WAFLOCK=.lock-wafdebug <img src="./callouts/1.png" alt="1" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/advbuild_waflock/debug'</span>
<span style="color: #000000">[1/1] foo.txt:  -&gt; debug//foo.txt <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/advbuild_waflock/debug'</span>
<span style="color: #000000">'build' finished successfully (0.012s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ export WAFLOCK=.lock-wafrelease</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.176s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/advbuild_waflock/release' <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">[1/1] foo.txt:  -&gt; release/foo.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/advbuild_waflock/release'</span>
<span style="color: #000000">'build' finished successfully (0.034s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree -a</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- .lock-debug <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">|-- .lock-release</span>
<span style="color: #000000">|-- debug</span>
<span style="color: #000000">|   |-- .wafpickle-7</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- foo.txt</span>
<span style="color: #000000">|-- release</span>
<span style="color: #000000">|   |-- .wafpickle-7</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- foo.txt</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
ロックファイルはプロジェクトのコンフィギュレーションと使われるビルドディレクトリを指す
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
これらのファイルはビルドディレクトリ <tt>debug</tt> の出力結果
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
<em>release</em> コンフィギュレーションでは異なるロックファイルとビルドディレクトリが使われる
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
プロジェクトディレクトリの中には2つのロックファイルと2つのビルドフォルダが含まれる
</td></tr>
</table></div>
<div class="paragraph"><p>ロックファイルはWafファイルの中の変数が変わることにより変更され得る。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Options</span>
<span style="color: #000000">Options</span><span style="color: #000000">.</span><span style="color: #000000">lockfile </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.lock-wafname'</span></tt></pre></div></div>
<div class="paragraph"><p>備考: Wafロックファイルにより参照される出力ディレクトはWafスクリプトで付えられないときのみ、有効になる</p></div>
</div>
<div class="sect3">
<h4 id="_出力ディレクトリの変更">7.2.2. 出力ディレクトリの変更</h4>
<div class="sect4">
<h5 id="_variant_ビルド">Variant ビルド</h5>
<div class="paragraph"><p>前のセクションでは2つの異なるコンフィギュレーションは同じようなビルドに使われていた。
ここでは同一のコンフィギュレーションを継承する、異なる出力ターゲットのフォルダをもつ2つのビルドの作り方を示す。
まずはプロジェクトファイルから始めよう。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">cmd </span><span style="color: #000000">+</span><span style="color: #000000"> </span><span style="color: #009900">'.txt'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Build </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> BuildContext</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">debug</span><span style="color: #000000">(</span><span style="color: #000000">BuildContext</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        cmd </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'debug'</span>
<span style="color: #000000">        variant </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'debug'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
呼びだされるコマンドは <em>self.cmd</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ビルドコンテキストを継承した <em>debug</em> コマンドの作成
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
<em>debug</em> コマンドのターゲットの用フォルダの宣言
</td></tr>
</table></div>
<div class="paragraph"><p>このプロジェクトは2つのことなるビルド <em>build</em> と <em>debug</em> を宣言する。
主力結果を検証しよう。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">waf configure build debug</span>
<span style="color: #000000">Setting top to   : /tmp/advbuild_variant</span>
<span style="color: #000000">Setting out to   : /tmp/advbuild_variant/build</span>
<span style="color: #000000">'configure' finished successfully (0.007s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/advbuild_variant/build'</span>
<span style="color: #000000">[1/1] build.txt:  -&gt; build/build.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/advbuild_variant/build'</span>
<span style="color: #000000">'build' finished successfully (0.020s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/build_variant/build/debug'</span>
<span style="color: #000000">[1/1] debug.txt:  -&gt; build/debug/debug.txt <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/advbuild_variant/build/debug'</span>
<span style="color: #000000">'debug' finished successfully (0.021s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- build</span>
<span style="color: #000000">|   |-- build.txt <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- debug</span>
<span style="color: #000000">|       `-- debug.txt <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
コマンドは <em>build/variant</em> から実行される
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
デフォルトコマンド <em>build</em> はvariantを持たない
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
<em>debug</em> ターゲットはbuildディレクトリの中のvariant
</td></tr>
</table></div>
</div>
<div class="sect4">
<h5 id="_variantに対するコンフィギュレーション">variantに対するコンフィギュレーション</h5>
<div class="paragraph"><p>variantはconfigureの段階で作られた異なるコンフィギュレーションセットを必要とする。
ここに例を示す。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">setenv</span><span style="color: #000000">(</span><span style="color: #009900">'debug'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CFLAGS </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">setenv</span><span style="color: #000000">(</span><span style="color: #009900">'release'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CFLAGS </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O2'</span><span style="color: #000000">]</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000080">not</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">variant</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                bld</span><span style="color: #000000">.</span><span style="color: #000000">fatal</span><span style="color: #000000">(</span><span style="color: #009900">'call "waf build_debug" or "waf build_release", and try "waf --help"'</span><span style="color: #000000">)</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'app'</span><span style="color: #000000">,</span><span style="color: #000000"> includes</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Build </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> BuildContext</span><span style="color: #000000">,</span><span style="color: #000000"> CleanContext</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">\</span>
<span style="color: #000000">        InstallContext</span><span style="color: #000000">,</span><span style="color: #000000"> UninstallContext</span>

<span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #009900">'debug release'</span><span style="color: #000000">.</span><span style="color: #000000">split</span><span style="color: #000000">():</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> y </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">(</span><span style="color: #000000">BuildContext</span><span style="color: #000000">,</span><span style="color: #000000"> CleanContext</span><span style="color: #000000">,</span><span style="color: #000000"> InstallContext</span><span style="color: #000000">,</span><span style="color: #000000"> UninstallContext</span><span style="color: #000000">):</span>
<span style="color: #000000">                name </span><span style="color: #000000">=</span><span style="color: #000000"> y</span><span style="color: #000000">.</span><span style="color: #000000">__name__</span><span style="color: #000000">.</span><span style="color: #000000">replace</span><span style="color: #000000">(</span><span style="color: #009900">'Context'</span><span style="color: #000000">,</span><span style="color: #009900">''</span><span style="color: #000000">).</span><span style="color: #000000">lower</span><span style="color: #000000">()</span>
<span style="color: #000000">                </span><span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">tmp</span><span style="color: #000000">(</span><span style="color: #000000">y</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                        cmd </span><span style="color: #000000">=</span><span style="color: #000000"> name </span><span style="color: #000000">+</span><span style="color: #000000"> </span><span style="color: #009900">'_'</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> x</span>
<span style="color: #000000">                        variant </span><span style="color: #000000">=</span><span style="color: #000000"> x</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
<em>conf.env</em> から返され <em>c4che/debug_cache.py</em> に保存される新たなコンフィギュレーションセットを作成
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
コンフィギュレーションセットのいくつかのデータの変更
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
variantがsetであることを確認することで, 通常の <em>build</em> や <em>clean</em> 、<em>install</em> コマンドを無効にする
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
<em>bld.env</em> は適切なvariantのコンフィギュレーションsetを読み込む(<em>debug</em> の中の場合 <em>debug_cache.py</em>)
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
<em>clean_debug</em> や <em>install_debug</em> などの新たなコマンドの作成(クラス名は何でもよい)
</td></tr>
</table></div>
<div class="paragraph"><p>実行結果の出力は次のようなものになるだろう。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf clean_debug build_debug clean_release build_release</span></span>
<span style="color: #000000">'clean_debug' finished successfully (0.005s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/examples/advbuild_variant_env/build/debug'</span>
<span style="color: #000000">[1/2] c: main.c -&gt; build/debug/main.c.0.o</span>
<span style="color: #000000">[2/2] cprogram: build/debug/main.c.0.o -&gt; build/debug/app</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/examples/advbuild_variant_env/build/debug'</span>
<span style="color: #000000">'build_debug' finished successfully (0.051s)</span>
<span style="color: #000000">'clean_release' finished successfully (0.003s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/examples/advbuild_variant_env/build/release'</span>
<span style="color: #000000">[1/2] c: main.c -&gt; build/release/main.c.0.o</span>
<span style="color: #000000">[2/2] cprogram: build/release/main.c.0.o -&gt; build/release/app</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/examples/advbuild_variant_env/build/release'</span>
<span style="color: #000000">'build_release' finished successfully (0.052s)</span></tt></pre></div></div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_タスク処理">8. タスク処理</h2>
<div class="sectionbody">
<div class="paragraph"><p>この章ではビルドフェーズで使われるタスククラスについて記述する。</p></div>
<div class="sect2">
<h3 id="_タスクの実行">8.1. タスクの実行</h3>
<div class="sect3">
<h4 id="_主要なアクター">8.1.1. 主要なアクター</h4>
<div class="paragraph"><p>ビルドコンテキストはタスクと、並行に実行することができるタスクのリストを返すためにのみ使われる。
スケジューリングはタスク消費者に実行させるタスク生産者に移譲される。
タスク生産者は処理されたタスクやエラーの数などのビルド状態を記録する。</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="tasks_actors.png" alt="タスクを処理するアクター" />
</div>
</div>
<div class="paragraph"><p>消費者の数はプロセッサの数、もしくは <em>-j</em> オプションにより手動で決定される。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf -j3</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_ビルドグループ">8.1.2. ビルドグループ</h4>
<div class="paragraph"><p>タスク生産者はビルドコンテキストによって返されたタスクのリストをイテレートする。
ひとつリスト中のタスクは消費者スレッドにより並列に実行されるが、あるリスト中のタスクは他のリスト中のタスクより前にすべて処理される。
処理すべきタスクがなくなるとビルドは終了する。</p></div>
<div class="paragraph"><p>これらのタスクのリストは <em>ビルドグループ</em> と呼ばれ、 ビルドスクリプトからアクセスできる。
例を通してこの振舞いを見ていこう:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">for</span><span style="color: #000000"> i </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">range</span><span style="color: #000000">(</span><span style="color: #000000">8</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_a_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'YELLOW'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks a'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_a_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_b_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'GREEN'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks b'</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #000080">for</span><span style="color: #000000"> i </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">range</span><span style="color: #000000">(</span><span style="color: #000000">8</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_c_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'BLUE'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks c'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_c_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_d_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'PINK'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks d'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>それぞれのグリーンのタスクは1つのイエローのタスクの後に実行されなくてはならない。
そしてそれぞれのピンクのタスクは1つのブルーのタスクの後に実行されなくてはならない。
デフォルトでは1つのグループしかないため、並列実行は次と似たものになるだろう：</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="tasks_nogroup.png" alt="1つのビルドグループ" />
</div>
</div>
<div class="paragraph"><p>ここでもうひとつビルドグループを追加するように例を変更しよう。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">for</span><span style="color: #000000"> i </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">range</span><span style="color: #000000">(</span><span style="color: #000000">8</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_a_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'YELLOW'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks a'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_a_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_b_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'GREEN'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks b'</span><span style="color: #000000">)</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_group</span><span style="color: #000000">()</span>
<span style="color: #000000">    </span><span style="color: #000080">for</span><span style="color: #000000"> i </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">range</span><span style="color: #000000">(</span><span style="color: #000000">8</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_c_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'BLUE'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks c'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_c_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_d_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'PINK'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks d'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>ここで、セパレータは黄色と緑色のタスクのグループと青色と紫色のタスクのグループとの間に表われる：</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="tasks_twogroups.png" alt="2つのビルドグループ" />
</div>
</div>
<div class="paragraph"><p>タスクとタスクジェネレータは暗黙的に現在のグループに追加される。
グループに名前を与えることで何が何処へ行くのかを簡単に制御できる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>

<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_group</span><span style="color: #000000">(</span><span style="color: #009900">'group1'</span><span style="color: #000000">)</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_group</span><span style="color: #000000">(</span><span style="color: #009900">'group2'</span><span style="color: #000000">)</span>

<span style="color: #000000">    </span><span style="color: #000080">for</span><span style="color: #000000"> i </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">range</span><span style="color: #000000">(</span><span style="color: #000000">8</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">set_group</span><span style="color: #000000">(</span><span style="color: #009900">'group1'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_a_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'YELLOW'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks a'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_a_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_b_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'GREEN'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks b'</span><span style="color: #000000">)</span>

<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">set_group</span><span style="color: #000000">(</span><span style="color: #009900">'group2'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_c_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'BLUE'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks c'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_c_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'wscript_d_%d'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> i</span><span style="color: #000000">,</span>
<span style="color: #000000">            color</span><span style="color: #000000">=</span><span style="color: #009900">'PINK'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'tasks d'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>前の例では、すべてのビルドグループからなる、すべてのタスクジェネレータはビルドが実際に開始する前に処理される。
このデフォルトの挙動は可能な限り正確にタスク数を数えるために提供されている。
ここではビルドグループをチューンする方法を示す：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Build </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> POST_LAZY</span><span style="color: #000000">,</span><span style="color: #000000"> POST_BOTH</span><span style="color: #000000">,</span><span style="color: #000000"> POST_AT_ONCE</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">post_mode </span><span style="color: #000000">=</span><span style="color: #000000"> POST_AT_ONCE </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #808080">#ctx.post_mode = POST_LAZY <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #808080">#ctx.post_mode = POST_BOTH <img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
すべてのタスクジェネレータはビルドが開始される前にタスクを生成する(デフォルトの挙動)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
グループは順番に処理される: 次のグループのタスクジェネレータが処理される前に前のグループのすべてのタスクは実行される
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
前の2つの挙動の組合せ: 次のグループのタスクによって生成されるタスクジェネレータはタスクを生成することができる
</td></tr>
</table></div>
<div class="paragraph"><p>ビルドグループは<a href="#build_compiler_first">ソースファイルの生成のためのコンパイラをビルド</a>するために使うことができる。</p></div>
</div>
<div class="sect3">
<h4 id="_生産者_消費者システム">8.1.3. 生産者-消費者システム</h4>
<div class="paragraph"><p>ほとんどのPythonインタープリタでは、グローバルインタープリタロックによって一度に1つ以上のCPUでの並列化が行われない。
そのため、1つのタスクプロデューサ上でタスクのスケジューリングを制限することは理にかなっており、スレッドにタスクの実行のみをアクセスさせる。</p></div>
<div class="paragraph"><p>生産者と消費者間のコミュニケーションは <em>ready</em> と <em>out</em> の2つのキューに基づいている。
生産者は <em>ready</em> にタスクを追加し、結果を <em>out</em> から読み込む。
消費者は <em>ready</em> からタスクを取得し、 <em>task.run</em> を実行後、結果を生産者に返すために <em>out</em> に返す。</p></div>
<div class="paragraph"><p>生産者はタスクをイテレートしてキュー <em>ready</em> にどのタスクを入れるかを決めるために <em>outstanding</em> と名付けられたリストを内部で使う。
処理することのできないタスクは、タスクが他のタスクを待つエンドレスループを避けるためにリスト <em>frozen</em> に一時的に出力される。</p></div>
<div class="paragraph"><p>次の図ではビルド中にタスク生産者と消費者が演じる関係について示す。</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="prodcons.png" alt="並列実行" />
</div>
</div>
</div>
<div class="sect3">
<h4 id="_タスクの状態とステータス">8.1.4. タスクの状態とステータス</h4>
<div class="paragraph"><p>実行を追跡するために、それぞれのタスクに状態が割当てられている(<em>task.hasrun = state</em>)。
可能な値は次のようになる：</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="12%" />
<col width="12%" />
<col width="75%" />
<thead>
<tr>
<th align="left" valign="top">状態    </th>
<th align="left" valign="top"> 数値 </th>
<th align="left" valign="top"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">NOT_RUN</p></td>
<td align="left" valign="top"><p class="table">0</p></td>
<td align="left" valign="top"><p class="table">タスクは未処理</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">MISSING</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
<td align="left" valign="top"><p class="table">タスクの出力がない</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CRASHED</p></td>
<td align="left" valign="top"><p class="table">2</p></td>
<td align="left" valign="top"><p class="table">タスクメソッド <em>run</em> が非ゼロを返した</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">EXCEPTION</p></td>
<td align="left" valign="top"><p class="table">3</p></td>
<td align="left" valign="top"><p class="table">タスクメソッド <em>run</em> で例外が発生した</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">SKIPPED</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
<td align="left" valign="top"><p class="table">タスクはスキップされた(最新の状態だった)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">SUCCESS</p></td>
<td align="left" valign="top"><p class="table">9</p></td>
<td align="left" valign="top"><p class="table">実行は成功した</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>タスクを実行するか否かを決定するために、生産者はタスクメソッド <em>runnable_status</em> の戻値を使う。
可能な戻値は次のようになる：</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="14%" />
<col width="85%" />
<thead>
<tr>
<th align="left" valign="top">コード    </th>
<th align="left" valign="top"> 説明</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">ASK_LATER</p></td>
<td align="left" valign="top"><p class="table">タスクが実行が終了していない他のタスクに依存している(not ready)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">SKIP_ME</p></td>
<td align="left" valign="top"><p class="table">タスクは実行される必要はない、最新</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">RUN_ME</p></td>
<td align="left" valign="top"><p class="table">タスクは実行の準備完了</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>次の図は主要なタスクメソッドとタスクの状態およびステータス間の相互作用を表現した図だ：</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="task_run.png" alt="タスクの状態" />
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ビルド順序制約">8.2. ビルド順序制約</h3>
<div class="sect3">
<h4 id="_set_run_afterメソッド">8.2.1. set_run_afterメソッド</h4>
<div class="paragraph"><p>メソッド <em>set_run_after</em> はタスク間の順序制約を宣言するために使われる:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">task1</span><span style="color: #000000">.</span><span style="color: #000000">set_run_after</span><span style="color: #000000">(</span><span style="color: #000000">task2</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>待機中のタスクは <em>run_after</em> アトリビュートに格納される。
これらのタスクは実行されていない場合にメソッド <em>runnable_status</em> によって使われ、 <em>ASK_LATER</em> ステータスをyieldする。
これは単にビルド順序および前のタスクのうちのひとつが実行された場合にリビルドを強制するためのものだ。</p></div>
</div>
<div class="sect3">
<h4 id="_計算された制約">8.2.2. 計算された制約</h4>
<div class="sect4">
<h5 id="_after_beforeアトリビュート">after/beforeアトリビュート</h5>
<div class="paragraph"><p>アトリビュート <em>before</em> と <em>after</em> はタスク間の順序制約を宣言するために使われる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskBase</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">task_test_a</span><span style="color: #000000">(</span><span style="color: #000000">TaskBase</span><span style="color: #000000">):</span>
<span style="color: #000000">    before </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'task_test_b'</span><span style="color: #000000">]</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">task_test_b</span><span style="color: #000000">(</span><span style="color: #000000">TaskBase</span><span style="color: #000000">):</span>
<span style="color: #000000">    after  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'task_test_a'</span><span style="color: #000000">]</span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_ext_in_ext_out">ext_in/ext_out</h5>
<div class="paragraph"><p>順序を強制する他の方法はクラスアトリビュートで抽象的なシンボルのリストを宣言することだ。
この方法ではクラスは明示的には名付けられない、例えば：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskBase</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">task_test_a</span><span style="color: #000000">(</span><span style="color: #000000">TaskBase</span><span style="color: #000000">):</span>
<span style="color: #000000">    ext_in  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.h'</span><span style="color: #000000">]</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">task_test_b</span><span style="color: #000000">(</span><span style="color: #000000">TaskBase</span><span style="color: #000000">):</span>
<span style="color: #000000">    ext_out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.h'</span><span style="color: #000000">]</span></tt></pre></div></div>
<div class="paragraph"><p><em>拡張子</em> ext_inとext_outは、タスクがそのような拡張子のファイルを生成しなくてはならないことを意味するわけではなく、優先順序制約を使うための単なるシンボルだ。</p></div>
</div>
<div class="sect4">
<h5 id="_順序抽出">順序抽出</h5>
<div class="paragraph"><p>タスクを生産者-消費者システムに投入する前に、入力および出力を持つタスクに対して制約の抽出が行われる。
アトリビュート <em>run_after</em> は待つタスクで初期化される。</p></div>
<div class="paragraph"><p>タスクのリストに対して呼ばれる2つの関数は：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<em>waflib.Task.set_precedence_constraints</em>: タスククラスのアトリビュートext_in/ext_out/before/afterからビルド順序の抽出
</p>
</li>
<li>
<p>
<em>waflib.Task.set_file_constraints</em>: 入力および出力を持つタスクから制約の抽出
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect3">
<h4 id="_弱い順序制約">8.2.3. 弱い順序制約</h4>
<div class="paragraph"><p>多くの実行時間が必要となることがわかっているタスクを最初に実行することでビルド時間が改善される。
制約付きの並列環境おいて最適な実行順序を見つける一般的な問題は<a href="http://en.wikipedia.org/wiki/Job-shop_problem">Job Shop</a>問題と呼ばれる。</p></div>
<div class="paragraph"><p>実際にはこの問題はクリティカルパスの問題に帰着できる(近似)。</p></div>
<div class="paragraph"><p>次の図では異なる独立のタスクでビルドする際のスケジューリングでの遅いタスクが特定され最初に起動される違いを示す：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">range</span><span style="color: #000000">(</span><span style="color: #000000">5</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'sleep 1'</span><span style="color: #000000">,</span><span style="color: #000000"> color</span><span style="color: #000000">=</span><span style="color: #009900">'GREEN'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'short task'</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'sleep 5'</span><span style="color: #000000">,</span><span style="color: #000000"> color</span><span style="color: #000000">=</span><span style="color: #009900">'RED'</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'long task'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="tasks_nosort.png" alt="特別な順序なし" />
</div>
</div>
<div class="paragraph"><p>生産に渡される前にグループから再度タスクの順序を決めるために関数を使う。
長いタスクを最初の位置に並べ換えるために関数を置き換える：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000000">old </span><span style="color: #000000">=</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">set_file_constraints</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">meth</span><span style="color: #000000">(</span><span style="color: #000000">lst</span><span style="color: #000000">):</span>
<span style="color: #000000">    lst</span><span style="color: #000000">.</span><span style="color: #000000">sort</span><span style="color: #000000">(</span><span style="color: #000000">cmp</span><span style="color: #000000">=</span><span style="color: #000080">lambda</span><span style="color: #000000"> x</span><span style="color: #000000">,</span><span style="color: #000000"> y</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000">cmp</span><span style="color: #000000">(</span><span style="color: #000000">x</span><span style="color: #000000">.</span><span style="color: #000000">__class__</span><span style="color: #000000">.</span><span style="color: #000000">__name__</span><span style="color: #000000">,</span><span style="color: #000000"> y</span><span style="color: #000000">.</span><span style="color: #000000">__class__</span><span style="color: #000000">.</span><span style="color: #000000">__name__</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">    </span><span style="color: #000000">old</span><span style="color: #000000">(</span><span style="color: #000000">lst</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">set_file_constraints </span><span style="color: #000000">=</span><span style="color: #000000"> meth </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
長いタスクを最初の位置に設定
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
オリジナルのコードを実行
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
メソッドを置き換える
</td></tr>
</table></div>
<div class="paragraph"><p>ここで影響を表現する：</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="tasks_sort.png" alt="一番遅いタスクを最初に実行" />
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_依存関係">8.3. 依存関係</h3>
<div class="sect3">
<h4 id="_タスクシグネチャ">8.3.1. タスクシグネチャ</h4>
<div class="paragraph"><p><em>waflib.Task.TaskBase</em> の直接のインスタンスは非常に限定されていてファイルの変更を追跡できない。
サブクラスである <em>waflib.Task.Task</em> は、ソースファイルがターゲットファイルの生成に使われる、最も一般的なビルドに必要な特徴を提供する。</p></div>
<div class="paragraph"><p>依存関係の追跡は <strong>タスクシグネチャ</strong> と呼ばれる依存関係のハッシュの使用に基づいて行われる。
シグネチャは入力ファイルやコンフィギュレーションセットの値などのさまざまな依存するソースから計算される。</p></div>
<div class="paragraph"><p>次の図ではどのように <em>waflib.Task.Task</em> インスタンスが処理されるかを示す：</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="task_signature.png" alt="シグネチャ" />
</div>
</div>
<div class="paragraph"><p>次のデータはシグネチャの計算に使われる：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
明示的な依存関係: <em>入力ノード</em> と <em>bld.depends_on</em> によって明示的に示された依存関係のセット
</p>
</li>
<li>
<p>
暗黙の依存関係: スキャナメソッド(<em>scan</em> メソッド)によって探索された依存関係
</p>
</li>
<li>
<p>
値: コンパイルフラグなどのコンフィギュレーションセットの値
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_明示的な依存関係">8.3.2. 明示的な依存関係</h4>
<div class="sect4">
<h5 id="_入力および出力ノード">入力および出力ノード</h5>
<div class="paragraph"><p>タスクオブジェクトは他のタスクに直接依存はしない。
他のタスクは存在するかしないか、そして実行されるかノードである。
むしろ、入力および出力ノードは異なるソースに由来する、それ自身のシグネチャの値を保持する：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
ビルドファイルのためのノードは通常ファイルを生成したタスクのシグネチャを継承する
</p>
</li>
<li>
<p>
他のどこかからのノードはファイルの中身(ハッシュ)から計算されたシグネチャを持つ
</p>
</li>
</ol></div>
</div>
<div class="sect4">
<h5 id="_他のノードに対するグローバルな依存関係">他のノードに対するグローバルな依存関係</h5>
<div class="paragraph"><p>いくつかのファイルは入力に存在しなくても他のファイルに推移的に依存する。
これはビルドコンテキストの <em>add_manual_dependency</em> メソッドによりなされる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'somecopy'</span><span style="color: #000000">)</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_manual_dependency</span><span style="color: #000000">(</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_node</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">),</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_node</span><span style="color: #000000">(</span><span style="color: #009900">'testfile'</span><span style="color: #000000">))</span></tt></pre></div></div>
<div class="paragraph"><p><em>somecopy</em> ファイルは <em>wscript</em> もしくは <em>testfile</em> がたとえ一文字でも変更されるとリビルドされる。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf build</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/tasks_manual_deps/build'</span>
<span style="color: #000000">[1/1] somecopy: wscript -&gt; build/somecopy</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/tasks_manual_deps/build'</span>
<span style="color: #000000">'build' finished successfully (0.034s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/tasks_manual_deps/build'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/tasks_manual_deps/build'</span>
<span style="color: #000000">'build' finished successfully (0.006s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ echo " " &gt;&gt; testfile</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/tasks_manual_deps/build'</span>
<span style="color: #000000">[1/1] somecopy: wscript -&gt; build/somecopy</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/tasks_manual_deps/build'</span>
<span style="color: #000000">'build' finished successfully (0.022s)</span></tt></pre></div></div>
</div>
</div>
<div class="sect3">
<h4 id="_暗黙の依存関係_スキャナメソッド">8.3.3. 暗黙の依存関係(スキャナメソッド)</h4>
<div class="paragraph"><p>いくつかのタスクはビルド開始後に動的に生成することができ、依存関係を前もって知ることはできない。
タスクサブクラスは <em>scan</em> という名前のメソッドを提供することができ、暗黙に追加のノードを得る。
次の例では、 <em>copy</em> タスクはスキャナメソッドを提供し、入力ファイルと同階層で見つかるwscriptファイルに依存する。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> time</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">copy</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>

<span style="color: #000000">    </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">exec_command</span><span style="color: #000000">(</span><span style="color: #009900">'cp %s %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">(),</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">()))</span>

<span style="color: #000000">    </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">scan</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'→ calling the scanner method'</span><span style="color: #000000">)</span>
<span style="color: #000000">        node </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">([</span><span style="color: #000000">node</span><span style="color: #000000">],</span><span style="color: #000000"> time</span><span style="color: #000000">.</span><span style="color: #000000">time</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">    </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">runnable_status</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        ret </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">super</span><span style="color: #000000">(</span><span style="color: #000000">copy</span><span style="color: #000000">,</span><span style="color: #000000"> self</span><span style="color: #000000">).</span><span style="color: #000000">runnable_status</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        bld </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'nodes:       %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">node_deps</span><span style="color: #000000">[</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">uid</span><span style="color: #000000">()])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'custom data: %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">raw_deps</span><span style="color: #000000">[</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">uid</span><span style="color: #000000">()])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> ret</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    tsk </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">copy</span><span style="color: #000000">(</span><span style="color: #000000">env</span><span style="color: #000000">=</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">    tsk</span><span style="color: #000000">.</span><span style="color: #000000">set_inputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'a.in'</span><span style="color: #000000">))</span>
<span style="color: #000000">    tsk</span><span style="color: #000000">.</span><span style="color: #000000">set_outputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #009900">'b.out'</span><span style="color: #000000">))</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_to_group</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
スキャナメソッド
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
戻り値は依存するノードのリストとシリアライズ可能なカスタムデータのタプル
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
runnable_statusメソッドをオーバーライドしてロギングを追加
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
このタスクに関連付けられたビルドコンテキストへの参照を得る
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
スキャナメソッドによって返されるノードはマップ <strong>bld.node_deps</strong> に格納される
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
スキャナメソッドによって返されるカスタムデータマップ <strong>bld.raw_deps</strong> に格納される
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
タスクを手動で作成(タスクジェネレータによるカプセル化については次の章で述べる)
</td></tr>
</table></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">→ calling the scanner method <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">nodes:  [/tmp/tasks_scan/wscript]</span>
<span style="color: #000000">custom data: 55.51</span>
<span style="color: #000000">[1/1] copy: a.in -&gt; build/b.out</span>
<span style="color: #000000">'build' finished successfully (0.021s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf <img src="./callouts/2.png" alt="2" /></span></span>
<span style="color: #000000">nodes:  [/tmp/tasks_scan/wscript]</span>
<span style="color: #000000">custom data: 1280561555.512006</span>
<span style="color: #000000">'build' finished successfully (0.005s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ echo " " &gt;&gt; wscript <img src="./callouts/3.png" alt="3" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">→ calling the scanner method</span>
<span style="color: #000000">nodes:  [/tmp/tasks_scan/wscript]</span>
<span style="color: #000000">custom data: 64.31</span>
<span style="color: #000000">[1/1] copy: a.in -&gt; build/b.out</span>
<span style="color: #000000">'build' finished successfully (0.022s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
スキャナメソッドはクリーンビルドで常に呼ばれる
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
返されるデータが検索された場合でも、何も変更がないときにはスキャナメソッドは呼ばれない
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
依存関係が変化すると、スキャナメソッドはもう一度実行される(カスタムデータが変化した)
</td></tr>
</table></div>
<div class="paragraph"><p>警告: ビルド順序が正しくない場合、メソッド <em>scan</em> は依存するノードの発見に失敗する(ノードが見つからない)か、シグネチャの計算で例外を投げる(依存するノードのシグネチャが見つからない).</p></div>
</div>
<div class="sect3">
<h4 id="_値">8.3.4. 値</h4>
<div class="paragraph"><p>コンパイルフラグのような慣習的なコマンドラインパラメータは <em>値に対する依存関係</em> を生成し、より具体的にはコンギュレーションセットの値を生成する。
タスククラスのアトリビュート <em>vars</em> はシグネチャの計算にどの値が使われるかを制御するために使われる。
次の例では、作成されたタスクは出力も入力も持たないノードを持ち、値にのみ依存する。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">foo</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        vars </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'FLAGS'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'the flags are %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FLAGS</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_option</span><span style="color: #000000">(</span><span style="color: #009900">'--flags'</span><span style="color: #000000">,</span><span style="color: #000000"> default</span><span style="color: #000000">=</span><span style="color: #009900">'-f'</span><span style="color: #000000">,</span><span style="color: #000000"> dest</span><span style="color: #000000">=</span><span style="color: #009900">'flags'</span><span style="color: #000000">,</span><span style="color: #000000"> type</span><span style="color: #000000">=</span><span style="color: #009900">'string'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FLAGS </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">options</span><span style="color: #000000">.</span><span style="color: #000000">flags </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        tsk </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">foo</span><span style="color: #000000">(</span><span style="color: #000000">env</span><span style="color: #000000">=</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_to_group</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
<em>foo</em> という名前のタスククラスを作成
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
<em>self.env.FLAGS</em> が変更されるといつでもタスクインスタンスは実行される
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
デバッグのために値をプリント
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
コマンドラインから値を読む
</td></tr>
</table></div>
<div class="paragraph"><p>実行によって次の出力が生成される：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --flags abcdef</span></span>
<span style="color: #000000">[1/1] foo:</span>
<span style="color: #000000">the flags are 'abcdef' <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">'build' finished successfully (0.006s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf --flags abcdef <img src="./callouts/2.png" alt="2" /></span></span>
<span style="color: #000000">'build' finished successfully (0.004s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf --flags abc</span></span>
<span style="color: #000000">[1/1] foo: <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">the flags are 'abc'</span>
<span style="color: #000000">'build' finished successfully (0.006s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
このタスクは最初の実行で実行される
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
依存関係が変化しないため、タスクは実行されない
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
フラグが変更されたため、タスクは実行される
</td></tr>
</table></div>
</div>
</div>
<div class="sect2">
<h3 id="_タスクのチューニング">8.4. タスクのチューニング</h3>
<div class="sect3">
<h4 id="_クラスアクセス">8.4.1. クラスアクセス</h4>
<div class="paragraph"><p>タスクが次の例のように <em>run_str</em> という名前のアトリビュートを提供するとき:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">COPY      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'/bin/cp'</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">COPYFLAGS </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-f'</span><span style="color: #000000">]</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000000">        </span><span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">copy</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">                run_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${COPY} ${COPYFLAGS} ${SRC} ${TGT}'</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">copy</span><span style="color: #000000">.</span><span style="color: #000000">vars</span><span style="color: #000000">)</span>

<span style="color: #000000">        tsk </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">copy</span><span style="color: #000000">(</span><span style="color: #000000">env</span><span style="color: #000000">=</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span>
<span style="color: #000000">        tsk</span><span style="color: #000000">.</span><span style="color: #000000">set_inputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">))</span>
<span style="color: #000000">        tsk</span><span style="color: #000000">.</span><span style="color: #000000">set_outputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #009900">'b.out'</span><span style="color: #000000">))</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_to_group</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p><em>run_str</em> はコマンドラインを表し、 <em>COPYFLAGS</em> のような <em>${}</em> の中の変数は依存関係に追加される変数を表すことが想定されている。
メタクラスは <em>run_str</em> を処理し、 <em>run</em> メソッド(タスクを実行するために呼ばれる)と <em>vars</em> アトリビュート(存在する変数とマージされた)中の変数を獲得する。
作成された関数は次の出力で表示される：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --zones=action</span></span>
<span style="color: #000000">13:36:49 action   def f(tsk):</span>
<span style="color: #000000">        env = tsk.env</span>
<span style="color: #000000">        gen = tsk.generator</span>
<span style="color: #000000">        bld = gen.bld</span>
<span style="color: #000000">        wd = getattr(tsk, 'cwd', None)</span>
<span style="color: #000000">        def to_list(xx):</span>
<span style="color: #000000">                if isinstance(xx, str): return [xx]</span>
<span style="color: #000000">                return xx</span>
<span style="color: #000000">        lst = []</span>
<span style="color: #000000">        lst.extend(to_list(env['COPY']))</span>
<span style="color: #000000">        lst.extend(to_list(env['COPYFLAGS']))</span>
<span style="color: #000000">        lst.extend([a.path_from(bld.bldnode) for a in tsk.inputs])</span>
<span style="color: #000000">        lst.extend([a.path_from(bld.bldnode) for a in tsk.outputs])</span>
<span style="color: #000000">        lst = [x for x in lst if x]</span>
<span style="color: #000000">        return tsk.exec_command(lst, cwd=wd, env=env.env or None)</span>
<span style="color: #000000">[1/1] copy: wscript -&gt; build/b.out</span>
<span style="color: #000000">['COPY', 'COPYFLAGS']</span>
<span style="color: #000000">'build' finished successfully (0.007s)</span></tt></pre></div></div>
<div class="paragraph"><p><em>waflib.Task.TaskBase</em> のすべてのサブクラスはモジュールアトリビュート <em>waflib.Task.classes</em> に格納される。
そのため、 <em>copy</em> タスクは次のようにアクセスできる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000000">cls </span><span style="color: #000000">=</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">classes</span><span style="color: #000000">[</span><span style="color: #009900">'copy'</span><span style="color: #000000">]</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_スクリプトレット拡張">8.4.2. スクリプトレット拡張</h4>
<div class="paragraph"><p><em>run_str</em> はコンフィギュレーションセットの変数を使うが、利便性のためにいくつかの特別なケースが提供されている：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
値が <strong>env</strong>, <strong>gen</strong>, <strong>bld</strong> もしくは <strong>tsk</strong> で始まる場合、メソッド呼出しは作られる
</p>
</li>
<li>
<p>
値がSRC[n]もしくはTGT[n]で始まる場合、入力/出力ノード <em>n</em> のためのメソッド呼出しは作られる
</p>
</li>
<li>
<p>
SRCはビルドディレクトリのルートから見たタスクの入力のリストを表す
</p>
</li>
<li>
<p>
TGTはビルドディレクトリのルートから見たタスクの出力のリストを表す
</p>
</li>
</ol></div>
<div class="paragraph"><p>ここにいくつかの例を示す：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">$</span><span style="color: #000000">{</span><span style="color: #000000">SRC</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">()}</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">$</span><span style="color: #000000">{</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">()}</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">$</span><span style="color: #000000">{</span><span style="color: #000000">tsk</span><span style="color: #000000">.</span><span style="color: #000000">uid</span><span style="color: #000000">()}</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">$</span><span style="color: #000000">{</span><span style="color: #000000">CPPPATH_ST</span><span style="color: #000000">:</span><span style="color: #000000">INCPATHS</span><span style="color: #000000">}</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
タスクの最初のソースファイルの親フォルダへの絶対パス
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ファイルシステムのルート
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
タスクのユニークな識別子を表示
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
<em>[env.CPPPATH_ST % x for x in env.INCPATHS]</em> と同等なmapの置換を実行
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_直接のクラス変更">8.4.3. 直接のクラス変更</h4>
<div class="sect4">
<h5 id="_常に実行">常に実行</h5>
<div class="paragraph"><p>関数 <em>waflib.Task.always_run</em> はビルドが実行されたときにあるタスクを常に強制的に実行するために使われる。
この関数はメソッド <em>runnable_status</em> が常に <em>RUN_ME</em> を返すように設定する。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000000">    </span><span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">copy</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">        run_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span>
<span style="color: #000000">    copy </span><span style="color: #000000">=</span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">always_run</span><span style="color: #000000">(</span><span style="color: #000000">copy</span><span style="color: #000000">)</span>

<span style="color: #000000">    tsk </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">copy</span><span style="color: #000000">(</span><span style="color: #000000">env</span><span style="color: #000000">=</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span>
<span style="color: #000000">    tsk</span><span style="color: #000000">.</span><span style="color: #000000">set_inputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'wscript'</span><span style="color: #000000">))</span>
<span style="color: #000000">    tsk</span><span style="color: #000000">.</span><span style="color: #000000">set_outputs</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #009900">'b.out'</span><span style="color: #000000">))</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_to_group</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>利便性のため、ルールベースのタスクジェネレータは同じ結果を得るのに <strong>always</strong> アトリビュートを宣言できる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span>
<span style="color: #000000">        rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'echo hello'</span><span style="color: #000000">,</span>
<span style="color: #000000">        always </span><span style="color: #000000">=</span><span style="color: #000000"> True</span>
<span style="color: #000000">    </span><span style="color: #000000">)</span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_ファイルハッシュ">ファイルハッシュ</h5>
<div class="paragraph"><p>出力が本当にタスクから生成されたかを検知するために、タスクのシグネチャはタスクノードの出力のシグネチャとして使われる。
その結果、ソースディレクトリで作られたファイルは毎回リビルドされる。
これを避けるためにノードのシグネチャは実際のファイルの中身に一致する。
これはタスクラスの <em>waflib.Task.update_outputs</em> 関数を使うことで強制される。
この関数は出力ノードにハッシュファイルの中身を設定するために、タスククラスの <em>post_run</em> と <em>runnable_status</em> メソッドを置き換える。</p></div>
<div class="paragraph"><p>利便性のために、ルールベースのタスクジェネレータは <strong>update_outputs</strong> アトリビュートを宣言することがで同じ結果を得ることができる。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span>
<span style="color: #000000">        rule           </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        source         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wcript'</span><span style="color: #000000">,</span>
<span style="color: #000000">        target         </span><span style="color: #000000">=</span><span style="color: #000000"> ctx</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #009900">'wscript2'</span><span style="color: #000000">),</span>
<span style="color: #000000">        update_outputs </span><span style="color: #000000">=</span><span style="color: #000000"> True</span>
<span style="color: #000000">    </span><span style="color: #000000">)</span></tt></pre></div></div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_タスクジェネレータ">9. タスクジェネレータ</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ルールベースのタスクジェネレータ_makeに類似">9.1. ルールベースのタスクジェネレータ(Makeに類似)</h3>
<div class="paragraph"><p>この章では、簡単なターゲットのビルドのためのルールベースのタスクジェネレータの使い方について説明する。</p></div>
<div class="sect3">
<h4 id="_宣言と使い方">9.1.1. 宣言と使い方</h4>
<div class="paragraph"><p>ルールに基づいたタスクジェネレータは正確に1つのタスクを生成する特定のタスクジェネレータのカテゴリーだ。</p></div>
<div class="paragraph"><p>次では、プロジェクトファイル <em>wscript</em> からコピーのために <em>cp</em> コマンドを実行し、 <em>foobar</em> を生成するタスクジェネレータを例示する。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foobar.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
新しいタスクジェネレータを初期化する。すべての引数は <em>key=value</em> の形式だ
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
アトリビュート <em>rule</em> は可読な方法で実行するコマンドを表現する(これについては次の章で詳しく触れる).
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
ソースファイル。スペース区切の文字列か文字列のリスト
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
ターゲットファイル。スペース区切の文字列か文字列のリスト
</td></tr>
</table></div>
<div class="paragraph"><p>実行すると次のような出力が得られるだろう：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.000s)</span>
<span style="color: #000000">'configure' finished successfully (0.021s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rules_simple/build'</span>
<span style="color: #000000">[1/1] foobar.txt: wscript -&gt; build/foobar.txt <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">10:57:33 runner 'cp ../wscript foobar.txt' <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rules_simple/build'</span>
<span style="color: #000000">'build' finished successfully (0.016s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- build</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- foobar.txt</span>
<span style="color: #000000">`-- wscript</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf <img src="./callouts/3.png" alt="3" /></span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rules_simple/build'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rules_simple/build'</span>
<span style="color: #000000">'build' finished successfully (0.006s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ echo " " &gt;&gt; wscript <img src="./callouts/4.png" alt="4" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rules_simple/build'</span>
<span style="color: #000000">[1/1] foobar.txt: wscript → build/foobar.txt <img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rules_simple/build'</span>
<span style="color: #000000">'build' finished successfully (0.013s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
初回の実行でターゲットは正しく作られる
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
コマンドラインは <em>-v</em> オプションをつけた <em>verboseモード</em> でのみ表示される
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
ターゲットは最新なのでタスクは実行されない
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
空白文字を追加し、ソースファイルを変更
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
ソースファイルが変更されたので、ターゲットは再度生成される
</td></tr>
</table></div>
<div class="paragraph"><p>ルールへの文字列も依存関係の計算に追加される。
ルールが変更されるとタスクは再度コンパイルされる。</p></div>
</div>
<div class="sect3">
<h4 id="_ルール関数">9.1.2. ルール関数</h4>
<div class="paragraph"><p>ルールは表現文字列もしくはPython関数として与えられる。
関数は生成されたタスククラスに割当られる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                src </span><span style="color: #000000">=</span><span style="color: #000000"> task</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                tgt </span><span style="color: #000000">=</span><span style="color: #000000"> task</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                cmd </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp %s %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">(</span><span style="color: #000000">src</span><span style="color: #000000">,</span><span style="color: #000000"> tgt</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">cmd</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000080">return</span><span style="color: #000000"> task</span><span style="color: #000000">.</span><span style="color: #000000">exec_command</span><span style="color: #000000">(</span><span style="color: #000000">cmd</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> run</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'same.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
ルール関数はタスクインスタンスをパラメータとしてとる
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ソースとターゲットは内部でタスクインスタンスにバインドされたノードオブジェクトとして表現
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
コマンドはビルドディレクトリのルートから実行される。 <em>bldpath</em> のようなノードのメソッドはコマンドラインの生成を簡単にする
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
タスククラスはコマンドを実行するsubprocess.Popen(&#8230;)のラッパーを保持する
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
文字列表現の代わりに関数を使用
</td></tr>
</table></div>
<div class="paragraph"><p>実行のトレースは次と似たものになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule_function/out'</span>
<span style="color: #000000">[1/1] same.txt: wscript -&gt; out/same.txt</span>
<span style="color: #000000">cp /tmp/rule_function/wscript /tmp/rule_function/build/same.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule_function/out'</span>
<span style="color: #000000">'build' finished successfully (0.010s)</span></tt></pre></div></div>
<div class="paragraph"><p>ルール関数は成功を意味するためにヌル値(0やNone、False)を返さなくてはならない。
また、アウトプットに対応するファイルを生成しなくてはならない。
ルール関数は内部的にスレッドによって実行されるためスレッドセーフなコード(ノードオブジェクトの探索や作成はできない)を書くことが重要となる。</p></div>
<div class="paragraph"><p>文字列表現とは異なり、関数は一度に複数のコマンドを実行できる。</p></div>
</div>
<div class="sect3">
<h4 id="_シェルの使用">9.1.3. シェルの使用</h4>
<div class="paragraph"><p>アトリビュート <em>shell</em> を使うとコマンドの実行のためにシステムのシェルを有効にできる。
ルールベースのタスクジェネレータを宣言するときに、いくつかの点を覚えておくとよい：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Wafツールはコマンドの実行にシェルを使わない
</p>
</li>
<li>
<p>
ユーザーコマンドとカスタムタスクジェネレータのためにデフォルトでシェルが使われる
</p>
</li>
<li>
<p>
シンボル &#8216;&gt;&#8217; 、 &#8216;&lt;&#8217; もしくは &#8216;&amp;&#8217; を含む文字列表現は、シェルを使わずにコマンドを実行するために関数に変換しようとしてもできない
</p>
</li>
<li>
<p>
一般に、クオートの問題(例えば、空白文字を含むパス)を避けるために、シェルを使うのは可能であれば常に避けたほうがよい
</p>
</li>
<li>
<p>
シェルは、win32システムでより顕著な、パフォーマンス上のペナルティをうみだす。
</p>
</li>
</ol></div>
<div class="paragraph"><p>例:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'f1.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> shell</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'f2.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> shell</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>実行すると、結果は次と似たものになるだろう：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --zones=runner,action</span></span>
<span style="color: #000000">'distclean' finished successfully (0.004s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">23:11:23 action <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">def f(task):</span>
<span style="color: #000000">        env = task.env</span>
<span style="color: #000000">        wd = getattr(task, 'cwd', None)</span>
<span style="color: #000000">        def to_list(xx):</span>
<span style="color: #000000">                if isinstance(xx, str): return [xx]</span>
<span style="color: #000000">                return xx</span>
<span style="color: #000000">        lst = []</span>
<span style="color: #000000">        lst.extend(['cp'])</span>
<span style="color: #000000">        lst.extend([a.srcpath(env) for a in task.inputs])</span>
<span style="color: #000000">        lst.extend([a.bldpath(env) for a in task.outputs])</span>
<span style="color: #000000">        lst = [x for x in lst if x]</span>
<span style="color: #000000">        return task.exec_command(lst, cwd=wd)</span>

<span style="color: #000000">23:11:23 action</span>
<span style="color: #000000">def f(task):</span>
<span style="color: #000000">        env = task.env</span>
<span style="color: #000000">        wd = getattr(task, 'cwd', None)</span>
<span style="color: #000000">        p = env.get_flat</span>
<span style="color: #000000">        cmd = ''' cp %s %s ''' % (" ".join([a.srcpath(env) for a in task.inputs]), <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                " ".join([a.bldpath(env) for a in task.outputs]))</span>
<span style="color: #000000">        return task.exec_command(cmd, cwd=wd)</span>

<span style="color: #000000">[1/2] f1.txt: wscript -&gt; out/f1.txt</span>
<span style="color: #000000">23:11:23 runner system command -&gt; ['cp', '../wscript', 'f1.txt'] <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">[2/2] f2.txt: wscript -&gt; out/f2.txt</span>
<span style="color: #000000">23:11:23 runner system command -&gt;  cp ../wscript f2.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.017s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
文字列表現は関数に変換される(シェルを使わない).
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
シェルによって実行されるコマンド。文字列の連結を大量に行わないように気をつけよう
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
実行するコマンドは <em>waf --zones=runner</em> を呼び出すと表示される。シェルなしで呼び出されると、引数はリストとして表示される
</td></tr>
</table></div>
<div class="paragraph"><p>備考: パフォーマンスとメンテナンス性のため、可能な限りシェルを使うのは避けるよう努力しよう</p></div>
</div>
<div class="sect3">
<h4 id="_インプットとアウトプット">9.1.4. インプットとアウトプット</h4>
<div class="paragraph"><p>ソースとターゲット引数はMakeに似たタスクジェネレータにはオプショナルで、一度に一つもしくは複数のファイルを指す。
いくつかの例：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT[0].abspath()} &amp;&amp; cp ${SRC} ${TGT[1].abspath()}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'f1.txt f2.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                shell  </span><span style="color: #000000">=</span><span style="color: #000000"> True</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'wscript'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'echo ${SRC}'</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test.k3'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'echo "test" &gt; ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'echo 1337'</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">"echo 'task always run'"</span><span style="color: #000000">,</span>
<span style="color: #000000">                always </span><span style="color: #000000">=</span><span style="color: #000000"> True</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
インプットまたはルールが変更されたらいつでも <em>2つのファイル</em> を生成する。同様に、ルールベースのタスクジェネレータは複数のインプットファイルをとることができる
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
インプットまたはルールが変更されたらいつでもコマンドが実行される。宣言されたアウトプットはない
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
インプットなし、コマンドが変更されたらいつでもコマンドが実行される
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
インプットもアウトプットもなし、文字列表現が変更されたときにのみコマンドが実行される
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
インプットもアウトプットもなし、ビルドが呼び出される度にコマンドが実行される
</td></tr>
</table></div>
<div class="paragraph"><p>記録するために、これがビルドのアウトプットだ:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">'configure' finished successfully (0.093s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/5] echo 1337:</span>
<span style="color: #000000">1337</span>
<span style="color: #000000">[2/5] echo 'task always run':</span>
<span style="color: #000000">[3/5] echo ${SRC}: wscript</span>
<span style="color: #000000">../wscript</span>
<span style="color: #000000">[4/5] f1.txt f2.txt: wscript -&gt; out/f1.txt out/f2.txt</span>
<span style="color: #000000">task always run</span>
<span style="color: #000000">[5/5] test.k3:  -&gt; out/test.k3</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.049s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[2/5] echo 'task always run':</span>
<span style="color: #000000">task always run</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.014s)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_ファイルの内容に対する依存関係">9.1.5. ファイルの内容に対する依存関係</h4>
<div class="paragraph"><p>2番目の例として、現在の日付からファイル <em>r1.txt</em> を作る。
ビルドが実行される度に更新される。
2番目のファイル <em>r2.txt</em>  は <em>r1.txt</em> から作られる。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                name   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'(date &gt; ${TGT}) &amp;&amp; cat ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                always </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                name   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r2'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r2.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1.txt'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                after  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
タスクジェネレータに名前を与え、タスクジェネレータはコマンドを実行するための同じ名前のタスククラスを作る
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
日付とともに <em>r1.txt</em> を作成する
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
依存すべきソースファイルがなく、ルールは決して変更されない。タスクは <em>always</em> アトリビュートを使ってビルドが開始される度に実行されるようにする
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
名前が与えられないとき、ルールがタスククラスの名前として使われる
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
<em>r1.txt</em> を <em>r2.txt</em> のソースとして使う。<em>r1.txt</em> は前に宣言されたため、依存関係が自動的に追加される(<em>r2.txt</em> は <em>r1.txt</em> が変更されると再作成される)
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
<em>r1.txt</em> を生成するコマンドの後で、 <em>r2.txt</em> を生成するコマンドが実行されるようにセットする。アトリビュート <em>after</em> はタスクジェネレータではなく、タスククラス名を参照する。ここでは、ルールベースのタスクジェネレータは <em>name</em> アトリビュートを継承するため、動作する
</td></tr>
</table></div>
<div class="paragraph"><p>実行結果は次のようになる；</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.003s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] r1:  -&gt; out/r1.txt</span>
<span style="color: #000000">16:44:39 runner system command -&gt;  (date &gt; r1.txt) &amp;&amp; cat r1.txt</span>
<span style="color: #000000">dom ene 31 16:44:39 CET 2010</span>
<span style="color: #000000">[2/2] r2: out/r1.txt -&gt; out/r2.txt</span>
<span style="color: #000000">16:44:39 runner system command -&gt;  cp r1.txt r2.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.021s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf -v</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] r1:  -&gt; out/r1.txt</span>
<span style="color: #000000">16:44:41 runner system command -&gt;  (date &gt; r1.txt) &amp;&amp; cat r1.txt</span>
<span style="color: #000000">dom ene 31 16:44:41 CET 2010</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.016s)</span></tt></pre></div></div>
<div class="paragraph"><p>r2は <em>r1.txt</em> に <strong>依存</strong> するが、r2は2度目のビルドで実行されなかった。
実際のところ、タスクr1のシグネチャは変化しておらず、r1はシグネチャとは関係なしに毎回実行されるようにセットされただけだ。
<em>r1.txt</em> のシグネチャは変化していないため、r2のシグネチャも変化せず、 <em>r2.txt</em> は最新の状態と判断される。</p></div>
<div class="paragraph"><p><em>on_results</em> アトリビュートを有効にすることで、アウトプットがファイルの内容を反映し、依存するタスクのリビルドを引き起こすようにする方法を示す：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                name   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'(date &gt; ${TGT}) &amp;&amp; cat ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                always </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span>
<span style="color: #000000">                on_results </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span>

<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r2.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                rule   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1.txt'</span><span style="color: #000000">,</span>
<span style="color: #000000">                after  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'r1'</span><span style="color: #000000">,</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p><em>r2.txt</em> は毎回再生成される:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.003s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] r1:  -&gt; out/r1.txt</span>
<span style="color: #000000">16:59:49 runner system command -&gt;  (date &gt; r1.txt) &amp;&amp; cat r1.txt <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">dom ene 31 16:59:49 CET 2010 <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">[2/2] r2: out/r1.txt -&gt; out/r2.txt</span>
<span style="color: #000000">16:59:49 runner system command -&gt;  cp r1.txt r2.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.020s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf -v</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] r1:  -&gt; out/r1.txt</span>
<span style="color: #000000">16:59:49 runner system command -&gt;  (date &gt; r1.txt) &amp;&amp; cat r1.txt</span>
<span style="color: #000000">dom ene 31 16:59:49 CET 2010 <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.016s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf -v</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/rule/out'</span>
<span style="color: #000000">[1/2] r1:  -&gt; out/r1.txt</span>
<span style="color: #000000">16:59:53 runner system command -&gt;  (date &gt; r1.txt) &amp;&amp; cat r1.txt</span>
<span style="color: #000000">dom ene 31 16:59:53 CET 2010 <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">[2/2] r2: out/r1.txt -&gt; out/r2.txt</span>
<span style="color: #000000">16:59:53 runner system command -&gt;  cp r1.txt r2.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/rule/out'</span>
<span style="color: #000000">'build' finished successfully (0.022s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
クリーンビルドから始めて、<em>r1.txt</em> と <em>r2.txt</em> の両方が生成される
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
日時が通知される
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
2番目のビルドが同一の日時に実行されたため、<em>r1.txt</em> は変化せず、<em>r2.txt</em> は最新の状態
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
3番目のビルドが別の日時に実行されたため、<em>r1.txt</em> は変化し、 <em>r2.txt</em> は再生成される
</td></tr>
</table></div>
</div>
</div>
<div class="sect2">
<h3 id="_名前と拡張子に基づくファイル処理">9.2. 名前と拡張子に基づくファイル処理</h3>
<div class="paragraph"><p>ファイル名や拡張子に基づいて自動的に変換される。</p></div>
<div class="sect3">
<h4 id="_ルールベースの繰返しのタスクジェネレータを暗黙のルールへリファクタリング">9.2.1. ルールベースの繰返しのタスクジェネレータを暗黙のルールへリファクタリング</h4>
<div class="paragraph"><p>前の章で述べた明示的なルールは同じ種類のファイルの処理に限られる。
次のコードはメインテナンス不能なスクリプトへ誘うものであり、さらにビルドが遅い(forループ)：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #009900">'a.lua b.lua c.lua'</span><span style="color: #000000">.</span><span style="color: #000000">split</span><span style="color: #000000">():</span>
<span style="color: #000000">                y </span><span style="color: #000000">=</span><span style="color: #000000"> x</span><span style="color: #000000">.</span><span style="color: #000000">replace</span><span style="color: #000000">(</span><span style="color: #009900">'.lua'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'.luac'</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #000000">x</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #000000">y</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'${LUAC} -s -o ${TGT} ${SRC}'</span><span style="color: #000000">)</span>
<span style="color: #000000">                bld</span><span style="color: #000000">.</span><span style="color: #000000">install_files</span><span style="color: #000000">(</span><span style="color: #009900">'${LUADIR}'</span><span style="color: #000000">,</span><span style="color: #000000"> x</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>むしろ、ルールはユーザースリクプトから取り除かれるべきで、次のようなものだ:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'a.lua b.lua c.lua'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>同等なロジックは次のコードで実現される。
これは同じ <em>wscript</em> もしくはWafツールに配置することができる:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span>
<span style="color: #000000">        name         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'luac'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        rule         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${LUAC} -s -o ${TGT} ${SRC}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        shell        </span><span style="color: #000000">=</span><span style="color: #000000"> False</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_in       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.lua'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        ext_out      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.luac'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        reentrant    </span><span style="color: #000000">=</span><span style="color: #000000"> False</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        install_path </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${LUADIR}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
使用するタスククラスに対応する名前
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ルールはルールベースのタスクジェネレータと同じ
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
拡張子によって処理される入力ファイル
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
スペースで区切られた出力ファイルの拡張子。この場合は唯一の出力ファイル
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
reentrantアトリビュートは、他の暗黙なルールによる処理のために、出力ファイルを再度入力として追加するのに使われる
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
アウトプットファイルへのパスの文字列表現は、 <em>bld.install_files</em> からの目的の場所へのパスと似ている。インストールを無効にするならFalseに設定。
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_2つ以上のコマンドの連鎖">9.2.2. 2つ以上のコマンドの連鎖</h4>
<div class="paragraph"><p>ここでは長い連鎖を考える <em>uh.in</em> → <em>uh.a</em> → <em>uh.b</em> → <em>uh.c</em> 。
次の暗黙のルールは最小限のユーザースクリプトのメンナンスでファイルを生成するデモを行う：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'uh.in'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span><span style="color: #000000">name</span><span style="color: #000000">=</span><span style="color: #009900">'a'</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> ext_in</span><span style="color: #000000">=</span><span style="color: #009900">'.in'</span><span style="color: #000000">,</span><span style="color: #000000"> ext_out</span><span style="color: #000000">=</span><span style="color: #009900">'.a'</span><span style="color: #000000">,)</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span><span style="color: #000000">name</span><span style="color: #000000">=</span><span style="color: #009900">'b'</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> ext_in</span><span style="color: #000000">=</span><span style="color: #009900">'.a'</span><span style="color: #000000">,</span><span style="color: #000000">  ext_out</span><span style="color: #000000">=</span><span style="color: #009900">'.b'</span><span style="color: #000000">,)</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span><span style="color: #000000">name</span><span style="color: #000000">=</span><span style="color: #009900">'c'</span><span style="color: #000000">,</span><span style="color: #000000"> rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> ext_in</span><span style="color: #000000">=</span><span style="color: #009900">'.b'</span><span style="color: #000000">,</span><span style="color: #000000">  ext_out</span><span style="color: #000000">=</span><span style="color: #009900">'.c'</span><span style="color: #000000">,</span><span style="color: #000000"> reentrant </span><span style="color: #000000">=</span><span style="color: #000000"> False</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>ビルドフェーズの間、拡張子に基づいて正しいコンパイル順序が計算される：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.000s)</span>
<span style="color: #000000">'configure' finished successfully (0.090s)</span>
<span style="color: #000000">Waf: Entering directory `/comp/waf/demos/simple_scenarios/chaining/build'</span>
<span style="color: #000000">[1/3] a: uh.in -&gt; build/uh.a</span>
<span style="color: #000000">[2/3] b: build/uh.a -&gt; build/uh.b</span>
<span style="color: #000000">[3/3] c: build/uh.b -&gt; build/uh.c</span>
<span style="color: #000000">Waf: Leaving directory `/comp/waf/demos/simple_scenarios/chaining/build'</span>
<span style="color: #000000">'build' finished successfully (0.034s)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_スキャナメソッド">9.2.3. スキャナメソッド</h4>
<div class="paragraph"><p>変換の連鎖は暗黙の変換に基づいているため、いくつかのファイルをスクリプトから除くことが望ましい。
もしくは、いくつかの依存関係は条件的に導入され、事前にはわからないかもしれない。
<em>スキャナメソッド</em> は追加的な依存関係をターゲットが生成される直前に探すある種のコールバックだ。
例示するために、3つのファイル <em>wscript</em> 、 <em>ch.in</em> 、 <em>ch.dep</em> が含まれる空のプロジェクトから始めよう：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/smallproject</span></span>

<span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- ch.dep</span>
<span style="color: #000000">|-- ch.in</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="paragraph"><p>ビルドは <em>ch.out</em> と呼ばれる <em>ch.in</em> のコピーを作る。
また <em>ch.out</em> は <em>ch.dep</em> が変更されるたびにリビルドされなくてはならない。
これは多かれ少なかれ次のMakefileに対応する：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">ch.out:</span><span style="color: #000000"> ch.in ch.dep</span>
<span style="color: #000000">        cp ch.in ch.out</span></tt></pre></div></div>
<div class="paragraph"><p>ユーザースクリプトは次のコードのみを含む：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'ch.in'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>次のコードはユーザースクリプトからは独立で、Wafツールによって読み込まれる。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">scan_meth</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        node </span><span style="color: #000000">=</span><span style="color: #000000"> task</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">]</span>
<span style="color: #000000">        dep </span><span style="color: #000000">=</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #000000">node</span><span style="color: #000000">.</span><span style="color: #000000">name</span><span style="color: #000000">.</span><span style="color: #000000">replace</span><span style="color: #000000">(</span><span style="color: #009900">'.in'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'.dep'</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000080">not</span><span style="color: #000000"> dep</span><span style="color: #000000">:</span>
<span style="color: #000000">                </span><span style="color: #000080">raise</span><span style="color: #000000"> </span><span style="color: #000000">ValueError</span><span style="color: #000000">(</span><span style="color: #009900">"Could not find the .dep file for %r"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> node</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">([</span><span style="color: #000000">dep</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000">[])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span>
<span style="color: #000000">        name      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'copy'</span><span style="color: #000000">,</span>
<span style="color: #000000">        rule      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_in    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.in'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_out   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.out'</span><span style="color: #000000">,</span>
<span style="color: #000000">        reentrant </span><span style="color: #000000">=</span><span style="color: #000000"> False</span><span style="color: #000000">,</span>
<span style="color: #000000">        scan      </span><span style="color: #000000">=</span><span style="color: #000000"> scan_meth</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
スキャナメソッドはタスクオブジェクトを入力として受け付ける(タスクジェネレータではない)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
依存関係を見つけるためにノードメソッドを使用 (そして見つからなければエラーを挙げる)
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
スキャナメソッドは2つのリストを含むタプルを返す。最初のリストは依存するノードオブジェクトのリストを含む。2番目のリストはデバッグ情報などのプライベートなデータを含む。結果はビルドの呼出間でキャッシュされ、中身はシリアライズされる。
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
宣言を連鎖するためにスキャナメソッドを追加
</td></tr>
</table></div>
<div class="paragraph"><p>実行のトレースは次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ echo 1 &gt; ch.in</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ echo 1 &gt; ch.dep <img src="./callouts/1.png" alt="1" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build'</span>
<span style="color: #000000">[1/1] copy: ch.in -&gt; build/ch.out <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build'</span>
<span style="color: #000000">'build' finished successfully (0.010s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build'</span>
<span style="color: #000000">'build' finished successfully (0.005s) <img src="./callouts/3.png" alt="3" /></span>

<span style="font-weight: bold"><span style="color: #993399">$ echo 2 &gt; ch.dep <img src="./callouts/4.png" alt="4" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject/build'</span>
<span style="color: #000000">[1/1] copy: ch.in -&gt; build/ch.out <img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject/build'</span>
<span style="color: #000000">'build' finished successfully (0.012s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
<em>ch.in</em> と <em>ch.dep</em> のファイルの中身を初期化
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
最初のクリーンビルドを実行。ファイル <em>ch.out</em> が生成される
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
何も変更されていないので、ターゲット <em>ch.out</em> は最新の状態
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
<em>ch.dep</em> の中身を変更
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
依存関係が変化したのでリビルド
</td></tr>
</table></div>
<div class="paragraph"><p>ここにスキャナメソッドのいくつかの重要なポイントを示す：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
ターゲットが最新の状態でない場合に限り実行される
</p>
</li>
<li>
<p>
<em>task</em> オブジェクトやコンフィギュレーションセット <em>task.env</em> の中身を変更しない
</p>
</li>
<li>
<p>
並列実行における問題を回避するため、メインのシングルスレッドでのみ実行される
</p>
</li>
<li>
<p>
スキャナの結果(2つのリストのタプル)はビルドの実行間で再利用される(プログラミングによりこれらの結果にアクセス可能)
</p>
</li>
<li>
<p>
Makeに似たルールは <em>scan</em> 引数も受け付ける (スキャナメソッドはタスクジェネレータよりもむしろタスクにバインドされる)
</p>
</li>
<li>
<p>
C/C++サポートでは、ヘッダファイルの依存関係(<em>.c</em> → <em>.h</em>)を動的に追加するため、Wafによって内部的に使われる
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_拡張子コールバック">9.2.4. 拡張子コールバック</h4>
<div class="paragraph"><p>前のセクションでの連鎖の宣言で、<em>reentrant</em> アトリビュートは生成されたファイルが処理されるべきかそうでないかを制御するためのものとして述べた。
しかし、それ自身のなかではソースファイルとして考慮されてない(C/C++でのヘッダファイルのように)が、生成された2つのファイルのうちの1つが宣言されるべき場合もある(依存関係として使われるため).
ここで(<em>uh.in</em> → <em>uh.a1</em> + <em>uh.a2</em>)と(<em>uh.a1</em> → <em>uh.b</em>)の2つの連鎖について次の例で考える：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        obj </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'uh.in'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span>
<span style="color: #000000">        name      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'a'</span><span style="color: #000000">,</span>
<span style="color: #000000">        action    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_in    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.in'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_out   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.a1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'.a2'</span><span style="color: #000000">],</span>
<span style="color: #000000">        reentrant </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span>
<span style="color: #000000">)</span>

<span style="color: #000000">TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">declare_chain</span><span style="color: #000000">(</span>
<span style="color: #000000">        name      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'b'</span><span style="color: #000000">,</span>
<span style="color: #000000">        action    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_in    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.a1'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_out   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.b'</span><span style="color: #000000">,</span>
<span style="color: #000000">        reentrant </span><span style="color: #000000">=</span><span style="color: #000000"> False</span><span style="color: #000000">,</span>
<span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>次のエラーメッセージが生成される：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/smallproject'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/smallproject'</span>
<span style="color: #000000">Cannot guess how to process bld:///tmp/smallproject/uh.a2 (got mappings ['.a1', '.in'] in</span>
<span style="color: #000000">   class TaskGen.task_gen) -&gt; try conf.load(..)?</span></tt></pre></div></div>
<div class="paragraph"><p>エラーメッセージは <em>uh.a2</em> を処理する方法が存在しないことを示唆する。
<em>.a1</em> か <em>.in</em> を拡張子にもつファイルのみが処理される。
内部的に、拡張子の名前はコールバックメソッドにバインドされている。
エラーはメソッドが見つからなかったために発生し、次はグローバルに拡張子コールバックを登録する方法だ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.a2'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">foo</span><span style="color: #000000">(*</span><span style="color: #000000">k</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">**</span><span style="color: #000000">kw</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span></tt></pre></div></div>
<div class="paragraph"><p>拡張子コールバックをローカルに登録するためには、タスクジェネレータへの参照は保たれなくてはならない：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        obj </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'uh.in'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">callback</span><span style="color: #000000">(*</span><span style="color: #000000">k</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">**</span><span style="color: #000000">kw</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #000080">pass</span>
<span style="color: #000000">        obj</span><span style="color: #000000">.</span><span style="color: #000000">mappings</span><span style="color: #000000">[</span><span style="color: #009900">'.a2'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> callback</span></tt></pre></div></div>
<div class="paragraph"><p>拡張子コールバックの正確なメソッドシグネチャと典型的な用法は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">".a"</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">".b"</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">my_callback</span><span style="color: #000000">(</span><span style="color: #000000">task_gen_object</span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span><span style="color: #000000">):</span>
<span style="color: #000000">        task_gen_object</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span>
<span style="color: #000000">                task_name</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                node</span><span style="color: #000000">,</span><span style="color: #000000">  </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                output_nodes</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
カンマ区切りの拡張子のリスト(strings)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
データを保持するタスクジェネレータインスタンス
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
ファイルを表すノードインスタンス(ソースもしくはビルド)
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
タスクを生成するための最初の引数はタスククラスの名前
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
2番目の引数は入力ノード(もしくは複数の入力に対するノードのリスト)
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
最後のパラメータは出力ノード(もしくは複数の出力に対するノードのリスト)
</td></tr>
</table></div>
<div class="paragraph"><p>新しいタスククラスの生成については次のセクションで記述する。</p></div>
</div>
<div class="sect3">
<h4 id="_タスククラスの宣言">9.2.5. タスククラスの宣言</h4>
<div class="paragraph"><p>WafタスクはTask.TaskBaseクラスのインスタンスだ。
しかし、ベースクラスは実に最小限であるため、直接のサブクラスである <em>Task.Task</em> が通常ユーザースクリプトで使われる。
ここでは1つの <em>wscript</em> プロジェクトファイルと <em>ah.in</em> という名前のサンプルファイルのみを含む単純なプロジェクトから始める。
タスククラスはあとで追加される。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'uh.in'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span><span style="color: #000000">,</span><span style="color: #000000"> TaskGen</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.in'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span>
<span style="color: #000000">        tsk </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span><span style="color: #009900">'abcd'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">.</span><span style="color: #000000">__class__</span><span style="color: #000000">)</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">abcd</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">Task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'executing...'</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">0</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
<em>abcd</em> の新たなインスタンスの作成。メソッド <em>create_task</em> はタスクがそのタスクジェネレータへのリファレンスを保つことを保証するためのショートカット
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
モジュールTask.pyのTaskクラスを継承
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
メソッドrunはタスクが実行されたときに呼ばれる
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
タスクのリターンステータスは整数でなくてはならず、ゼロは成功を意味する。失敗したタスクはその後に続くビルドで実行される
</td></tr>
</table></div>
<div class="paragraph"><p>ビルド実行の出力は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">&lt;class 'wscript_main.abcd'&gt;</span>
<span style="color: #000000">[1/1] abcd:</span>
<span style="color: #000000">executing...</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">'build' finished successfully (0.005s)</span></tt></pre></div></div>
<div class="paragraph"><p>plainなPythonでタスククラスを書き下すことができるが、2つの関数(ファクトリ)が簡略化のために提供されている、例えば：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">simple_task_type</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #009900">'xsubpp'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        rule    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${PERL} ${XSUBPP} ${SRC} &gt; ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        color   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'BLUE'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        before  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cc'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build_it</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">0</span>

<span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">task_type_from_func</span><span style="color: #000000">(</span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">        </span><span style="color: #009900">'sometask'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">        func    </span><span style="color: #000000">=</span><span style="color: #000000"> build_it</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span>
<span style="color: #000000">        vars    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'SRT'</span><span style="color: #000000">],</span>
<span style="color: #000000">        color   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'RED'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_in  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.in'</span><span style="color: #000000">,</span>
<span style="color: #000000">        ext_out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.out'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/9.png" alt="9" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
ルール文字列を実行する新しいタスククラスを生成
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
タスククラスの名前
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
ビルド中に実行されるルール
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
実行中の出力の色
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
<em>cc</em> という名前のタスククラスのインスタンスに先立って実行。 <em>before</em> の反対は <em>after</em>
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
カスタムのPython関数から新しいタスククラスの生成。<em>vars</em> アトリビュートは依存関係として使われる追加のコンフィギュレーションセットの値を表す
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
タスククラスの名前
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
使用する関数
</td></tr>
<tr><td><img src="./callouts/9.png" alt="9" /></td><td>
このコンテキストでは、他のタスククラスを明示的に名付けなくても、拡張子の名前は実行順序の計算に使われることを意味する
</td></tr>
</table></div>
<div class="paragraph"><p>殆どのアトリビュートは2つのファクトリ関数の間で共通であることに注意してほしい。
他にも多くの使用例がWafツールの中で見つかるだろう。</p></div>
</div>
<div class="sect3">
<h4 id="_ソースアトリビュートの処理">9.2.6. ソースアトリビュートの処理</h4>
<div class="paragraph"><p>ソースファイルアトリビュートの処理での最初の処理はすべてのファイル名をノードに変換することだ。
正確な(拡張子なしの)ファイル名のエントリによって、特別なメソッドがintercept namesにマッピングされる。
ノードオブジェクトはタスクジェネレータの <em>source</em> アトリビュートに追加される。</p></div>
<div class="paragraph"><p>ノードのリストは通常の拡張子のマッピングにより処理される。
拡張メソッドはその後の処理のために、 <em>source</em> アトリビュートに追加することで、出力ノードを再度挿入する。
(従って、リエントラントという名前はdeclare_chainで提供される)。</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="source.png" alt="ソースアトリビュートの処理" />
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_一般的な目的のタスクジェネレータ">9.3. 一般的な目的のタスクジェネレータ</h3>
<div class="paragraph"><p>これまで、さまざまなタスクジェネレータの使用例を示してきた。
この章ではタスクジェネレータの構造および用途を詳述する。</p></div>
<div class="sect3">
<h4 id="_タスクジェネレータの定義">9.3.1. タスクジェネレータの定義</h4>
<div class="paragraph"><p>Makeに類似したルールに関する章でどのようにアトリビュート <em>rule</em> が処理されるかを示した。
名前と拡張子に基づくファイル処理に関する章でどのようにアトリビュート <em>source</em> が処理されるかを示した(ruleアトリビュートの不在)。
<em>どのようなアトリビュート</em> でも処理するために次のプロパティを保持する：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
アトリビュートはタスクジェネレータがタスクを生成するためにセットされたときにのみ処理される(遅延処理)
</p>
</li>
<li>
<p>
オーソライズされたアトリビュートのリストは存在しない(タスクジェネレータはユーザースクリプトによって拡張される)
</p>
</li>
<li>
<p>
タスクジェネレータのインスタンス単位でアトリビュートの処理が制御される(特定のタスクジェネレータのための特別なルール)
</p>
</li>
<li>
<p>
拡張は独立したフィイルに分割される(Wafツール間の低いカップリング)
</p>
</li>
</ol></div>
<div class="paragraph"><p>そのようなシステムを実装することは難しい問題で、非常に異なるデザインの生成を引起こす：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<em>タスクジェネレータのサブクラスの階層</em> Wafツール間の高いカップリングのため廃棄された: ハイブリッドなアプリケーションのビルドではCツールがDツールの知識を必要とする
</p>
</li>
<li>
<p>
<em>メソッド修飾(メソッド呼出しのリンクリストの生成)</em> 安全にメソッドを置換もしくは無効にすることはもはや不可能(追加のみ可能)で、このシステムはすぐになくなった
</p>
</li>
<li>
<p>
<em>フラットメソッドと実行制約の宣言</em> この概念はアスペクト指向プログラミングに近く、プログラマを恐れさせる
</p>
</li>
</ol></div>
<div class="paragraph"><p>これまで、3番目のデザインがもっとも柔軟性があり保たれてきた。
これはタスクジェネレータメソッドを定義する方法だ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        v </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">myattr</span><span style="color: #000000">=</span><span style="color: #009900">'Hello, world!'</span><span style="color: #000000">)</span>
<span style="color: #000000">        v</span><span style="color: #000000">.</span><span style="color: #000000">myattr </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'Hello, world!'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        v</span><span style="color: #000000">.</span><span style="color: #000000">myMethod</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">taskgen_method </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">myMethod</span><span style="color: #000000">(</span><span style="color: #000000">tgen</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'myattr'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
アトリビュートは引数もしくはオブジェクトへのアクセスによってセットされる。この例では2度セットされる
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
タスクジェネレータのメソッドの明示的な呼出し
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
Pythonデコレータの使用
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
タスクジェネレータのメソッドは現在のインスタンスを表すユニークな引数をとる
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
アトリビュート <em>myattr</em> が存在する場合(この例の場合)、処理する
</td></tr>
</table></div>
<div class="paragraph"><p>ビルドのアウトプットは次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">hello world</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">'build' finished successfully (0.003s)</span></tt></pre></div></div>
<div class="paragraph"><p>備考: Pythonのクラスに新しいメソッドをバインドするように、メソッドは <em>setattr</em> を直接使うことでバインドすることができる</p></div>
</div>
<div class="sect3">
<h4 id="_ビルド中のメソッドの実行">9.3.2. ビルド中のメソッドの実行</h4>
<div class="paragraph"><p>これまで、定義されたタアスクジェネレータメソッドは明示的な呼出しによってのみ実行されていた。
ビルドフェーズでタスクジェネレータを実行させるためには別のデコレータが必要だ。
アップデートされた例：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">myattr</span><span style="color: #000000">=</span><span style="color: #009900">'Hello, world!'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">taskgen_method </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">methodName</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'myattr'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">))</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
メソッドをタスクジェネレータクラスにバインド(<em>TaskGen.feature</em> のような他のメソッドが使われる場合、冗長)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
メソッドをシンボル <em>myfeature</em> にバインド
</td></tr>
</table></div>
<div class="paragraph"><p>実行結果は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --zones=task_gen <img src="./callouts/1.png" alt="1" /></span></span>
<span style="color: #000000">'distclean' finished successfully (0.004s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">23:03:44 task_gen posting objects (normal)</span>
<span style="color: #000000">23:03:44 task_gen posting &gt;task_gen '' of type task_gen defined in dir:///tmp/simpleproject&gt; 139657958706768 <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">23:03:44 task_gen -&gt; exec_rule (139657958706768) <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">23:03:44 task_gen -&gt; process_source (139657958706768) <img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">23:03:44 task_gen -&gt; methodName (139657958706768) <img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">Hello, world!</span>
<span style="color: #000000">23:03:44 task_gen posted <img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">Waf: Leaving directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">23:03:44 task_gen posting objects (normal)</span>
<span style="color: #000000">'build' finished successfully (0.004s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
デバッグゾーン <em>task_gen</em> は実行されたタスクジェネレータのメソッドを表示するために使用
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
どのタスクジェネレータが実行されたかを表示
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
メソッド <em>exec_rule</em> は <em>rule</em> を処理するために使われる。これは常に実行される
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
メソッド <em>process_source</em> は <em>source</em> アトリビュートを処理するために使われる。これはメソッド <em>exec_rule</em> が <em>rule</em> アトリビュートを処理する場合を除いて常に実行される
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
タスクジェネレータは実行され <em>Hello, world!</em> を出力
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
タスクジェネレータのメソッドが実行されタスクジェネレータは実行済とマークされる(posted)
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_タスクジェネレータの特徴">9.3.3. タスクジェネレータの特徴</h4>
<div class="paragraph"><p>これまで、追加されたタスクジェネレータメソッドはすべてのタスクジェネレータインスタンスによって実行されるためのものだ。
特別なタスクジェネレータに実行を制限するためには <em>feature</em> デコレータを使う:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'ping'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'ping pong'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'ping'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">ping</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'ping'</span><span style="color: #000000">)</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'pong'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">pong</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'pong'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>実行結果の出力は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --zones=task_gen</span></span>
<span style="color: #000000">'distclean' finished successfully (0.003s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">16:22:07 task_gen posting objects (normal)</span>
<span style="color: #000000">16:22:07 task_gen posting &lt;task_gen '' of type task_gen defined in dir:///tmp/simpleproject&gt; 140631018237584</span>
<span style="color: #000000">16:22:07 task_gen -&gt; exec_rule (140631018237584)</span>
<span style="color: #000000">16:22:07 task_gen -&gt; process_source (140631018237584)</span>
<span style="color: #000000">16:22:07 task_gen -&gt; ping (140631018237584)</span>
<span style="color: #000000">ping</span>
<span style="color: #000000">16:22:07 task_gen posted</span>
<span style="color: #000000">16:22:07 task_gen posting &lt;task_gen '' of type task_gen defined in dir:///tmp/simpleproject&gt; 140631018237776</span>
<span style="color: #000000">16:22:07 task_gen -&gt; exec_rule (140631018237776)</span>
<span style="color: #000000">16:22:07 task_gen -&gt; process_source (140631018237776)</span>
<span style="color: #000000">16:22:07 task_gen -&gt; pong (140631018237776)</span>
<span style="color: #000000">pong</span>
<span style="color: #000000">16:22:07 task_gen -&gt; ping (140631018237776)</span>
<span style="color: #000000">ping</span>
<span style="color: #000000">16:22:07 task_gen posted</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">16:22:07 task_gen posting objects (normal)</span>
<span style="color: #000000">'build' finished successfully (0.005s)</span></tt></pre></div></div>
<div class="paragraph"><p>警告: タスクジェネレータのインスタンスは順番に処理されるが、タスクジェネレータのメソッドの実行には実行順序のための特別な宣言が必要だ。
ここではメソッド <em>pong</em> はメソッド <em>ping</em> の前に実行される。</p></div>
</div>
<div class="sect3">
<h4 id="_タスクジェネレータメソッドの実行順序">9.3.4. タスクジェネレータメソッドの実行順序</h4>
<div class="paragraph"><p>実行順序を制御するために、2つの新たなデコレータの追加が必要だ。
<em>method1</em> 、 <em>method2</em> の順序で実行される2つのタスクジェネレータのカスタムメソッドで新たな例を示す：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">myattr</span><span style="color: #000000">=</span><span style="color: #009900">'Hello, world!'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> TaskGen</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">before</span><span style="color: #000000">(</span><span style="color: #009900">'process_source'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'exec_rule'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">method1</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'method 1 %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'myattr'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">))</span>

<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">before</span><span style="color: #000000">(</span><span style="color: #009900">'process_source'</span><span style="color: #000000">)</span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">after</span><span style="color: #000000">(</span><span style="color: #009900">'method1'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">method2</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'method 2 %r'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'myattr'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">))</span></tt></pre></div></div>
<div class="paragraph"><p>実行結果の出力は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --zones=task_gen</span></span>
<span style="color: #000000">'distclean' finished successfully (0.003s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">15:54:02 task_gen posting objects (normal)</span>
<span style="color: #000000">15:54:02 task_gen posting &lt;task_gen of type task_gen defined in dir:///tmp/simpleproject&gt; 139808568487632</span>
<span style="color: #000000">15:54:02 task_gen -&gt; method1 (139808568487632)</span>
<span style="color: #000000">method 1 'Hello, world!'</span>
<span style="color: #000000">15:54:02 task_gen -&gt; exec_rule (139808568487632)</span>
<span style="color: #000000">15:54:02 task_gen -&gt; method2 (139808568487632)</span>
<span style="color: #000000">method 2 'Hello, world!'</span>
<span style="color: #000000">15:54:02 task_gen -&gt; process_source (139808568487632)</span>
<span style="color: #000000">15:54:02 task_gen posted</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/simpleproject/build'</span>
<span style="color: #000000">15:54:02 task_gen posting objects (normal)</span>
<span style="color: #000000">'build' finished successfully (0.005s)</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_実行のためのメソッドの追加および削除">9.3.5. 実行のためのメソッドの追加および削除</h4>
<div class="paragraph"><p>メソッドの順序制約(前/後)はアトリビュート <em>meths</em> のメソッドのリストのソートに使われる。
ソートは一度行われ、リストはメソッドが実行されるにともなって消費される。
最初のメソッドが実行されても新たなフィーチャーが追加されないこともあるが、新たなメソッドはself.methsに動的に追加される。
ここに、最後に同じメソッドを追加することで無限ループを作る方法を示す：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> feature</span>

<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">infinite_loop</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">meths</span><span style="color: #000000">.</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #009900">'infinite_loop'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>同様に、メソッドは実行されるメソッドのリストから削除することができる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> feature</span>

<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">before_method</span><span style="color: #000000">(</span><span style="color: #009900">'process_source'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">remove_process_source</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">meths</span><span style="color: #000000">.</span><span style="color: #000000">remove</span><span style="color: #000000">(</span><span style="color: #009900">'process_source'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>タスクジェネレータメソッドのワークフローは次の図で表現される：</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="posting.png" alt="タスクジェネレータワークフロー" />
</div>
</div>
</div>
<div class="sect3">
<h4 id="_タスクジェネレータ間の抽象的な依存関係の表現">9.3.6. タスクジェネレータ間の抽象的な依存関係の表現</h4>
<div class="paragraph"><p>タスクジェネレータオブジェクト間の抽象的な依存関係を表現するために使われるタスクジェネレータをどのように使うことができるかについてはここでは説明しない。
ここに新たなプロジェクトファイルが <em>/tmp/targets/</em> 以下にある：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo A'</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'A'</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo B'</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'B'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p><em>waf --targets=B</em> を実行することで、タスクジェネレータ <em>B</em> のみがそのタスクを生成し、実行結果の出力は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --targets=B</span></span>
<span style="color: #000000">'distclean' finished successfully (0.000s)</span>
<span style="color: #000000">'configure' finished successfully (0.042s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/targets/build'</span>
<span style="color: #000000">[1/1] B:</span>
<span style="color: #000000">B</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/targets/build'</span>
<span style="color: #000000">'build' finished successfully (0.032s)</span></tt></pre></div></div>
<div class="paragraph"><p>これは <em>B</em> が実行されたときにタスクジェネレータ <em>A</em> がタスクを生成することを保証する方法だ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo A'</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'A'</span><span style="color: #000000">)</span>
<span style="color: #000000">    </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'echo B'</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> name</span><span style="color: #000000">=</span><span style="color: #009900">'B'</span><span style="color: #000000">,</span><span style="color: #000000"> depends_on</span><span style="color: #000000">=</span><span style="color: #009900">'A'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> feature</span><span style="color: #000000">,</span><span style="color: #000000"> before_method</span>
<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">@</span><span style="color: #000000">before_method</span><span style="color: #000000">(</span><span style="color: #009900">'process_rule'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">post_the_other</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">    deps </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'depends_on'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">    </span><span style="color: #000080">for</span><span style="color: #000000"> name </span><span style="color: #000080">in</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">to_list</span><span style="color: #000000">(</span><span style="color: #000000">deps</span><span style="color: #000000">):</span>
<span style="color: #000000">        other </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">get_tgen_by_name</span><span style="color: #000000">(</span><span style="color: #000000">name</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'other task generator tasks (before) %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> other</span><span style="color: #000000">.</span><span style="color: #000000">tasks</span><span style="color: #000000">)</span>
<span style="color: #000000">        other</span><span style="color: #000000">.</span><span style="color: #000000">post</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        </span><span style="color: #000080">print</span><span style="color: #000000">(</span><span style="color: #009900">'other task generator tasks (after) %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> other</span><span style="color: #000000">.</span><span style="color: #000000">tasks</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
このメソッドはすべてのタスクジェネレータについてアトリビュート <tt>rule</tt> が処理される前に実行される
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
アトリビュート <tt>depends_on</tt> が存在するならば処理を試みる
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
名前によって同じバリアントのためのタスクジェネレータを獲得
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
他のタスクジェネレータにタスクを生成することを強制
</td></tr>
</table></div>
<div class="paragraph"><p>アウトプットは次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build --targets=B</span></span>
<span style="color: #000000">'distclean' finished successfully (0.001s)</span>
<span style="color: #000000">'configure' finished successfully (0.001s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/targets/build'</span>
<span style="color: #000000">other task generator tasks (before) [] <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">other task generator tasks (after) [ <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        {task: A  -&gt; }]</span>
<span style="color: #000000">[1/2] B:</span>
<span style="color: #000000">B</span>
<span style="color: #000000">[2/2] A: <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">A</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/targets/build'</span>
<span style="color: #000000">'build' finished successfully (0.014s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
他のタスクジェネレータはまだ何もタスクを生成していない
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
タスクジェネレータはそのすべてのタスクを <tt>post()</tt> を呼出すことで生成する。
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
<tt>--targets=B</tt> が必要とされるにも拘わらず、ターゲット <em>A</em> からのタスクは生成され実行される
</td></tr>
</table></div>
<div class="paragraph"><p>実際には、依存関係はしばしば他のタスクジェネレータから生成されたタスクオブジェクトを再利用する: ノード、コンフィギュレーションセット、など。
これはuselibシステムによって使われる(次の章のC/C++ビルドを参照).</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cとc_プロジェクト">10. CとC++プロジェクト</h2>
<div class="sectionbody">
<div class="paragraph"><p>Wafは言語ニュートラルであるが、CとC++プロジェクトに非常によく使われる。
この章ではこれらの言語に使われるWafツールと関数について述べる。</p></div>
<div class="sect2">
<h3 id="_c_c_dアプリケーションへの共通のスクリプト">10.1. C、C++、Dアプリケーションへの共通のスクリプト</h3>
<div class="sect3">
<h4 id="_前もって定義されたタスクジェネレータ">10.1.1. 前もって定義されたタスクジェネレータ</h4>
<div class="paragraph"><p>C/C++のビルドはソースファイルをオブジェクトファイルに変換(コンパイル)すること、そして最後にオブジェクトファイルをアセンブル(リンク)することから構成される。
理論的には、単一のプログラミング言語でどんなアプリケーションを書くのにも十分であるべきだが、通常、状況はより複雑だ：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
ソースファイルは他の言語で書かれたコンパイラ(IDL, ASN1など)から生成されることがある
</p>
</li>
<li>
<p>
追加のファイルがリンクの段階で入ってくる(ライブラリ、オブジェクトファイル)ことがあるし、アプリケーションは動的もしくは静的ライブラリに分割されうる
</p>
</li>
<li>
<p>
異なるプラットフォームでは異なる処理ルールが必要となる(MS-Windowsでのマニフェストファイルなど)
</p>
</li>
</ol></div>
<div class="paragraph"><p>実装の詳細を隠すこと、およびポータビリティーのため、次の例のようにそれぞれのターゲット(プログラム、ライブラリ)は単一のタスクジェネレータオブジェクトにラップすることができる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'app'</span><span style="color: #000000">,</span><span style="color: #000000"> use</span><span style="color: #000000">=</span><span style="color: #009900">'myshlib mystlib'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">stlib</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'a.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'mystlib'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">shlib</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'b.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'myshlib'</span><span style="color: #000000">,</span><span style="color: #000000"> use</span><span style="color: #000000">=</span><span style="color: #009900">'myobjects'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">objects</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'c.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'myobjects'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
Cルーチンをロードしコンパイラを見つけるためにcompiler_cを使う(C++では <em>compiler_cxx</em> 、D言語では <em>compiler_d</em>)
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
<em>main.c</em> と他の2つのライブラリを使って実行ファイルを宣言
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
スタティックライブラリの宣言
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
<em>myobjects</em> のオブジェクトファイルを使った共有ライブラリの宣言
</td></tr>
</table></div>
<div class="paragraph"><p>ターゲットはプラットフォームで異なる拡張子と名前を持つ。
例えば、Linuxではビルドディレクトリの中身は：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ tree build</span></span>
<span style="color: #000000">build/</span>
<span style="color: #000000">|-- c4che</span>
<span style="color: #000000">|   |-- build.config.py</span>
<span style="color: #000000">|   `-- _cache.py</span>
<span style="color: #000000">|-- a.c.1.o</span>
<span style="color: #000000">|-- app <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">|-- b.c.2.o</span>
<span style="color: #000000">|-- c.c.3.o</span>
<span style="color: #000000">|-- config.log</span>
<span style="color: #000000">|-- libmyshlib.so <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">|-- libmystlib.a</span>
<span style="color: #000000">`-- main.c.0.o <img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
実行ファイルはLinuxでは拡張子をもたないが、Windowsでは <em>.exe</em>
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
共有ライブラリの拡張子はLinuxでは <em>.so</em> 、Windowsでは <em>.dll</em>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
<em>.o</em> オブジェクトファイルはオリジナルのファイル名とインデックスを使って複数コンパイルでのエラーを避ける
</td></tr>
</table></div>
<div class="paragraph"><p>ビルドコンテキストのメソッド <em>program</em> 、 <em>shlib</em> 、 <em>stlib</em> と <em>objects</em> は単一のタスクジェネレータとソースリストで検知された適切なフィーチャーを返す。
例えば、ソースアトリビュートに <em>.c</em> ファイルを持つプログラムでは、追加されるフィーチャーは <em>"c cprogram"</em> で、 <em>d</em> の静的ライブラリでは <em>"d dstlib"</em> だ。</p></div>
</div>
<div class="sect3">
<h4 id="_追加のアトリビュート">10.1.2. 追加のアトリビュート</h4>
<div class="paragraph"><p>前述のメソッドは単に <em>use</em> 以外にも多くのアトリビュートを処理できる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">                source       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                target       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'appname'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                features     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'more'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'features'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">                includes     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                defines      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'LINUX=1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'BIDULE'</span><span style="color: #000000">],</span>

<span style="color: #000000">                lib          </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'m'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                libpath      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/lib'</span><span style="color: #000000">],</span>
<span style="color: #000000">                stlib        </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'dl'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>
<span style="color: #000000">                stlibpath    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/local/lib'</span><span style="color: #000000">],</span>
<span style="color: #000000">                linkflags    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">                rpath        </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/opt/kde/lib'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span>
<span style="color: #000000">                vnum         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'1.2.3'</span><span style="color: #000000">,</span>

<span style="color: #000000">                install_path </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${SOME_PATH}/bin'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/9.png" alt="9" /></span>
<span style="color: #000000">                cflags       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O2'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'-Wall'</span><span style="color: #000000">],</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/10.png" alt="10" /></span>
<span style="color: #000000">                cxxflags     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O3'</span><span style="color: #000000">],</span>
<span style="color: #000000">                dflags       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">],</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
ソースファイルのリスト
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ターゲット。プラットフォームやタイプに応じて自動的に <tt>target.exe</tt> や <tt>libtarget.so</tt> に変換される
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
追加するフィーチャー(Cのファイルからなるプログラムの場合、デフォルトは <em>'c cprogram'</em>)
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
includeとdefine
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
共有ライブラリと共有ライブラリのリンクパス
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
静的ライブラリとリンクパス
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
特定のリンクフラグのためにlinkflagsを使う(ライブラリには適用されない)
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
rpathとvnum。これらをサポートしないプラットフォームでは無視される
</td></tr>
<tr><td><img src="./callouts/9.png" alt="9" /></td><td>
プログラムと共有ライブラリはデフォルトでインストールされる。インストールを無効にするにはNoneにセット
</td></tr>
<tr><td><img src="./callouts/10.png" alt="10" /></td><td>
フラグをサポートするソースファイルに適用されるさまざまなフラグ(もし存在するならば)
</td></tr>
</table></div>
</div>
</div>
<div class="sect2">
<h3 id="_includeの処理">10.2. includeの処理</h3>
<div class="sect3">
<h4 id="_実行パスとフラグ">10.2.1. 実行パスとフラグ</h4>
<div class="paragraph"><p>インクルードパスはヘッダを探すためにC/C++コンパイラによって使われる。
ヘッダが変更されると、ファイルは自動的に再コンパイルされる。
例えば次のような構成のプロジェクトでは：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- foo.h</span>
<span style="color: #000000">|-- src</span>
<span style="color: #000000">|   |-- main.c</span>
<span style="color: #000000">|   `-- wscript</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="paragraph"><p>ファイル <em>src/wscript</em> は次のコードを含む：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">        source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">        target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'myapp'</span><span style="color: #000000">,</span>
<span style="color: #000000">        includes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.. .'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>コマンドライン(<tt>waf -v</tt> のアウトプット)は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">cc -I. -I.. -Isrc -I../src ../src/main.c -c -o src/main_1.o</span></tt></pre></div></div>
<div class="paragraph"><p>コマンドはビルドディレクトリから実行されるため、フォルダは次のようにインクルードフラグに変換される：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">.. -&gt; -I..      -I.</span>
<span style="color: #000000">.  -&gt; -I../src  -Isrc</span></tt></pre></div></div>
<div class="paragraph"><p>覚えておくべき重要な点がいくつかある：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
インクルードは常にwscriptファイルを含むディレクトリからの相対パスで与えられる
</p>
</li>
<li>
<p>
インクルードはタスクジェネレータバリアントのためにソースディレクトリと対応するビルドディレクトリを追加する
</p>
</li>
<li>
<p>
コマンドはビルドディレクトリから実行されるため、インクルードパスは変換されなくてはならない
</p>
</li>
<li>
<p>
システムのインクルードパスはconfigure中に定義されINCLUDES変数に追加される(uselib)
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_wafプリプロセッサ">10.2.2. Wafプリプロセッサ</h4>
<div class="paragraph"><p>Wafはヘッダの依存関係を追加するためにPythonで書かれたプリプロセッサを使う。
#include文を見るだけの単純なパーサでは次のような構造を見逃がしてしまう：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> mymacro </span><span style="color: #009900">"foo.h"</span>
<span style="font-weight: bold"><span style="color: #008080">#include</span></span><span style="color: #000000"> mymacro</span></tt></pre></div></div>
<div class="paragraph"><p>依存関係を見つけるためにコンパイラを使うのはQtのようなファイル処理を必要とするアプリケーションではうまくいかない。
Qtでは、拡張子 <em>.moc</em> の特別なインクルードファイルをビルドシステムが検知し、前もって生成しなくてはならない。
Cコンパイラはそのようなファイルをパースできない。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">#include</span></span><span style="color: #000000"> </span><span style="color: #009900">"foo.moc"</span></tt></pre></div></div>
<div class="paragraph"><p>デフォルトではシステムのヘッダは追跡されないため、Wafのプリプロセッサは次のように書かれた依存関係を見逃すかもしれない：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">#if</span></span><span style="color: #000000"> SOMEMACRO</span>
<span style="color: #000000">        </span><span style="color: #808080">/* an include in the project */</span>
<span style="font-weight: bold"><span style="color: #008080">        #include</span></span><span style="color: #000000"> </span><span style="color: #009900">"foo.h"</span>
<span style="font-weight: bold"><span style="color: #008080">#endif</span></span></tt></pre></div></div>
<div class="paragraph"><p>ポータブルでデバッグしやすいコードにするために、プロジェクトで使われるすべての条件を <em>config.h</em> ファイルに書き出すことを強く推奨する。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check</span><span style="color: #000000">(</span>
<span style="color: #000000">                fragment    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'int main() { return 0; }\n'</span><span style="color: #000000">,</span>
<span style="color: #000000">                define_name </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'FOO'</span><span style="color: #000000">,</span>
<span style="color: #000000">                mandatory   </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">write_config_header</span><span style="color: #000000">(</span><span style="color: #009900">'config.h'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>パフォーマンス上の理由から、デフォルトではシステムのヘッダの暗黙の依存関係は無視される。
次のコードはこれを有効にするために使われる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> c_preproc</span>
<span style="color: #000000">c_preproc</span><span style="color: #000000">.</span><span style="color: #000000">go_absolute </span><span style="color: #000000">=</span><span style="color: #000000"> True</span></tt></pre></div></div>
<div class="paragraph"><p><a href="http://code.google.com/p/waf/source/browse/trunk/waflib/extras/gccdeps.py">gccdeps</a> や <a href="http://code.google.com/p/waf/source/browse/trunk/waflib/extras/dumbpreproc.py">dumbpreproc</a> などのツールは代替的な依存関係のスキャナを提供し、あるケース(boost)においてより高速だ。</p></div>
<div class="paragraph"><p>備考: Wafエンジンはタスクがコンパイルに必要なヘッダを生成しビルド順序を計算するか否かを検知する。ヘッダを生成するタスクがヒント <em>ext_out=[".h"]</em> を提供するならばスキャナのパフォーマンスが改善されることもある</p></div>
</div>
<div class="sect3">
<h4 id="_依存関係のデバッグ">10.2.3. 依存関係のデバッグ</h4>
<div class="paragraph"><p>Wafプリプロセッサは特定のデバッグゾーンを含む：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --zones=preproc</span></span></tt></pre></div></div>
<div class="paragraph"><p>獲得したもしくは見逃された依存関係を表示するには、次を使う：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --zones=deps</span></span>

<span style="color: #000000">23:53:21 deps deps for src:///comp/waf/demos/qt4/src/window.cpp: <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">  [src:///comp/waf/demos/qt4/src/window.h, bld:///comp/waf/demos/qt4/src/window.moc]; <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">  unresolved ['QtGui', 'QGLWidget', 'QWidget'] <img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
プリプロセスされたファイル
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
見つかったヘッダ
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
廃棄されたシステムヘッダ
</td></tr>
</table></div>
<div class="paragraph"><p>依存関係の計算はファイルが最新ではないときにのみ行われ、これらのコマンドはコンパイルすべきファイルが存在するときにのみ表示を行う。</p></div>
<div class="paragraph"><p>備考: スキャナはCファイルや依存関係が変化したときにのみ呼ばれる。 コンパイルが成功した後でヘッダを追加するまれなケースでは、フルスキャンを強制的に行うために <em>waf clean build</em> を実行する必要があるかもしれない</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_ライブラリの相互作用_use">10.3. ライブラリの相互作用(use)</h3>
<div class="sect3">
<h4 id="_ローカルライブラリ">10.3.1. ローカルライブラリ</h4>
<div class="paragraph"><p>アトリビュート <em>use</em> は(静的もしくは共有)ライブラリとのリンクを有効にし、参照されるタスクジェネレータがライブラリでない場合、オブジェクトファイルを含めることを有効にする。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">stlib</span><span style="color: #000000">(</span>
<span style="color: #000000">                source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test_staticlib.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'mylib'</span><span style="color: #000000">,</span>
<span style="color: #000000">                name     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'stlib1'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">                source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'app'</span><span style="color: #000000">,</span>
<span style="color: #000000">                includes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'stlib1'</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
nameアトリビュートは正確に一つのタスクジェネレータを指し示さなくてはならない
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
アトリビュート <em>use</em> は使うタスクジェネレータの名前を含む
</td></tr>
</table></div>
<div class="paragraph"><p>この例では、<em>mylib</em> が変更されるとファイル <em>app</em> は再度生成される(順序と依存関係)。
タスクジェネレータの名前を使うことで、実行形式とライブラリの宣言はどのような順序で行ってもよい。
利便性のために、名前は定義する必要はなく、ターゲットの名前から前もってセットされる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">stlib</span><span style="color: #000000">(</span>
<span style="color: #000000">                source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test_staticlib.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'mylib'</span><span style="color: #000000">)</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">                source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'app'</span><span style="color: #000000">,</span>
<span style="color: #000000">                includes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'mylib'</span><span style="color: #000000">])</span></tt></pre></div></div>
<div class="paragraph"><p>また、 <em>use</em> は再帰的な振舞いの処理を禁止している。
これを次の例で示そう：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">shlib</span><span style="color: #000000">(</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'a.c'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'lib1'</span><span style="color: #000000">)</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">stlib</span><span style="color: #000000">(</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'b.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cshlib'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'lib2'</span><span style="color: #000000">)</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">shlib</span><span style="color: #000000">(</span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'c.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'lib3'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'lib1 lib2'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'app'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'lib3'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
単純な共有ライブラリ
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
<em>cshlib</em> フラグはライブラリと実行形式両方に伝搬する。 <span class="footnote"><br />[伝搬を防ぐには <a href="http://code.google.com/p/waf/source/browse/trunk/docs/book/examples/cprog_propagation/wscript">http://code.google.com/p/waf/source/browse/trunk/docs/book/examples/cprog_propagation/wscript</a> を参照]<br /></span>
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
<em>lib3</em> は共有ライブラリと静的ライブラリを使う
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
実行形式は <em>lib3</em> を使う
</td></tr>
</table></div>
<div class="paragraph"><p>共有ライブラリの依存関係 <em>lib1</em> → <em>lib2</em> のため、実行形式 <em>app</em> は <em>lib1</em> と <em>lib3</em> に対してリンクされるが、 <em>lib2</em> に対してはリンクされない：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf -v</span></span>
<span style="color: #000000">'clean' finished successfully (0.004s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/cprog_propagation/build'</span>
<span style="color: #000000">[1/8] c: a.c -&gt; build/a.c.0.o</span>
<span style="color: #000000">12:36:17 runner ['/usr/bin/gcc', '-fPIC', '../a.c', '-c', '-o', 'a.c.0.o']</span>
<span style="color: #000000">[2/8] c: b.c -&gt; build/b.c.1.o</span>
<span style="color: #000000">12:36:17 runner ['/usr/bin/gcc', '../b.c', '-c', '-o', 'b.c.1.o']</span>
<span style="color: #000000">[3/8] c: c.c -&gt; build/c.c.2.o</span>
<span style="color: #000000">12:36:17 runner ['/usr/bin/gcc', '-fPIC', '../c.c', '-c', '-o', 'c.c.2.o']</span>
<span style="color: #000000">[4/8] c: main.c -&gt; build/main.c.3.o</span>
<span style="color: #000000">12:36:17 runner ['/usr/bin/gcc', '../main.c', '-c', '-o', 'main.c.3.o']</span>
<span style="color: #000000">[5/8] cstlib: build/b.c.1.o -&gt; build/liblib2.a</span>
<span style="color: #000000">12:36:17 runner ['/usr/bin/ar', 'rcs', 'liblib2.a', 'b.c.1.o']</span>
<span style="color: #000000">[6/8] cshlib: build/a.c.0.o -&gt; build/liblib1.so</span>
<span style="color: #000000">12:36:17 runner ['/usr/bin/gcc', 'a.c.0.o', '-o', 'liblib1.so', '-shared']</span>
<span style="color: #000000">[7/8] cshlib: build/c.c.2.o -&gt; build/liblib3.so</span>
<span style="color: #000000">12:36:17 runner ['/usr/bin/gcc', 'c.c.2.o', '-o', 'liblib3.so', '-Wl,-Bstatic', '-L.', '-llib2', '-Wl,-Bdynamic', '-L.', '-llib1', '-shared']</span>
<span style="color: #000000">[8/8] cprogram: build/main.c.3.o -&gt; build/app</span>
<span style="color: #000000">12:36:17 runner ['/usr/bin/gcc', 'main.c.3.o', '-o', 'app', '-Wl,-Bdynamic', '-L.', '-llib1', '-llib3']</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/cprog_propagation/build'</span>
<span style="color: #000000">'build' finished successfully (0.144s)</span></tt></pre></div></div>
<div class="paragraph"><p><em>use</em> アトリビュートの最も重要な点をまとめると：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
タスクジェネレータを異なるファイルにどのような順序でも作ることができるが、<em>use</em> アトリビュートのためにユニークな名前をつけなくてはならない
</p>
</li>
<li>
<p>
<em>use</em> の処理は必要なすべてのタスジクジェネレータに対して再帰的に処理するが、追加されたフラグはターゲットの種類(共有/静的ライブラリ)に依存する
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_特別なローカルライブラリ">10.3.2. 特別なローカルライブラリ</h4>
<div class="sect4">
<h5 id="_includeフォルダ">includeフォルダ</h5>
<div class="paragraph"><p>useキーワードは実際にはターゲットを宣言しない特別なライブラリ指定することができる。
例えば、ヘッダのみのライブラリは複数のターゲットに対して共通のインクルードパスを追加することで使われる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">                includes        </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'. src'</span><span style="color: #000000">,</span>
<span style="color: #000000">                export_includes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'src'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                name            </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'com_includes'</span><span style="color: #000000">)</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">stlib</span><span style="color: #000000">(</span>
<span style="color: #000000">                source          </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'a.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target          </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'shlib1'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use             </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'com_includes'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">                source          </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target          </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'app'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use             </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'shlib1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
<em>includes</em> アトリビュートはプライベートであるが、 <em>export_includes</em> は他のタスクジェネレータによって使われる
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
パスは他のタスクジェネレータに対する相対パスとして追加される
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
<em>export_includes</em> は他のタスクジェネレータにも伝搬する
</td></tr>
</table></div>
</div>
<div class="sect4">
<h5 id="_オブジェクトファイル">オブジェクトファイル</h5>
<div class="paragraph"><p>これは特定のファイルに対して特別なコンパイルフラグを有効にする方法だ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">objects</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">                source  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                cflags  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'-O3'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'my_objs'</span><span style="color: #000000">)</span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">shlib</span><span style="color: #000000">(</span>
<span style="color: #000000">                source  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'a.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                cflags  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'-O2'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                target  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'lib1'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'my_objs'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">                source  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test_c_program'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'lib1'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
ファイルはCモードでコンパイルされるが、実行形式もライブラリも生成されない
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
異なるコンパイルフラグが使われる
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
オブジェクトは自動的にリンクステージで追加される
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
シンボルの重複エラーを回避するために、オブジェクトは他の実行形式やライブラリには伝搬しない
</td></tr>
</table></div>
<div class="paragraph"><p>警告: 静的ライブラリのように、オブジェクトファイルはバイナリコードをコピーアンドペーストするために乱用されがちだ。可能ならば常に共有ライブラリを使うことで実行ファイルのサイズを最小化しよう。</p></div>
</div>
<div class="sect4">
<h5 id="_フェイクライブラリ">フェイクライブラリ</h5>
<div class="paragraph"><p>ローカルライブラリは変更されると再コンパイルをトリガーする。
メソッド <em>read_shlib</em> と <em>read_stlib</em> はこの振舞いを外部のライブラリやプロジェクトに存在するバイナリファイルに追加するために使うことができる。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">read_shlib</span><span style="color: #000000">(</span><span style="color: #009900">'m'</span><span style="color: #000000">,</span><span style="color: #000000"> paths</span><span style="color: #000000">=[</span><span style="color: #009900">'.'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'/usr/lib64'</span><span style="color: #000000">])</span>
<span style="color: #000000">        bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'app'</span><span style="color: #000000">,</span><span style="color: #000000"> use</span><span style="color: #000000">=</span><span style="color: #009900">'m'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>このメソッドは必要なパスと依存関係を計算するために、指定されたパスにある <em>libm.so</em> や <em>libm.dll</em> のようなファイルを探す。
この例では、 <em>/usr/lib64/libm.so</em> が変更されるとターゲット <em>app</em> は再度生成される。
ローカルで宣言された共有ライブラリや静的ライブラリのように、これらのライブラリはタスクジェネレータ間を伝搬する。</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_外部ライブラリとフラグ">10.3.3. 外部ライブラリとフラグ</h4>
<div class="paragraph"><p>アトリビュート <em>use</em> の要素がローカルライブラリにマッチしない場合、システムライブラリを表現し、必要なフラグはコンフィギュレーションセット <em>env</em> に存在することが想定される。
このシステムは、次の例のように、いくつかのコンパイルフラグとリンクフラグを一度に追加する：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> sys</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">INCLUDES_TEST      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/include'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> sys</span><span style="color: #000000">.</span><span style="color: #000000">platform </span><span style="color: #000000">!=</span><span style="color: #000000"> </span><span style="color: #009900">'win32'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">DEFINES_TEST   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'TEST'</span><span style="color: #000000">]</span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CFLAGS_TEST   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O0'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">LIB_TEST       </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'m'</span><span style="color: #000000">]</span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">LIBPATH_TEST   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/lib'</span><span style="color: #000000">]</span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">LINKFLAGS_TEST </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-g'</span><span style="color: #000000">]</span>
<span style="color: #000000">                conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">INCLUDES_TEST  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/opt/gnome/include'</span><span style="color: #000000">]</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        mylib </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">stlib</span><span style="color: #000000">(</span>
<span style="color: #000000">                source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test_staticlib.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">                target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'teststaticlib'</span><span style="color: #000000">,</span>
<span style="color: #000000">                use      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'TEST'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> mylib</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CC_NAME </span><span style="color: #000000">==</span><span style="color: #000000"> </span><span style="color: #009900">'gcc'</span><span style="color: #000000">:</span>
<span style="color: #000000">                mylib</span><span style="color: #000000">.</span><span style="color: #000000">cxxflags </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-O2'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
移植性の理由から、-I/includeのような形態でフラグを与える替わりにINCLUDESを使うことが推奨される。INCLUDESはCとC++両方から使われることに注意
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
プラットフォーム固有の設定でundefinedとなりうる変数。しかしながらビルドスクリプトは同一のままだ。
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
configureでいくつかの変数を宣言する。変数はVAR_NAMEの慣習に従う
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
<em>use variable</em> NAMEに対応するすべてのVAR_NAMEを追加。この例では <em>TEST</em>
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
<em>避けるべきモデル</em>: フラグの設定およびconfigureのチェックはconfigureセクションで行われるべきだ
</td></tr>
</table></div>
<div class="paragraph"><p>C/C++のための変数は次のようになる：</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 1. C/C++用の変数とタスクジェネレータのアトリビュートの使用</caption>
<col width="20%" />
<col width="20%" />
<col width="60%" />
<thead>
<tr>
<th align="left" valign="top">Uselib変数 </th>
<th align="left" valign="top"> アトリビュート </th>
<th align="left" valign="top"> 用法</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">LIB</p></td>
<td align="left" valign="top"><p class="table">lib</p></td>
<td align="left" valign="top"><p class="table">プレフィックスや拡張子のついていない使用する共有ライブラリ名のリスト</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">LIBPATH</p></td>
<td align="left" valign="top"><p class="table">libpath</p></td>
<td align="left" valign="top"><p class="table">共有ライラリのサーチパスのリスト</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">STLIB</p></td>
<td align="left" valign="top"><p class="table">stlib</p></td>
<td align="left" valign="top"><p class="table">プレフィックスや拡張子のついていない使用する静的ライブラリ名のリスト</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">STLIBPATH</p></td>
<td align="left" valign="top"><p class="table">stlibpath</p></td>
<td align="left" valign="top"><p class="table">静的ライブラリのサーチパスのリスト</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">LINKFLAGS</p></td>
<td align="left" valign="top"><p class="table">linkflags</p></td>
<td align="left" valign="top"><p class="table">リンクフラグのリスト(可能ならば他の変数を使った方がよい)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">RPATH</p></td>
<td align="left" valign="top"><p class="table">rpath</p></td>
<td align="left" valign="top"><p class="table">リンク時にバイナリにハードコードされるパスのリスト</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CFLAGS</p></td>
<td align="left" valign="top"><p class="table">cflags</p></td>
<td align="left" valign="top"><p class="table">Cファイル用のコンパイルフラグのリスト</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CXXFLAGS</p></td>
<td align="left" valign="top"><p class="table">cxxflags</p></td>
<td align="left" valign="top"><p class="table">C++ファイル用のコンパイルフラグのリスト</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">DFLAGS</p></td>
<td align="left" valign="top"><p class="table">dflags</p></td>
<td align="left" valign="top"><p class="table">D言語用のコンパイルフラグのリスト</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">INCLUDES</p></td>
<td align="left" valign="top"><p class="table">includes</p></td>
<td align="left" valign="top"><p class="table">インクルードパス</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CXXDEPS</p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">変更されたときにC++の再コンパイルをトリガーする変数/リスト</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CCDEPS</p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">変更されたときにCの再コンパイルをトリガーする変数/リスト</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">LINKDEPS</p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">変更されたときに再リンクをトリガーする変数/リスト</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">DEFINES</p></td>
<td align="left" valign="top"><p class="table">defines</p></td>
<td align="left" valign="top"><p class="table">defineのリスト in the form [&#8216;key=value&#8217;, &#8230;]</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">FRAMEWORK</p></td>
<td align="left" valign="top"><p class="table">framework</p></td>
<td align="left" valign="top"><p class="table">使用するフレームワークのリスト</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">FRAMEWORKPATH</p></td>
<td align="left" valign="top"><p class="table">frameworkpath</p></td>
<td align="left" valign="top"><p class="table">使用するフレームワークへのパスのリスト</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">ARCH</p></td>
<td align="left" valign="top"><p class="table">arch</p></td>
<td align="left" valign="top"><p class="table">アーキテクチャのリスト in the form [<em>ppc</em>, <em>x86</em>]</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>後の使用のために変数を空にすることができるが、エラーは起こらない。
開発中は、異なるconfigureを試すために、プロジェクト全体の再configureをすることなくコンフィギュレーションキャッシュファイル(例えば、_cache.py)をテキストエディタから変更することができるが、影響を受けるファイルはリビルドされる。</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_configureのヘルパ">10.4. configureのヘルパ</h3>
<div class="sect3">
<h4 id="_コンフィギュレーションテスト">10.4.1. コンフィギュレーションテスト</h4>
<div class="paragraph"><p>メソッド <em>check</em> は小さなビルドプロジェクトを使うパラメータの検知に使われる。
主なパラメータは次のようになる</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
msg: 実行するテストのタイトル
</p>
</li>
<li>
<p>
okmsg: テストが成功したときに表示するメッセージ
</p>
</li>
<li>
<p>
errmsg: テストが失敗したときに表示するメッセージ
</p>
</li>
<li>
<p>
env: ビルドのために使用する環境(conf.envはデフォルトで使われる)
</p>
</li>
<li>
<p>
compile_mode: <em>cc</em> もしくは <em>cxx</em>
</p>
</li>
<li>
<p>
define_name: テストが成功ときにコンフィギュレーションヘッダ用のdefineを追加(ほとんどの場合、自動的に計算される)
</p>
</li>
</ol></div>
<div class="paragraph"><p>発生する例外は <em>waflib.Errors.ConfigurationError</em> のインスタンスだ。
リターンコードはない。</p></div>
<div class="paragraph"><p>主要なパラメータの他に、C/C++のタスクジェネレータのアトリビュートが使われる。
ここに完全な例を示す：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check</span><span style="color: #000000">(</span><span style="color: #000000">header_name</span><span style="color: #000000">=</span><span style="color: #009900">'time.h'</span><span style="color: #000000">,</span><span style="color: #000000"> features</span><span style="color: #000000">=</span><span style="color: #009900">'c cprogram'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cc</span><span style="color: #000000">(</span><span style="color: #000000">function_name</span><span style="color: #000000">=</span><span style="color: #009900">'printf'</span><span style="color: #000000">,</span><span style="color: #000000"> header_name</span><span style="color: #000000">=</span><span style="color: #009900">"stdio.h"</span><span style="color: #000000">,</span><span style="color: #000000"> mandatory</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cc</span><span style="color: #000000">(</span><span style="color: #000000">fragment</span><span style="color: #000000">=</span><span style="color: #009900">'int main() {2+2==4;}\n'</span><span style="color: #000000">,</span><span style="color: #000000"> define_name</span><span style="color: #000000">=</span><span style="color: #009900">"boobah"</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cc</span><span style="color: #000000">(</span><span style="color: #000000">lib</span><span style="color: #000000">=</span><span style="color: #009900">'m'</span><span style="color: #000000">,</span><span style="color: #000000"> cflags</span><span style="color: #000000">=</span><span style="color: #009900">'-Wall'</span><span style="color: #000000">,</span><span style="color: #000000"> defines</span><span style="color: #000000">=[</span><span style="color: #009900">'var=foo'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'x=y'</span><span style="color: #000000">],</span>
<span style="color: #000000">                uselib_store</span><span style="color: #000000">=</span><span style="color: #009900">'M'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cxx</span><span style="color: #000000">(</span><span style="color: #000000">lib</span><span style="color: #000000">=</span><span style="color: #009900">'linux'</span><span style="color: #000000">,</span><span style="color: #000000"> use</span><span style="color: #000000">=</span><span style="color: #009900">'M'</span><span style="color: #000000">,</span><span style="color: #000000"> cxxflags</span><span style="color: #000000">=</span><span style="color: #009900">'-O2'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cc</span><span style="color: #000000">(</span><span style="color: #000000">fragment</span><span style="color: #000000">=</span><span style="color: #009900">'''</span>
<span style="color: #009900">                        #include &lt;stdio.h&gt;</span>
<span style="color: #009900">                        int main() { printf("4"); return 0; } '''</span><span style="color: #000000">,</span>
<span style="color: #000000">                define_name </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">"booeah"</span><span style="color: #000000">,</span>
<span style="color: #000000">                execute     </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span>
<span style="color: #000000">                define_ret  </span><span style="color: #000000">=</span><span style="color: #000000"> True</span><span style="color: #000000">,</span>
<span style="color: #000000">                msg         </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">"Checking for something"</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'c'</span><span style="color: #000000">,</span><span style="color: #000000"> fragment</span><span style="color: #000000">=</span><span style="color: #009900">'int main(){return 0;}'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">write_config_header</span><span style="color: #000000">(</span><span style="color: #009900">'config.h'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
システムに存在するならば、コンフィギュレーションヘッダtime.hを用いてコンパイルを試行し、テストが成功すればdefine HAVE_TIME_Hが追加される
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ヘッダstdio.hを追加し関数printfを使ってコンパイルを試行(header_nameは追加されるヘッダのリストでもよい)。デフォルトですべてのコンフィギュレーションテストが必要で(@confメソッド)、コンフィギュレーション例外を発生する。隠すためにはアトリビュート <em>mandatory</em> をFalseにセット。
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
コードの断片のコンパイルを試行し、テストが成功すればboobahが定義される
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
タスクジェネレータ環境への変更は保存されない。テストが成功しアトリビュートuselib_storeが与えられているとき、lib、cflagsとdefinesは<em>use variables</em> LIB_MとCFLAGS_M、DEFINES_Mに変換され、フラグの値はコンフィギュレーション環境に追加される。
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
<em>linux</em> と呼ばれるライブラリに対して単純なCのプログラムのコンパイルを試行し、 <em>use</em> でlibm用のパラメータを再利用する
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
単純なプログラムを実行し、成功したらアウトプットを収集してdefineにつっこむ
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
単一のタスクジェネレータによってテストがビルドを作る。 <em>features</em> アトリビュートを直接渡すことでコンパイルを無効にしたり、より複雑なコンフィギュレーションテストを作ることができる。
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
すべてのテストが実行された後で、コンフィギュレーションヘッダをビルドディレクトリに書き出す(optional)。コンフィギュレーションヘッダはコマンドラインのサイズを制限するために使われる。
</td></tr>
</table></div>
<div class="paragraph"><p>ここに前掲のテストコードによって生成された <tt>config.h</tt> の例を示す：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #808080">/* Configuration header created by Waf - do not edit */</span>
<span style="font-weight: bold"><span style="color: #008080">#ifndef</span></span><span style="color: #000000"> _CONFIG_H_WAF</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> _CONFIG_H_WAF</span>

<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> HAVE_PRINTF </span><span style="color: #000000">1</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> HAVE_TIME_H </span><span style="color: #000000">1</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> boobah </span><span style="color: #000000">1</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> booeah </span><span style="color: #009900">"4"</span>

<span style="font-weight: bold"><span style="color: #008080">#endif</span></span><span style="color: #000000"> </span><span style="color: #808080">/* _CONFIG_H_WAF */</span></tt></pre></div></div>
<div class="paragraph"><p>ファイル <tt>_cache.py</tt> は次の変数を含む：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">DEFINES_M </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'var=foo'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'x=y'</span><span style="color: #000000">]</span>
<span style="color: #000000">CXXFLAGS_M </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-Wall'</span><span style="color: #000000">]</span>
<span style="color: #000000">CFLAGS_M </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-Wall'</span><span style="color: #000000">]</span>
<span style="color: #000000">LIB_M </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'m'</span><span style="color: #000000">]</span>
<span style="color: #000000">boobah </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">1</span>
<span style="color: #000000">booeah </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'4'</span>
<span style="color: #000000">defines </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">{</span><span style="color: #009900">'booeah'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #009900">'"4"'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'boobah'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_TIME_H'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_PRINTF'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">}</span>
<span style="color: #000000">dep_files </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'config.h'</span><span style="color: #000000">]</span>
<span style="color: #000000">waf_config_files </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/compilation/waf/demos/adv/build/config.h'</span><span style="color: #000000">]</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_アドバンステスト">10.4.2. アドバンステスト</h4>
<div class="paragraph"><p>メソッド <em>conf.check</em> はビルドコンテキストとタスクジェネレータを内部的に作る。これはアトリビュート <em>includes</em> 、 <em>defines</em> 、 <em>cxxflags</em> が使われうることを意味する(これですべてではない)。
アドバンステストはフィーチャー引数を渡すことによって作られる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> feature</span><span style="color: #000000">,</span><span style="color: #000000"> before_method</span>

<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'special_test'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">before_method</span><span style="color: #000000">(</span><span style="color: #009900">'process_source'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">my_special_test</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'foo'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'bar'</span><span style="color: #000000">)</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cc</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'special_test'</span><span style="color: #000000">,</span><span style="color: #000000"> msg</span><span style="color: #000000">=</span><span style="color: #009900">'my test!'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
別のタスクジェネレータからタスクジェネレータを生成
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
<tt>test.c</tt> sourceに空のリストをセットすることで <tt>test.c</tt> のコンパイルを無効にする
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
special_testフィーチャーを使う
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_コンフィギュレーションヘッダの作成">10.4.3. コンフィギュレーションヘッダの作成</h4>
<div class="paragraph"><p>大量のdefineの値をコマンドラインに追加すると、コマンドラインのサイズが増加し有用な情報が隠される(differences)。
いくつかのプロジェクトはconfigureで生成されたヘッダを使い、それらはビルド中に変更されないしインストールも再頒布もされない。
このシステムは巨大なプロジェクトに有効で、autoconfに基づいたプロジェクトで一般的だ。</p></div>
<div class="paragraph"><p>コンフィギュレーションヘッダの書き出しは次のメソッドを使うことで行える：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">define</span><span style="color: #000000">(</span><span style="color: #009900">'NOLIBF'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">undefine</span><span style="color: #000000">(</span><span style="color: #009900">'NOLIBF'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">define</span><span style="color: #000000">(</span><span style="color: #009900">'LIBF'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">define</span><span style="color: #000000">(</span><span style="color: #009900">'LIBF_VERSION'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'1.0.2'</span><span style="color: #000000">)</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">write_config_header</span><span style="color: #000000">(</span><span style="color: #009900">'config.h'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>このコードスニペットはビルドディレクトリに次のように <em>config.h</em> を生成する：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">build/</span>
<span style="color: #000000">|-- c4che</span>
<span style="color: #000000">|   |-- build.config.py</span>
<span style="color: #000000">|   `-- _cache.py</span>
<span style="color: #000000">|-- config.log</span>
<span style="color: #000000">`-- config.h</span></tt></pre></div></div>
<div class="paragraph"><p>この例のconfig.hの中身は:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #808080">/* Configuration header created by Waf - do not edit */</span>
<span style="font-weight: bold"><span style="color: #008080">#ifndef</span></span><span style="color: #000000"> _CONFIG_H_WAF</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> _CONFIG_H_WAF</span>

<span style="color: #808080">/* #undef NOLIBF */</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> LIBF </span><span style="color: #000000">1</span>
<span style="font-weight: bold"><span style="color: #008080">#define</span></span><span style="color: #000000"> LIBF_VERSION </span><span style="color: #009900">"1.0.2"</span>

<span style="font-weight: bold"><span style="color: #008080">#endif</span></span><span style="color: #000000"> </span><span style="color: #808080">/* _CONFIG_H_WAF */</span></tt></pre></div></div>
<div class="paragraph"><p>備考: デフォルトでは、defineはコマンドラインからコンフィギュレーションヘッダに移動する。これはオペレーションによってアトリビュート <em>conf.env.DEFINE</em> が作られることを意味する。この振舞いを阻止するには、 <em>conf.write_config_header(remove=False)</em> を使う</p></div>
</div>
<div class="sect3">
<h4 id="_pkg_config">10.4.4. Pkg-config</h4>
<div class="paragraph"><p>依存するすべてのプロジェクトのコンフィギュレーションを検出する替わりに、コンフィギュレーションファイルはライブラリがインストールされたときに書き出される。
(データベースやAPIに問い合せることのできない)Makeに基づいたビルドシステムとのインタラクションを簡単にするために、キャッシュファイルを読み込み、 <a href="http://pkg-config.freedesktop.org/wiki/">pkg-config</a> やwx-config、sdl-configなどのパラメータ(伝統的に <em>-config</em> で終わる名前)を解釈するために小さなアプリケーションが作られた。</p></div>
<div class="paragraph"><p>メソッド <em>check_cfg</em> はこれらのアプリケーションとのインタラクションを簡単にするために提供されている。
ここにいくつかの例を示す：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">        opt</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">atleast_pkgconfig_version</span><span style="color: #000000">=</span><span style="color: #009900">'0.0.0'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        pango_version </span><span style="color: #000000">=</span><span style="color: #000000"> conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">modversion</span><span style="color: #000000">=</span><span style="color: #009900">'pango'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">package</span><span style="color: #000000">=</span><span style="color: #009900">'pango'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">package</span><span style="color: #000000">=</span><span style="color: #009900">'pango'</span><span style="color: #000000">,</span><span style="color: #000000"> uselib_store</span><span style="color: #000000">=</span><span style="color: #009900">'MYPANGO'</span><span style="color: #000000">,</span>
<span style="color: #000000">                args</span><span style="color: #000000">=[</span><span style="color: #009900">'--cflags'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'--libs'</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">package</span><span style="color: #000000">=</span><span style="color: #009900">'pango'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                args</span><span style="color: #000000">=[</span><span style="color: #009900">'pango &gt;= 0.1.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'pango &lt; 9.9.9'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'--cflags'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'--libs'</span><span style="color: #000000">],</span>
<span style="color: #000000">                msg</span><span style="color: #000000">=</span><span style="color: #009900">"Checking for 'pango 0.1.0'"</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">path</span><span style="color: #000000">=</span><span style="color: #009900">'sdl-config'</span><span style="color: #000000">,</span><span style="color: #000000"> args</span><span style="color: #000000">=</span><span style="color: #009900">'--cflags --libs'</span><span style="color: #000000">,</span>
<span style="color: #000000">                package</span><span style="color: #000000">=</span><span style="color: #009900">''</span><span style="color: #000000">,</span><span style="color: #000000"> uselib_store</span><span style="color: #000000">=</span><span style="color: #009900">'SDL'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">        conf</span><span style="color: #000000">.</span><span style="color: #000000">check_cfg</span><span style="color: #000000">(</span><span style="color: #000000">path</span><span style="color: #000000">=</span><span style="color: #009900">'mpicc'</span><span style="color: #000000">,</span><span style="color: #000000"> args</span><span style="color: #000000">=</span><span style="color: #009900">'--showme:compile --showme:link'</span><span style="color: #000000">,</span>
<span style="color: #000000">                package</span><span style="color: #000000">=</span><span style="color: #009900">''</span><span style="color: #000000">,</span><span style="color: #000000"> uselib_store</span><span style="color: #000000">=</span><span style="color: #009900">'OPEN_MPI'</span><span style="color: #000000">,</span><span style="color: #000000"> mandatory</span><span style="color: #000000">=</span><span style="color: #000000">False</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
pkg-configのバージョンをチェック
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
パッケージ向のモジュールのバージョンを文字列として検索。エラーがないならば、 <em>PANGO_VERSION</em> が定義される。アトリビュート <em>uselib_store='MYPANGO'</em> によって上書きできる。
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
pangoパッケージが存在するか否かをチェックし、 <em>HAVE_PANGO</em> を定義する(パッケージ名から自動的に計算される)
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
<em>HAVE_MYPANGO</em> を定義すると伴に, 関係するフラグを抽出し <em>use variable</em> MYPANGO (<em>LIB_MYPANGO</em>, <em>LIBPATH_MYPANGO</em> など)に格納する
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
前のテストと同様だが、特定のバージョン番号を強制するためのpkg-config節を追加
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
アウトプットにカスタムのメッセージを表示。アトリビュート <em>okmsg</em> と <em>errmsg</em> はそれぞれ成功および失敗したときに表示するメッセージを表す
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
sdl-config向けのフラグを取得。この例はwx-configやpcre-configなどの他のコンフィギュレーションプログラムにも適用できる
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
実行されるプログラムが見つからないときや終了ステータスがゼロでないときに発生するコンフィギュレーションエラーを抑制する
</td></tr>
</table></div>
<div class="paragraph"><p>フラグが大量で、アプリケーション間のコンフィグに標準が欠けており、コンパイラ依存のフラグ(gccでは -I、msvcでは /I)のため、pkg-configのアウトプットは対応する <em>use variables</em> を設定する前にパースされる。
Wafモジュールc_config.pyの関数 <em>parse_flags(line, uselib, env)</em> はフラグの抽出を行う。</p></div>
<div class="paragraph"><p>アウトプットはビルドディレクトリのファイル <em>config.log</em> に書き出される：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399"># project  configured on Tue Aug 31 17:30:21 2010 by</span></span>
<span style="font-weight: bold"><span style="color: #993399"># waf 1.6.10 (abi 98, python 20605f0 on linux2)</span></span>
<span style="font-weight: bold"><span style="color: #993399"># using /home/waf/bin/waf configure</span></span>
<span style="font-weight: bold"><span style="color: #993399">#</span></span>
<span style="color: #000000">---</span>
<span style="color: #000000">Setting top to</span>
<span style="color: #000000">/disk/comp/waf/docs/book/examples/cprog_pkgconfig</span>
<span style="color: #000000">---</span>
<span style="color: #000000">Setting out to</span>
<span style="color: #000000">/disk/comp/waf/docs/book/examples/cprog_pkgconfig/build</span>
<span style="color: #000000">---</span>
<span style="color: #000000">Checking for program pkg-config</span>
<span style="color: #000000">/usr/bin/pkg-config</span>
<span style="color: #000000">find program=['pkg-config'] paths=['/usr/local/bin', '/usr/bin'] var='PKGCONFIG' -&gt; '/usr/bin/pkg-config'</span>
<span style="color: #000000">---</span>
<span style="color: #000000">Checking for pkg-config version &gt;= 0.0.0</span>
<span style="color: #000000">['/usr/bin/pkg-config', '--atleast-pkgconfig-version=0.0.0']</span>
<span style="color: #000000">yes</span>
<span style="color: #000000">['/usr/bin/pkg-config', '--modversion', 'pango']</span>
<span style="color: #000000">out: 1.28.0</span>

<span style="color: #000000">---</span>
<span style="color: #000000">Checking for pango</span>
<span style="color: #000000">['/usr/bin/pkg-config', 'pango']</span>
<span style="color: #000000">yes</span>
<span style="color: #000000">---</span>
<span style="color: #000000">Checking for pango</span>
<span style="color: #000000">['/usr/bin/pkg-config', 'pango']</span>
<span style="color: #000000">yes</span>
<span style="color: #000000">---</span>
<span style="color: #000000">Checking for pango 0.1.0</span>
<span style="color: #000000">['/usr/bin/pkg-config', 'pango &gt;= 0.1.0', 'pango &lt; 9.9.9', '--cflags', '--libs', 'pango']</span>
<span style="color: #000000">out: -pthread -I/usr/include/pango-1.0 -I/usr/include/glib-2.0 -I/usr/lib64/glib-2.0/include</span>
<span style="color: #000000">     -pthread -lpango-1.0 -lgobject-2.0 -lgmodule-2.0 -lgthread-2.0 -lrt -lglib-2.0</span>

<span style="color: #000000">yes</span>
<span style="color: #000000">---</span>
<span style="color: #000000">Checking for sdl-config</span>
<span style="color: #000000">['sdl-config', '--cflags', '--libs']</span>
<span style="color: #000000">out: -I/usr/include/SDL -D_GNU_SOURCE=1 -D_REENTRANT</span>
<span style="color: #000000">-L/usr/lib64 -lSDL -lpthread</span>

<span style="color: #000000">yes</span>
<span style="color: #000000">---</span>
<span style="color: #000000">Checking for mpicc</span>
<span style="color: #000000">['mpicc', '--showme:compile', '--showme:link']</span>
<span style="color: #000000">out: -pthread libtool: link: -pthread -L/usr/lib64 -llammpio -llamf77mpi -lmpi -llam -lutil -ldl</span></tt></pre></div></div>
<div class="paragraph"><p>そのようなconfigureの後、コンフィギュレーションセットの中身は次と似たようなものになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">'CFLAGS_OPEN_MPI'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-pthread'</span><span style="color: #000000">]</span>
<span style="color: #009900">'CFLAGS_PANGO'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-pthread'</span><span style="color: #000000">]</span>
<span style="color: #009900">'CXXFLAGS_OPEN_MPI'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-pthread'</span><span style="color: #000000">]</span>
<span style="color: #009900">'CXXFLAGS_PANGO'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-pthread'</span><span style="color: #000000">]</span>
<span style="color: #009900">'DEFINES'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'HAVE_PANGO=1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_MYPANGO=1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_SDL=1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_OPEN_MPI=1'</span><span style="color: #000000">]</span>
<span style="color: #009900">'DEFINES_SDL'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'_GNU_SOURCE=1'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'_REENTRANT'</span><span style="color: #000000">]</span>
<span style="color: #009900">'INCLUDES_PANGO'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/include/pango-1.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'/usr/include/glib-2.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'/usr/lib64/glib-2.0/include'</span><span style="color: #000000">]</span>
<span style="color: #009900">'INCLUDES_SDL'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/include/SDL'</span><span style="color: #000000">]</span>
<span style="color: #009900">'LIBPATH_OPEN_MPI'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/lib64'</span><span style="color: #000000">]</span>
<span style="color: #009900">'LIBPATH_SDL'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'/usr/lib64'</span><span style="color: #000000">]</span>
<span style="color: #009900">'LIB_OPEN_MPI'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'lammpio'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'lamf77mpi'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'mpi'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'lam'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'util'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'dl'</span><span style="color: #000000">]</span>
<span style="color: #009900">'LIB_PANGO'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'pango-1.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'gobject-2.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'gmodule-2.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'gthread-2.0'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'rt'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'glib-2.0'</span><span style="color: #000000">]</span>
<span style="color: #009900">'LIB_SDL'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'SDL'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'pthread'</span><span style="color: #000000">]</span>
<span style="color: #009900">'LINKFLAGS_OPEN_MPI'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-pthread'</span><span style="color: #000000">]</span>
<span style="color: #009900">'LINKFLAGS_PANGO'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'-pthread'</span><span style="color: #000000">]</span>
<span style="color: #009900">'PKGCONFIG'</span><span style="color: #000000"> </span><span style="color: #009900">'/usr/bin/pkg-config'</span>
<span style="color: #009900">'PREFIX'</span><span style="color: #000000"> </span><span style="color: #009900">'/usr/local'</span>
<span style="color: #009900">'define_key'</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'HAVE_PANGO'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_MYPANGO'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_SDL'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'HAVE_OPEN_MPI'</span><span style="color: #000000">]</span></tt></pre></div></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_アドバンスのシナリオ">11. アドバンスのシナリオ</h2>
<div class="sectionbody">
<div class="paragraph"><p>この章ではあまり一般的ではない、より複雑でシナリオのためのWafライブラリの例をいくつか示す。</p></div>
<div class="sect2">
<h3 id="_プロジェクトの構成">11.1. プロジェクトの構成</h3>
<div class="sect3">
<h4 id="_最初にコンパイラをビルド_a_id_build_compiler_first_a">11.1.1. 最初にコンパイラをビルド<a id="build_compiler_first"></a></h4>
<div class="paragraph"><p>次の例は残りのターゲットをビルドするためのコンパイラをビルドする方法を示す。
要求は次のようなものとする：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
コンパラとすべての中間タスクを生成
</p>
</li>
<li>
<p>
第2ステップのビルドでコンパイラを再利用
</p>
</li>
<li>
<p>
コンパイラは <em>.src</em> ファイルを後で処理される <em>.cpp</em> ファイルに変換
</p>
</li>
<li>
<p>
リビルドされたときにはコンパラを再度呼び出す(コンパイラに依存関係を追加)
</p>
</li>
</ol></div>
<div class="paragraph"><p>最初にするべきことは期待されるユーザースクリプトを書くことだ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'g++'</span><span style="color: #000000">)</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'src2cpp'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'comp.cpp'</span><span style="color: #000000">,</span>
<span style="color: #000000">        target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'comp'</span><span style="color: #000000">)</span>

<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">add_group</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">        source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.cpp a.src'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
最初にコンパイラをビルドし、 <em>comp</em> という名前のバイナリが得られる
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
次のタスクの処理を開始する前にコンパイラが完成するように、新しいビルドグループを追加
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
ファイル <em>a.src</em> は <em>comp</em> によって <em>a.cpp</em> に変換される
</td></tr>
</table></div>
<div class="paragraph"><p><em>src → cpp</em> 変換のためのコードは次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">src2cpp</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">    run_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${SRC[0].abspath()} ${SRC[1].abspath()} ${TGT}'</span>
<span style="color: #000000">    color   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'PINK'</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> extension</span>

<span style="color: #000000">@</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.src'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process_src</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">    tg </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">get_tgen_by_name</span><span style="color: #000000">(</span><span style="color: #009900">'comp'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">    comp </span><span style="color: #000000">=</span><span style="color: #000000"> tg</span><span style="color: #000000">.</span><span style="color: #000000">link_task</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">]</span>
<span style="color: #000000">    tsk </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span><span style="color: #009900">'src2cpp'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">comp</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">],</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">change_ext</span><span style="color: #000000">(</span><span style="color: #009900">'.cpp'</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">    self</span><span style="color: #000000">.</span><span style="color: #000000">source</span><span style="color: #000000">.</span><span style="color: #000000">extend</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
自前のコンパイラでソースを処理するための新たなタスククラスを宣言
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
このメソッドによって処理される、拡張子が <em>.src</em> のファイル
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
コンパイラを生成するタスクジェネレータへのリファレンスを獲得
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
タスク <em>src → cpp</em> を生成し、コンパイラは最初のソースファイルとして使われる
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
生成された <em>cpp</em> ファイルも処理するために追加
</td></tr>
</table></div>
<div class="paragraph"><p>コンパイル結果は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.006s)</span>
<span style="color: #000000">Setting top to                           : /tmp/scenarios_compiler</span>
<span style="color: #000000">Setting out to                           : /tmp/scenarios_compiler/build</span>
<span style="color: #000000">Checking for program g++,c++             : /usr/bin/g++</span>
<span style="color: #000000">Checking for program ar                  : /usr/bin/ar</span>
<span style="color: #000000">'configure' finished successfully (0.118s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/scenarios_compiler/build'</span>
<span style="color: #000000">[1/5] cxx: comp.cpp -&gt; build/comp.cpp.0.o</span>
<span style="color: #000000">10:21:14 runner ['/usr/bin/g++', '../comp.cpp', '-c', '-o', 'comp.cpp.0.o']</span>
<span style="color: #000000">[2/5] cxxprogram: build/comp.cpp.0.o -&gt; build/comp <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">10:21:14 runner ['/usr/bin/g++', 'comp.cpp.0.o', '-o', '/tmp/scenarios_compiler/build/comp']</span>
<span style="color: #000000">[3/5] cxx: main.cpp -&gt; build/main.cpp.1.o</span>
<span style="color: #000000">10:21:15 runner ['/usr/bin/g++', '../main.cpp', '-c', '-o', 'main.cpp.1.o']</span>
<span style="color: #000000">[4/5] src2cpp: a.src -&gt; build/a.cpp</span>
<span style="color: #000000">10:21:15 runner ['/tmp/scenarios_compiler/build/comp', '../a.src', 'a.cpp'] <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">[5/5] cxxprogram: build/main.cpp.1.o -&gt; build/foo <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">10:21:15 runner ['/usr/bin/g++', 'main.cpp.1.o', '-o', 'foo']</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/scenarios_compiler/build'</span>
<span style="color: #000000">'build' finished successfully (1.009s)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
<em>comp</em> 実行形式の生成
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
<em>a.cpp</em> を生成するためにコンパイラを使う
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
<em>a.cpp</em> と <em>main.cpp</em> をコンパイルしリンクして実行形式 <em>foo</em> を生成する
</td></tr>
</table></div>
<div class="paragraph"><p>備考: &#8216;waf --targets=foo&#8217; が呼び出されたとき、タスクジェネレータ &#8216;comp&#8217; はタスクも生成する(前のグループのタスクジェネレータは処理される)。</p></div>
</div>
<div class="sect3">
<h4 id="_任意のコンフィギュレーションファイルを与える">11.1.2. 任意のコンフィギュレーションファイルを与える</h4>
<div class="paragraph"><p>ビルドが開始する前にファイルがビルドディレクトリにコピーされる。
ビルドは他のターゲットをビルドするためにこのファイルを使うことができる。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">cfg_file </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'somedir/foo.txt'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>

<span style="color: #000000">    orig </span><span style="color: #000000">=</span><span style="color: #000000"> conf</span><span style="color: #000000">.</span><span style="color: #000000">root</span><span style="color: #000000">.</span><span style="color: #000000">find_node</span><span style="color: #000000">(</span><span style="color: #009900">'/etc/fstab'</span><span style="color: #000000">)</span>
<span style="color: #000000">    txt </span><span style="color: #000000">=</span><span style="color: #000000"> orig</span><span style="color: #000000">.</span><span style="color: #000000">read</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">    dest </span><span style="color: #000000">=</span><span style="color: #000000"> conf</span><span style="color: #000000">.</span><span style="color: #000000">bldnode</span><span style="color: #000000">.</span><span style="color: #000000">make_node</span><span style="color: #000000">(</span><span style="color: #000000">cfg_file</span><span style="color: #000000">)</span>
<span style="color: #000000">    dest</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">mkdir</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">    dest</span><span style="color: #000000">.</span><span style="color: #000000">write</span><span style="color: #000000">(</span><span style="color: #000000">txt</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">    conf</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">append_value</span><span style="color: #000000">(</span><span style="color: #009900">'cfg_files'</span><span style="color: #000000">,</span><span style="color: #000000"> dest</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'cp ${SRC} ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #000000">cfg_file</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'bar.txt'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
ファイル <em>/etc/fstab</em> を読み込む
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ファイル作成先のディレクトリが存在しない場合にそなえてディレクトリを作成
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
新たなファイルをビルドディレクトリに作成
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
アウトプットをコンフィギュレーションファイルとしてマークしビルド中に使うことができる
</td></tr>
</table></div>
<div class="paragraph"><p>実行のアウトプットは次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf configure build</span></span>
<span style="color: #000000">Setting top to     : /tmp/scenarios_impfile</span>
<span style="color: #000000">Setting out to     : /tmp/scenarios_impfile/build</span>
<span style="color: #000000">'configure' finished successfully (0.003s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/scenarios_impfile/build'</span>
<span style="color: #000000">[1/1] bar.txt: build/somedir/foo.txt -&gt; build/bar.txt</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/scenarios_impfile/build'</span>
<span style="color: #000000">'build' finished successfully (0.008s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- build</span>
<span style="color: #000000">|   |-- bar.txt</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   `-- somedir</span>
<span style="color: #000000">|       `-- foo.txt</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_混在する拡張子とc_c_のフィーチャー">11.2. 混在する拡張子とC/C++のフィーチャー</h3>
<div class="sect3">
<h4 id="_単一のタスクジェネレータによって処理されるファイル">11.2.1. 単一のタスクジェネレータによって処理されるファイル</h4>
<div class="paragraph"><p>ここでidlファイルの処理で@extensionデコレータを説明しよう。
拡張子.idlのファイルは処理され.cと.hファイルを生成する(<tt>foo.idl</tt> → <tt>foo.c</tt> + <tt>foo.h</tt>)。
.cファイルは生成された後にコンパイルされなくてはならない。</p></div>
<div class="paragraph"><p>最初に、ユーザースクリプトで期待される宣言だ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">    conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'g++'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">        source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo.idl main.cpp'</span><span style="color: #000000">,</span>
<span style="color: #000000">        target </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'myapp'</span>
<span style="color: #000000">        </span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>ファイル <tt>foo.idl</tt> はソースとしてリストされる。
これは処理されて <tt>foo.cpp</tt> になり、コンパイルされて <tt>main.cpp</tt> とリンクされる。</p></div>
<div class="paragraph"><p>これはこのシナリオをサポートするコードだ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> extension</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">idl</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">    run_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT[0].abspath()} &amp;&amp; touch ${TGT[1].abspath()}'</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">    color   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'BLUE'</span>
<span style="color: #000000">    ext_out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.h'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">@</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.idl'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process_idl</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span>
<span style="color: #000000">    cpp_node </span><span style="color: #000000">=</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">change_ext</span><span style="color: #000000">(</span><span style="color: #009900">'.cpp'</span><span style="color: #000000">)</span>
<span style="color: #000000">    hpp_node </span><span style="color: #000000">=</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">change_ext</span><span style="color: #000000">(</span><span style="color: #009900">'.hpp'</span><span style="color: #000000">)</span>
<span style="color: #000000">    self</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span><span style="color: #009900">'idl'</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">cpp_node</span><span style="color: #000000">,</span><span style="color: #000000"> hpp_node</span><span style="color: #000000">])</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">    self</span><span style="color: #000000">.</span><span style="color: #000000">source</span><span style="color: #000000">.</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #000000">cpp_node</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
デモのためのダミーのコマンド。実際にはルールは <em>omniidl -bcxx ${SRC} -C${TGT}</em> のようなものになる
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
idlタスクはヘッダを生成するので、 <tt>cpp</tt> ファイルがコンパイルされる前に実行されなくてはならない
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
拡張子 <em>.idl</em> からタスクを作成
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
C++コンパイラによってコンパイルされるように再度ファイルを追加
</td></tr>
</table></div>
<div class="paragraph"><p>実行結果は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.002s)</span>
<span style="color: #000000">Setting top to   : /tmp/scenarios_idl</span>
<span style="color: #000000">Setting out to   : /tmp/scenarios_idl/build</span>
<span style="color: #000000">Checking for program g++,c++   : /usr/bin/g++</span>
<span style="color: #000000">Checking for program ar        : /usr/bin/ar</span>
<span style="color: #000000">'configure' finished successfully (0.072s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/scenarios_idl/build'</span>
<span style="color: #000000">[1/4] idl: foo.idl -&gt; build/foo.cpp build/foo.hpp</span>
<span style="color: #000000">19:47:11 runner 'cp ../foo.idl foo.cpp &amp;&amp; touch foo.hpp'</span>
<span style="color: #000000">[2/4] cxx: main.cpp -&gt; build/main.cpp.0.o</span>
<span style="color: #000000">19:47:11 runner ['/usr/bin/g++', '-I.', '-I..', '../main.cpp', '-c', '-o', 'main.cpp.0.o']</span>
<span style="color: #000000">[3/4] cxx: build/foo.cpp -&gt; build/foo.cpp.0.o</span>
<span style="color: #000000">19:47:11 runner ['/usr/bin/g++', '-I.', '-I..', 'foo.cpp', '-c', '-o', 'foo.cpp.0.o']</span>
<span style="color: #000000">[4/4] cxxprogram: build/main.cpp.0.o build/foo.cpp.0.o -&gt; build/myapp</span>
<span style="color: #000000">19:47:11 runner ['/usr/bin/g++', 'main.cpp.0.o', 'foo.cpp.0.o', '-o', 'myapp']</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/scenarios_idl/build'</span>
<span style="color: #000000">'build' finished successfully (0.149s)</span></tt></pre></div></div>
<div class="paragraph"><p>備考: この宣言による難点は、idlによって生成されたソースファイルは単一のタスクジェネレータからしか使うことができない点だ</p></div>
</div>
<div class="sect3">
<h4 id="_複数のタスクジェネレータによって共有されるリソース">11.2.2. 複数のタスクジェネレータによって共有されるリソース</h4>
<div class="paragraph"><p>複数のタスクジェネレータがidlのアウトプットを共有するとしよう。
まずはそれっぽいユーザースクリプトを書くことから始める：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'out'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'g++'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'notify.idl'</span><span style="color: #000000">,</span>
<span style="color: #000000">        name     </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'idl_gen'</span><span style="color: #000000">)</span>

<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'main.cpp'</span><span style="color: #000000">],</span>
<span style="color: #000000">        target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'testprog'</span><span style="color: #000000">,</span>
<span style="color: #000000">        includes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span><span style="color: #000000">,</span>
<span style="color: #000000">        add_idl  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'idl_gen'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
最初のタスクジェネレータにあるidlファイルを処理する。このタスクジェネレータを <em>idl_gen</em> と名付ける
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
他のどこか(おそらく別のスクリプト)で、別のタスクジェネレータがidlの処理によって生成されたソースファイルを使う
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
名前 <em>idl_gen</em> でidlを処理するタスクジェネレータを参照する
</td></tr>
</table></div>
<div class="paragraph"><p>このシナリオをサポートするコードは次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> feature</span><span style="color: #000000">,</span><span style="color: #000000"> before_method</span><span style="color: #000000">,</span><span style="color: #000000"> extension</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">idl</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">        run_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT[0].abspath()} &amp;&amp; touch ${TGT[1].abspath()}'</span>
<span style="color: #000000">        color   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'BLUE'</span>
<span style="color: #000000">        ext_out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.h'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">@</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.idl'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process_idl</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span>
<span style="color: #000000">        cpp_node </span><span style="color: #000000">=</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">change_ext</span><span style="color: #000000">(</span><span style="color: #009900">'.cpp'</span><span style="color: #000000">)</span>
<span style="color: #000000">        hpp_node </span><span style="color: #000000">=</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">change_ext</span><span style="color: #000000">(</span><span style="color: #009900">'.hpp'</span><span style="color: #000000">)</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span><span style="color: #009900">'idl'</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">cpp_node</span><span style="color: #000000">,</span><span style="color: #000000"> hpp_node</span><span style="color: #000000">])</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">more_source </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">cpp_node</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>

<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">before_method</span><span style="color: #000000">(</span><span style="color: #009900">'process_source'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process_add_source</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">to_list</span><span style="color: #000000">(</span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'add_idl'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[])):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                y </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">get_tgen_by_name</span><span style="color: #000000">(</span><span style="color: #000000">x</span><span style="color: #000000">)</span>
<span style="color: #000000">                y</span><span style="color: #000000">.</span><span style="color: #000000">post</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">                </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">y</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'more_source'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">):</span>
<span style="color: #000000">                        self</span><span style="color: #000000">.</span><span style="color: #000000">source</span><span style="color: #000000">.</span><span style="color: #000000">extend</span><span style="color: #000000">(</span><span style="color: #000000">y</span><span style="color: #000000">.</span><span style="color: #000000">more_source</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
C++タスクが実行される前にidlの処理は行われなくてはならない
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
アウトプットファイルを新たなアトリビュートにバインドする
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
別のタスクジェネレータオブジェクトからソースを追加する
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
<em>add_idl</em> を処理し他のタスクジェネレータを見つける
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
他のタスクジェネレータにタスクを作成させる
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
ソースのリストを更新する
</td></tr>
</table></div>
<div class="paragraph"><p>タスク実行のアウトプットは最初の例のアウトプットとよく似たものとなるだろう：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.007s)</span>
<span style="color: #000000">Setting top to  : /tmp/scenarios_idl2</span>
<span style="color: #000000">Setting out to  : /tmp/scenarios_idl2/build</span>
<span style="color: #000000">Checking for program g++,c++    : /usr/bin/g++</span>
<span style="color: #000000">Checking for program ar         : /usr/bin/ar</span>
<span style="color: #000000">'configure' finished successfully (0.080s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/scenarios_idl2/build'</span>
<span style="color: #000000">[1/4] idl: foo.idl -&gt; build/foo.cpp build/foo.hpp</span>
<span style="color: #000000">20:20:24 runner 'cp ../foo.idl foo.cpp &amp;&amp; touch foo.hpp'</span>
<span style="color: #000000">[2/4] cxx: main.cpp -&gt; build/main.cpp.1.o</span>
<span style="color: #000000">20:20:24 runner ['/usr/bin/g++', '-I.', '-I..', '../main.cpp', '-c', '-o', 'main.cpp.1.o']</span>
<span style="color: #000000">[3/4] cxx: build/foo.cpp -&gt; build/foo.cpp.1.o</span>
<span style="color: #000000">20:20:24 runner ['/usr/bin/g++', '-I.', '-I..', 'foo.cpp', '-c', '-o', 'foo.cpp.1.o']</span>
<span style="color: #000000">[4/4] cxxprogram: build/main.cpp.1.o build/foo.cpp.1.o -&gt; build/testprog</span>
<span style="color: #000000">20:20:24 runner ['/usr/bin/g++', 'main.cpp.1.o', 'foo.cpp.1.o', '-o', 'testprog']</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/scenarios_idl2/build'</span>
<span style="color: #000000">'build' finished successfully (0.130s)</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_タスクジェネレータメソッド">11.3. タスクジェネレータメソッド</h3>
<div class="sect3">
<h4 id="_特定のアトリビュートの置換">11.3.1. 特定のアトリビュートの置換</h4>
<div class="paragraph"><p>一般に、タスクジェネレータのアトリビュートは置換されず、次は <tt>main.c</tt> をコンパイルしない：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">FOO </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'/usr/includes'</span>
<span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">MAIN </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c'</span>
<span style="color: #000000">bld</span><span style="color: #000000">(</span>
<span style="color: #000000">    features </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'c cprogram'</span><span style="color: #000000">,</span>
<span style="color: #000000">    source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${MAIN}'</span><span style="color: #000000">,</span>
<span style="color: #000000">    target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'app'</span><span style="color: #000000">,</span>
<span style="color: #000000">    includes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'. ${FOO}'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>このデザインの決定は2つの理由によるものだ：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
アトリビュートを処理するとパフォーマンスが悪化する
</p>
</li>
<li>
<p>
整合性のためにはすべてのアトリビュートが処理されるべきである
</p>
</li>
</ol></div>
<div class="paragraph"><p>それにもかかわらず、いくつかのアトリビュートを処理するためにWafにメソッドを提供する方法を示す。
新たなタスクジェネレータメソッドを追加するには、他のメソッドとのインテグレーションについて考える必要がある: 特別な順序が存在するのか？
答えはyesで、例えば、ソースアトリビュートはコンパイルタスクを作成するために使われる。
何のメソッドが使われているかを表示するために、次のロギングキーをつけてWafを実行する:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --zones=task_gen</span></span>
<span style="color: #000000">...</span>
<span style="color: #000000">19:20:51 task_gen posting task_gen 'app' declared in 'scenarios_expansion' <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">19:20:51 task_gen -&gt; process_rule (9232720) <img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">19:20:51 task_gen -&gt; process_source (9232720)</span>
<span style="color: #000000">19:20:51 task_gen -&gt; apply_link (9232720)</span>
<span style="color: #000000">19:20:51 task_gen -&gt; apply_objdeps (9232720)</span>
<span style="color: #000000">19:20:51 task_gen -&gt; process_use (9232720)</span>
<span style="color: #000000">19:20:51 task_gen -&gt; propagate_uselib_vars (9232720)</span>
<span style="color: #000000">19:20:51 task_gen -&gt; apply_incpaths (9232720)</span>
<span style="color: #000000">19:20:51 task_gen posted app</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
タスクジェネレータの実行
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
メソッド名と()の中のタスクジェネレータID
</td></tr>
</table></div>
<div class="paragraph"><p>メソッドのリストから、 <strong>process_rule</strong> と <strong>process_source</strong> が <em>source</em> アトリビュートを処理していることがわかる。
<em>includes</em> アトリビュートは <strong>apply_incpaths</strong> によって処理される。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Utils</span><span style="color: #000000">,</span><span style="color: #000000"> TaskGen</span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'*'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">@TaskGen</span><span style="color: #000000">.</span><span style="color: #000000">before</span><span style="color: #000000">(</span><span style="color: #009900">'process_source'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'process_rule'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'apply_incpaths'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">transform_strings</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #009900">'includes source'</span><span style="color: #000000">.</span><span style="color: #000000">split</span><span style="color: #000000">():</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">                val </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> x</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">)</span>
<span style="color: #000000">                </span><span style="color: #000080">if</span><span style="color: #000000"> val</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000000">isinstance</span><span style="color: #000000">(</span><span style="color: #000000">val</span><span style="color: #000000">,</span><span style="color: #000000"> str</span><span style="color: #000000">):</span>
<span style="color: #000000">                                </span><span style="color: #000000">setattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> x</span><span style="color: #000000">,</span><span style="color: #000000"> Utils</span><span style="color: #000000">.</span><span style="color: #000000">subst_vars</span><span style="color: #000000">(</span><span style="color: #000000">val</span><span style="color: #000000">,</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">                        </span><span style="color: #000080">elif</span><span style="color: #000000"> </span><span style="color: #000000">isinstance</span><span style="color: #000000">(</span><span style="color: #000000">val</span><span style="color: #000000">,</span><span style="color: #000000"> list</span><span style="color: #000000">):</span>
<span style="color: #000000">                                </span><span style="color: #000080">for</span><span style="color: #000000"> i </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">xrange</span><span style="color: #000000">(</span><span style="color: #000000">len</span><span style="color: #000000">(</span><span style="color: #000000">val</span><span style="color: #000000">)):</span>
<span style="color: #000000">                                        </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000000">isinstance</span><span style="color: #000000">(</span><span style="color: #000000">val</span><span style="color: #000000">[</span><span style="color: #000000">i</span><span style="color: #000000">],</span><span style="color: #000000"> str</span><span style="color: #000000">):</span>
<span style="color: #000000">                                                val</span><span style="color: #000000">[</span><span style="color: #000000">i</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> Utils</span><span style="color: #000000">.</span><span style="color: #000000">subst_vars</span><span style="color: #000000">(</span><span style="color: #000000">val</span><span style="color: #000000">[</span><span style="color: #000000">i</span><span style="color: #000000">],</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
すべてのタスクジェネレータでこのメソッドを実行する
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
考慮するメソッド
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
すべての興味のあるアトリビュートについてイテレートする
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
アトリビュートを代入する
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_特別なインクルードフラグの挿入">11.3.2. 特別なインクルードフラグの挿入</h4>
<div class="paragraph"><p>C/C+<tt>プロジェクトではときどき、フラグが通常どのように処理されるかに係わらず、特定のフラグを他のフラグより前に挿入する必要がある。
次のケースを考慮する: フラグ &#8216;-I.&#8217; を最初に(他のどのインクルードよりも前に)つけてすべてのC</tt>+のコンパイルを実行する。</p></div>
<div class="paragraph"><p>最初に、C++のコンパイルルールの定義を見ると、変数 <em>INCPATHS</em> がインクルードフラグを含むことがわかる:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">cxx</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">    color   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'GREEN'</span>
<span style="color: #000000">    run_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'${CXX} ${CXXFLAGS} ${CPPPATH_ST:INCPATHS} ${CXX_SRC_F}${SRC} ${CXX_TGT_F}${TGT}'</span>
<span style="color: #000000">    vars    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'CXXDEPS'</span><span style="color: #000000">]</span>
<span style="color: #000000">    ext_in  </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.h'</span><span style="color: #000000">]</span>
<span style="color: #000000">    scan    </span><span style="color: #000000">=</span><span style="color: #000000"> c_preproc</span><span style="color: #000000">.</span><span style="color: #000000">scan</span></tt></pre></div></div>
<div class="paragraph"><p>インクルードフラグはメソッド <em>apply_incpaths</em> によってセットされる。
そのメソッドが実行された後で <em>INCPATHS</em> を変更するのがトリックだ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">    conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'g++'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'cxx cxxprogram'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'main.cpp'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'test'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> after</span><span style="color: #000000">,</span><span style="color: #000000"> feature</span>

<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'cxx'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">after_method</span><span style="color: #000000">(</span><span style="color: #009900">'apply_incpaths'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">insert_blddir</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">    self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">prepend_value</span><span style="color: #000000">(</span><span style="color: #009900">'INCPATHS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>関連するケースとして、コンフィギュレーションヘッダを含んだ最上位ディレクトリを追加する方法を示す：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'cxx'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">after_method</span><span style="color: #000000">(</span><span style="color: #009900">'apply_incpaths'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'insert_blddir'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">insert_srcdir</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">    path </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">srcnode</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span>
<span style="color: #000000">    self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">prepend_value</span><span style="color: #000000">(</span><span style="color: #009900">'INCPATHS'</span><span style="color: #000000">,</span><span style="color: #000000"> path</span><span style="color: #000000">)</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_カスタムタスク">11.4. カスタムタスク</h3>
<div class="sect3">
<h4 id="_特定のタスクのコンパイルを強制する">11.4.1. 特定のタスクのコンパイルを強制する</h4>
<div class="paragraph"><p>いくつかのアプリケーションでは、最終ビルドの日時を記録するとおもしろいことがある。
Cでは、これはマクロ &#8216;<em>DATE</em>&#8217; と &#8216;<em>TIME</em>&#8217; を使うとできる。
例えば、 <tt>about.c</tt> ファイルが次を含む:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">void</span><span style="color: #000000"> </span><span style="color: #000000">ping</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000">{</span>
<span style="color: #000000">    </span><span style="color: #000000">printf</span><span style="color: #000000">(</span><span style="color: #009900">"Project compiled: %s %s</span><span style="color: #CC33CC">\n</span><span style="color: #009900">"</span><span style="color: #000000">,</span><span style="color: #000000"> __DATE__</span><span style="color: #000000">,</span><span style="color: #000000"> __TIME__</span><span style="color: #000000">);</span>
<span style="color: #000000">}</span></tt></pre></div></div>
<div class="paragraph"><p>ファイルは変更があるときにのみコンパイルされるので、 <tt>about.c</tt> を強制的に再コンパイルする方法を見つける必要がある。
まとめると、コンパイルは次のケースではいつでも行われるべきだ：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
プロジェクト中の一つのCファイルがコンパイルされた
</p>
</li>
<li>
<p>
タスクのためのリンクフラグが変更された
</p>
</li>
<li>
<p>
マクロのためのオブジェクトを含むリンクタスクが削除された
</p>
</li>
</ol></div>
<div class="paragraph"><p>この振舞いを示すために、さまざまなCファイルを使うプロジェクトをセットアップする：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">opt</span><span style="color: #000000">):</span>
<span style="color: #000000">    opt</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">    conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">program</span><span style="color: #000000">(</span>
<span style="color: #000000">        source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'main.c about.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">        target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'app'</span><span style="color: #000000">,</span>
<span style="color: #000000">        includes </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span><span style="color: #000000">,</span>
<span style="color: #000000">        use      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'my_static_lib'</span><span style="color: #000000">)</span>

<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">stlib</span><span style="color: #000000">(</span>
<span style="color: #000000">        source   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'test_staticlib.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">        target   </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'my_static_lib'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>mainファイルは日時を表示するために、 <tt>about.c</tt> で定義された関数 <em>ping</em> を呼び出すだけだ:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">#include</span></span><span style="color: #000000"> </span><span style="color: #009900">"a.h"</span>

<span style="color: #009900">int</span><span style="color: #000000"> </span><span style="color: #000000">main</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000">{</span>
<span style="color: #000000">    </span><span style="color: #000000">ping</span><span style="color: #000000">();</span>
<span style="color: #000000">    </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">0</span><span style="color: #000000">;</span>
<span style="color: #000000">}</span></tt></pre></div></div>
<div class="paragraph"><p>依存関係を考慮するために、タスクメソッド <em>runnable_status</em> は上書きされなくてはならない：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> os</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">runnable_status</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #000080">if</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">name </span><span style="color: #000000">==</span><span style="color: #000000"> </span><span style="color: #009900">'about.c'</span><span style="color: #000000">:</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        h </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">0</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> g </span><span style="color: #000080">in</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">groups</span><span style="color: #000000">:</span>
<span style="color: #000000">            </span><span style="color: #000080">for</span><span style="color: #000000"> tg </span><span style="color: #000080">in</span><span style="color: #000000"> g</span><span style="color: #000000">:</span>
<span style="color: #000000">                </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000000">isinstance</span><span style="color: #000000">(</span><span style="color: #000000">tg</span><span style="color: #000000">,</span><span style="color: #000000"> TaskBase</span><span style="color: #000000">):</span>
<span style="color: #000000">                    </span><span style="color: #000080">continue</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">                h </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">hash</span><span style="color: #000000">((</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">hash_env_vars</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'LINKFLAGS'</span><span style="color: #000000">]),</span><span style="color: #000000"> h</span><span style="color: #000000">))</span>
<span style="color: #000000">                </span><span style="color: #000080">for</span><span style="color: #000000"> tsk </span><span style="color: #000080">in</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">tg</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'compiled_tasks'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[]):</span><span style="color: #000000"> </span><span style="color: #808080"># all .c or .cpp compilations</span>
<span style="color: #000000">                    </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000000">id</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000">==</span><span style="color: #000000"> </span><span style="color: #000000">id</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">                        </span><span style="color: #000080">continue</span>
<span style="color: #000000">                    </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000080">not</span><span style="color: #000000"> tsk</span><span style="color: #000000">.</span><span style="color: #000000">hasrun</span><span style="color: #000000">:</span>
<span style="color: #000000">                        </span><span style="color: #000080">return</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">ASK_LATER</span>
<span style="color: #000000">                    h </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">hash</span><span style="color: #000000">((</span><span style="color: #000000">tsk</span><span style="color: #000000">.</span><span style="color: #000000">signature</span><span style="color: #000000">(),</span><span style="color: #000000"> h</span><span style="color: #000000">))</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">CCDEPS </span><span style="color: #000000">=</span><span style="color: #000000"> h</span>

<span style="color: #000000">        </span><span style="color: #000080">try</span><span style="color: #000000">:</span>
<span style="color: #000000">            os</span><span style="color: #000000">.</span><span style="color: #000000">stat</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">link_task</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        </span><span style="color: #000080">except</span><span style="color: #000000">:</span>
<span style="color: #000000">            </span><span style="color: #000080">return</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">RUN_ME</span>

<span style="color: #000000">    </span><span style="color: #000080">return</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">runnable_status</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Tools</span><span style="color: #000000">.</span><span style="color: #000000">c </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> c </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">c</span><span style="color: #000000">.</span><span style="color: #000000">runnable_status </span><span style="color: #000000">=</span><span style="color: #000000"> runnable_status</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
もしタスクが <tt>about.c</tt> を処理するならば
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
タスクが依存するハッシュ値(CCDEPS)を定義する
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
プロジェクトのすべてのタスクジェネレータについてイテレートする
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
リンクフラグと他のすべてのコンパイルタスクのシグネチャのハッシュ
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
まだ実行されていないのならば、タスクを実行する
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
通常の振舞い
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
<em>c</em> タスククラスを変更する
</td></tr>
</table></div>
<div class="paragraph"><p>実行すると次のようなアウトプットが生成される：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/scenarios_end/build'</span>
<span style="color: #000000">[2/5] c: test_staticlib.c -&gt; build/test_staticlib.c.1.o</span>
<span style="color: #000000">[3/5] cstlib: build/test_staticlib.c.1.o -&gt; build/libmy_static_lib.a</span>
<span style="color: #000000">[4/5] c: about.c -&gt; build/about.c.0.o</span>
<span style="color: #000000">[5/5] cprogram: build/main.c.0.o build/about.c.0.o -&gt; build/app</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/scenarios_end/build' <img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">'build' finished successfully (0.088s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ ./build/app</span></span>
<span style="color: #000000">Project compiled: Jul 25 2010 14:05:30</span>

<span style="font-weight: bold"><span style="color: #993399">$ echo " " &gt;&gt; main.c <img src="./callouts/2.png" alt="2" /></span></span>

<span style="font-weight: bold"><span style="color: #993399">$ waf</span></span>
<span style="color: #000000">Waf: Entering directory `/tmp/scenarios_end/build'</span>
<span style="color: #000000">[1/5] c: main.c -&gt; build/main.c.0.o</span>
<span style="color: #000000">[4/5] c: about.c -&gt; build/about.c.0.o <img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">[5/5] cprogram: build/main.c.0.o build/about.c.0.o -&gt; build/app</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/scenarios_end/build'</span>
<span style="color: #000000">'build' finished successfully (0.101s)</span>

<span style="font-weight: bold"><span style="color: #993399">$ ./build/app</span></span>
<span style="color: #000000">Project compiled: Jul 25 2010 14:05:49</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
すべてのファイルは最初のビルドでコンパイルされる
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
ファイル <tt>main.c</tt> を変更する
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
ビルド時刻の文字列を更新するためにビルドは再度 <tt>about.c</tt> を生成する
</td></tr>
</table></div>
</div>
<div class="sect3">
<h4 id="_事前に名前のわからないソースファイルを生成するコンパイラ">11.4.2. 事前に名前のわからないソースファイルを生成するコンパイラ</h4>
<div class="paragraph"><p>この問題の要求点は次のようになる：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
コンパイラは <strong>ソースファイルを作成する</strong> (1つの .src ファイル &#8594; 複数の .c ファイル)
</p>
</li>
<li>
<p>
作成されるソーフファイルの名前は <strong>コンパイラが実行されたときにのみわかる</strong>
</p>
</li>
<li>
<p>
コンパイラは遅いので <strong>必要なときにのみ</strong> 実行される
</p>
</li>
<li>
<p>
他のタスクは <strong>生成されたファイルに依存する</strong> (.cファイルをコンパイルしリンクして実行形式を作る)
</p>
</li>
</ol></div>
<div class="paragraph"><p>これを満すために、ソースファイルに関する情報はビルドの実行のをまたがって共有されなくてはならない：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">top </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'.'</span>
<span style="color: #000000">out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'build'</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">conf</span><span style="color: #000000">):</span>
<span style="color: #000000">    conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'gcc'</span><span style="color: #000000">)</span>
<span style="color: #000000">    conf</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'mytool'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">COMP </span><span style="color: #000000">=</span><span style="color: #000000"> bld</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_resource</span><span style="color: #000000">(</span><span style="color: #009900">'evil_comp.py'</span><span style="color: #000000">).</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">stlib</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'x.c foo.src'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'astaticlib'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
コンパイラへのパス
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
<em>.src</em> ファイルをもつ例
</td></tr>
</table></div>
<div class="paragraph"><p><em>mytool</em> の中身は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> os</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span><span style="color: #000000">,</span><span style="color: #000000"> Utils</span><span style="color: #000000">,</span><span style="color: #000000"> Context</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Utils </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> subprocess</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> extension</span>

<span style="color: #000000">@</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.src'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process_shpip</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">    self</span><span style="color: #000000">.</span><span style="color: #000000">create_task</span><span style="color: #000000">(</span><span style="color: #009900">'src2c'</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">)</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">src2c</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">.</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">    color </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'PINK'</span>
<span style="color: #000000">    quiet </span><span style="color: #000000">=</span><span style="color: #000000"> True </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">    ext_out </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #009900">'.h'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">    </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        cmd </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'%s %s'</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> </span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">COMP</span><span style="color: #000000">,</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span>
<span style="color: #000000">        n </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">].</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">get_bld</span><span style="color: #000000">()</span>
<span style="color: #000000">        n</span><span style="color: #000000">.</span><span style="color: #000000">mkdir</span><span style="color: #000000">()</span>
<span style="color: #000000">        cwd </span><span style="color: #000000">=</span><span style="color: #000000"> n</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span>
<span style="color: #000000">        out </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">cmd_and_log</span><span style="color: #000000">(</span><span style="color: #000000">cmd</span><span style="color: #000000">,</span><span style="color: #000000"> cwd</span><span style="color: #000000">=</span><span style="color: #000000">cwd</span><span style="color: #000000">,</span><span style="color: #000000"> quiet</span><span style="color: #000000">=</span><span style="color: #000000">Context</span><span style="color: #000000">.</span><span style="color: #000000">STDOUT</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>

<span style="color: #000000">        out </span><span style="color: #000000">=</span><span style="color: #000000"> Utils</span><span style="color: #000000">.</span><span style="color: #000000">to_list</span><span style="color: #000000">(</span><span style="color: #000000">out</span><span style="color: #000000">)</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">outputs </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">find_or_declare</span><span style="color: #000000">(</span><span style="color: #000000">x</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> out</span><span style="color: #000000">]</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">raw_deps</span><span style="color: #000000">[</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">uid</span><span style="color: #000000">()]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">signature</span><span style="color: #000000">()]</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">outputs </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">add_c_tasks</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="color: #000000">    </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">add_c_tasks</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> lst</span><span style="color: #000000">):</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">more_tasks </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">[]</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> node </span><span style="color: #000080">in</span><span style="color: #000000"> lst</span><span style="color: #000000">:</span>
<span style="color: #000000">            </span><span style="color: #000080">if</span><span style="color: #000000"> node</span><span style="color: #000000">.</span><span style="color: #000000">name</span><span style="color: #000000">.</span><span style="color: #000000">endswith</span><span style="color: #000000">(</span><span style="color: #009900">'.h'</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #000080">continue</span>
<span style="color: #000000">            tsk </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">create_compiled_task</span><span style="color: #000000">(</span><span style="color: #009900">'c'</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">)</span>
<span style="color: #000000">            self</span><span style="color: #000000">.</span><span style="color: #000000">more_tasks</span><span style="color: #000000">.</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>

<span style="color: #000000">            tsk</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">append_value</span><span style="color: #000000">(</span><span style="color: #009900">'INCPATHS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">[</span><span style="color: #000000">node</span><span style="color: #000000">.</span><span style="color: #000000">parent</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">()])</span>

<span style="color: #000000">            </span><span style="color: #000080">if</span><span style="color: #000000"> </span><span style="color: #000000">getattr</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'link_task'</span><span style="color: #000000">,</span><span style="color: #000000"> None</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span>
<span style="color: #000000">                self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">link_task</span><span style="color: #000000">.</span><span style="color: #000000">set_run_after</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">)</span>
<span style="color: #000000">                self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">link_task</span><span style="color: #000000">.</span><span style="color: #000000">inputs</span><span style="color: #000000">.</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #000000">tsk</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">])</span>

<span style="color: #000000">    </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">runnable_status</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        ret </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">super</span><span style="color: #000000">(</span><span style="color: #000000">src2c</span><span style="color: #000000">,</span><span style="color: #000000"> self</span><span style="color: #000000">).</span><span style="color: #000000">runnable_status</span><span style="color: #000000">()</span>
<span style="color: #000000">        </span><span style="color: #000080">if</span><span style="color: #000000"> ret </span><span style="color: #000000">==</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">SKIP_ME</span><span style="color: #000000">:</span>

<span style="color: #000000">            lst </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">raw_deps</span><span style="color: #000000">[</span><span style="color: #000000">self</span><span style="color: #000000">.</span><span style="color: #000000">uid</span><span style="color: #000000">()]</span>
<span style="color: #000000">            </span><span style="color: #000080">if</span><span style="color: #000000"> lst</span><span style="color: #000000">[</span><span style="color: #000000">0</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">!=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">signature</span><span style="color: #000000">():</span>
<span style="color: #000000">                </span><span style="color: #000080">return</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">RUN_ME</span>

<span style="color: #000000">            nodes </span><span style="color: #000000">=</span><span style="color: #000000"> lst</span><span style="color: #000000">[</span><span style="color: #000000">1</span><span style="color: #000000">:]</span>
<span style="color: #000000">            </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> nodes</span><span style="color: #000000">:</span>
<span style="color: #000000">                </span><span style="color: #000080">try</span><span style="color: #000000">:</span>
<span style="color: #000000">                    os</span><span style="color: #000000">.</span><span style="color: #000000">stat</span><span style="color: #000000">(</span><span style="color: #000000">x</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">())</span>
<span style="color: #000000">                </span><span style="color: #000080">except</span><span style="color: #000000">:</span>
<span style="color: #000000">                    </span><span style="color: #000080">return</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">RUN_ME</span>

<span style="color: #000000">            nodes </span><span style="color: #000000">=</span><span style="color: #000000"> lst</span><span style="color: #000000">[</span><span style="color: #000000">1</span><span style="color: #000000">:]</span>
<span style="color: #000000">            self</span><span style="color: #000000">.</span><span style="color: #000000">set_outputs</span><span style="color: #000000">(</span><span style="color: #000000">nodes</span><span style="color: #000000">)</span>
<span style="color: #000000">            self</span><span style="color: #000000">.</span><span style="color: #000000">add_c_tasks</span><span style="color: #000000">(</span><span style="color: #000000">nodes</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/9.png" alt="9" /></span>

<span style="color: #000000">        </span><span style="color: #000080">return</span><span style="color: #000000"> ret</span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
処理はタスクに移譲される
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
タスクのアウトプットがない場合、警告を無効にする
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
<em>.h</em> ファイルを使うタスクの前に処理が実行されるようにする
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
タスクが実行されたときに、生成されたファイル名を含んでいる、プロセスの標準出力を収集する
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
アウトプットファイルのノードを永続化キャッシュへ格納する
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
アウトプットをコンパイルするためにタスクを作る
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
Cタスクは現在のタスクが終わった後で処理される。これはCタスクが常に実行されるわけではないことを意味する
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
<em>src</em> ファイルのタスクジェネレータがリンクタスクをもつならば、ビルド順序をセット
</td></tr>
<tr><td><img src="./callouts/9.png" alt="9" /></td><td>
このタスクがスキップされたときに、強制的に動的なCタスクを作成
</td></tr>
</table></div>
<div class="paragraph"><p>アウトプットは次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build build</span></span>
<span style="color: #000000">'distclean' finished successfully (0.006s)</span>
<span style="color: #000000">Setting top to  : /tmp/scenarios_unknown</span>
<span style="color: #000000">Setting out to  : /tmp/scenarios_unknown/build</span>
<span style="color: #000000">Checking for program gcc,cc              : /usr/bin/gcc</span>
<span style="color: #000000">Checking for program ar                  : /usr/bin/ar</span>
<span style="color: #000000">'configure' finished successfully (0.115s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/scenarios_unknown/build'</span>
<span style="color: #000000">[1/3] src2c: foo.src</span>
<span style="color: #000000">[2/5] c: build/shpip/a12.c -&gt; build/shpip/a12.c.0.o</span>
<span style="color: #000000">[3/5] c: build/shpop/a13.c -&gt; build/shpop/a13.c.0.o</span>
<span style="color: #000000">[4/5] c: x.c -&gt; build/x.c.0.o</span>
<span style="color: #000000">[5/5] cstlib: build/x.c.0.o build/shpip/a12.c.0.o build/shpop/a13.c.0.o -&gt; build/libastaticlib.a</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/scenarios_unknown/build'</span>
<span style="color: #000000">'build' finished successfully (0.188s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/scenarios_unknown/build'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/scenarios_unknown/build'</span>
<span style="color: #000000">'build' finished successfully (0.013s)</span></tt></pre></div></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_開発バージョンの使用">12. 開発バージョンの使用</h2>
<div class="sectionbody">
<div class="paragraph"><p>Wafの開発フローに関するいくつかのノート。</p></div>
<div class="sect2">
<h3 id="_実行のトレース">12.1. 実行のトレース</h3>
<div class="sect3">
<h4 id="_ロギング">12.1.1. ロギング</h4>
<div class="paragraph"><p>スタックトレースやメッセージに情報を追加する一般的なフラグは <em>-v</em> (verbosity)で、ビルド中に実行されるコマンドラインの表示に使われる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf -v</span></span></tt></pre></div></div>
<div class="paragraph"><p>すべてのトレース(バグレポートに便利)を表示するには、次のフラグを使う：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf -vvv</span></span></tt></pre></div></div>
<div class="paragraph"><p><em>zones</em> フラグで簡単にデバッグ情報をフィルターできる:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --zones=action</span></span></tt></pre></div></div>
<div class="paragraph"><p>トレースするゾーンはカンマ区切でなくてはならない、例えば：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf --zones=action,envhash,task_gen</span></span></tt></pre></div></div>
<div class="paragraph"><p>Wafの <em>Logs</em> モジュールはPythonのloggingモジュールを置換する。
ソースコードでは、トレースは <em>debug</em> 関数を使うことで与えられ、次のように"zone: message"のフォーマットに従わなくてはならない：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">Logs</span><span style="color: #000000">.</span><span style="color: #000000">debug</span><span style="color: #000000">(</span><span style="color: #009900">"task: executing %r - it was never run before or its class changed"</span><span style="color: #000000"> </span><span style="color: #000000">%</span><span style="color: #000000"> self</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Wafでは次のゾーンが使われる：</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 2. デバッグゾーン</caption>
<col width="16%" />
<col width="83%" />
<thead>
<tr>
<th align="left" valign="top">ゾーン    </th>
<th align="left" valign="top"> 説明</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">runner</p></td>
<td align="left" valign="top"><p class="table">実行されるコマンドライン(デバッグゾーンなしで-vが与えられると有効になる)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">deps</p></td>
<td align="left" valign="top"><p class="table">暗黙の依存関係の検出(タスクスキャナ)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">task_gen</p></td>
<td align="left" valign="top"><p class="table">(タスクジェネレータからの)タスク生成とタスクジェネレータメソッドの実行</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">action</p></td>
<td align="left" valign="top"><p class="table">ターゲットのビルドを実行するための関数</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">env</p></td>
<td align="left" valign="top"><p class="table">環境オブジェクト</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">envhash</p></td>
<td align="left" valign="top"><p class="table">環境オブジェクトのハッシュ - 変化したものを確認するのを助ける</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">build</p></td>
<td align="left" valign="top"><p class="table">ファイルシステムへのアクセスなどのビルドコンテキストのオペレーション</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">preproc</p></td>
<td align="left" valign="top"><p class="table">プリプロセッサの実行</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">group</p></td>
<td align="left" valign="top"><p class="table">グループとタスクジェネレータ</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>警告: デバッグ情報はコマンドラインが解析された後にのみ表示することができる。例えば、コマンドラインオプション <em>opt.load()</em> もしくはグローバルな初期化関数 <em>init.tool()</em> によってWafツールが存在する場合にはデバッグ情報は表示されない。</p></div>
</div>
<div class="sect3">
<h4 id="_ビルドの視覚化">12.1.2. ビルドの視覚化</h4>
<div class="paragraph"><p><em>parallel_debug</em> という名前のWafツールはWafモジュールにコードをインジェクションするために使われ、詳細な実行トレースを取得する。
このモジュールはフォルダ <tt>waflib/extras</tt> で提供され、使用前にプロジェクトでインポートされなくてはならない：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'parallel_debug'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'parallel_debug'</span><span style="color: #000000">,</span><span style="color: #000000"> tooldir</span><span style="color: #000000">=</span><span style="color: #009900">'.'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">bld</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #009900">'touch ${TGT}'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'foo'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>実行するとファイル <tt>pdebug.svg</tt> にビルド中に実行されたタスクのダイアグラムを生成する：</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="pdebug.png" alt="並列実行ダイアグラム" />
</div>
</div>
<div class="paragraph"><p>詳細はスペース区切の値としてファイル <tt>pdebug.dat</tt> に生成される。
このファイルは他のダイアグラムを得るためにGnuplotなどの他のアプリケーションによって処理することができる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">#! /usr/bin/env gnuplot</span></span>
<span style="color: #000000">set terminal png</span>
<span style="color: #000000">set output "output.png"</span>
<span style="color: #000000">set ylabel "Amount of active threads"</span>
<span style="color: #000000">set xlabel "Time in seconds"</span>
<span style="color: #000000">set title "Active threads on a parallel build (waf -j5)"</span>
<span style="color: #000000">unset label</span>
<span style="color: #000000">set yrange [-0.1:5.2]</span>
<span style="color: #000000">set ytic 1</span>
<span style="color: #000000">plot 'pdebug.dat' using 3:7 with lines title "" lt 2</span></tt></pre></div></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="dev.png" alt="ビルド中のスレッドアクティビティ" />
</div>
</div>
<div class="paragraph"><p>データファイルフォーマットは次のようになる：</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 3. pdebugファイルフォーマット</caption>
<col width="11%" />
<col width="22%" />
<col width="66%" />
<thead>
<tr>
<th align="left" valign="top">カラム </th>
<th align="left" valign="top"> 型 </th>
<th align="left" valign="top"> 説明</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">1</p></td>
<td align="left" valign="top"><p class="table">int</p></td>
<td align="left" valign="top"><p class="table">開始もしくは終了したタスクをもつスレッドの識別子</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">2</p></td>
<td align="left" valign="top"><p class="table">int</p></td>
<td align="left" valign="top"><p class="table">処理されるタスクの識別子</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">3</p></td>
<td align="left" valign="top"><p class="table">float</p></td>
<td align="left" valign="top"><p class="table">イベント時刻</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">4</p></td>
<td align="left" valign="top"><p class="table">string</p></td>
<td align="left" valign="top"><p class="table">処理されるタスクの型</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">5</p></td>
<td align="left" valign="top"><p class="table">int</p></td>
<td align="left" valign="top"><p class="table">処理されるタスク数</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">6</p></td>
<td align="left" valign="top"><p class="table">int</p></td>
<td align="left" valign="top"><p class="table">タスクコンシューマによって処理されるのを待機しているタスク数</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">7</p></td>
<td align="left" valign="top"><p class="table">int</p></td>
<td align="left" valign="top"><p class="table">アクティブなスレッド数</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_プロファイリング">12.2. プロファイリング</h3>
<div class="sect3">
<h4 id="_プロジェクトのベンチマーク">12.2.1. プロジェクトのベンチマーク</h4>
<div class="paragraph"><p>スクリプト <tt>utils/genbench.py</tt> は巨大なCライクなプロジェクトファイルを作るベースとなる。
一般的な使い方は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ utils/genbench.py /tmp/build 50 100 15 5</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ cd /tmp/build</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ waf configure</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ waf -p -j2</span></span></tt></pre></div></div>
<div class="paragraph"><p>作成されたC++プロジェクトは100のクラスからそれぞれ50のライブラリを生成し、それぞれのソースファイルは同一のライブラリを指し示す15のインクルードヘッダと5つのランダムに選ばれた他のヘッダを指し示すヘッダをもつ。</p></div>
<div class="paragraph"><p>コンパイル時間は実際のコンパイルを無効にすることで簡単に捨てることができる。
例：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="color: #000000">        </span><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">touch_func</span><span style="color: #000000">(</span><span style="color: #000000">task</span><span style="color: #000000">):</span>
<span style="color: #000000">                </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> task</span><span style="color: #000000">.</span><span style="color: #000000">outputs</span><span style="color: #000000">:</span>
<span style="color: #000000">                        x</span><span style="color: #000000">.</span><span style="color: #000000">write</span><span style="color: #000000">(</span><span style="color: #009900">''</span><span style="color: #000000">)</span>
<span style="color: #000000">        </span><span style="color: #000080">for</span><span style="color: #000000"> x </span><span style="color: #000080">in</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">TaskBase</span><span style="color: #000000">.</span><span style="color: #000000">classes</span><span style="color: #000000">.</span><span style="color: #000000">keys</span><span style="color: #000000">():</span>
<span style="color: #000000">                cls </span><span style="color: #000000">=</span><span style="color: #000000"> Task</span><span style="color: #000000">.</span><span style="color: #000000">TaskBase</span><span style="color: #000000">.</span><span style="color: #000000">classes</span><span style="color: #000000">[</span><span style="color: #000000">x</span><span style="color: #000000">]</span>
<span style="color: #000000">                cls</span><span style="color: #000000">.</span><span style="color: #000000">func </span><span style="color: #000000">=</span><span style="color: #000000"> touch_func</span>
<span style="color: #000000">                cls</span><span style="color: #000000">.</span><span style="color: #000000">color </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'CYAN'</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_トレースのプロファイリング">12.2.2. トレースのプロファイリング</h4>
<div class="paragraph"><p>プロファイリングの情報はcProfileモジュールを呼出し、特定のコードを埋め込むことで取得される。
プロファイリングのためのもっとも興味深いメソッドは <em>waflib.Build.BuildContext.compile</em> だ。
関数呼出しの数は通常ボトルネックとなり、減らすことで大きなスピードアップが得られる。
これはコンパイルメソッドでの例だ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Build </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> BuildContext</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">ncomp</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> cProfile</span><span style="color: #000000">,</span><span style="color: #000000"> pstats</span>
<span style="color: #000000">        cProfile</span><span style="color: #000000">.</span><span style="color: #000000">runctx</span><span style="color: #000000">(</span><span style="color: #009900">'self.orig_compile()'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">{},</span><span style="color: #000000"> </span><span style="color: #000000">{</span><span style="color: #009900">'self'</span><span style="color: #000000">:</span><span style="color: #000000"> self</span><span style="color: #000000">},</span><span style="color: #000000"> </span><span style="color: #009900">'profi.txt'</span><span style="color: #000000">)</span>
<span style="color: #000000">        p </span><span style="color: #000000">=</span><span style="color: #000000"> pstats</span><span style="color: #000000">.</span><span style="color: #000000">Stats</span><span style="color: #000000">(</span><span style="color: #009900">'profi.txt'</span><span style="color: #000000">)</span>
<span style="color: #000000">        p</span><span style="color: #000000">.</span><span style="color: #000000">sort_stats</span><span style="color: #000000">(</span><span style="color: #009900">'time'</span><span style="color: #000000">).</span><span style="color: #000000">print_stats</span><span style="color: #000000">(</span><span style="color: #000000">45</span><span style="color: #000000">)</span>

<span style="color: #000000">BuildContext</span><span style="color: #000000">.</span><span style="color: #000000">orig_compile </span><span style="color: #000000">=</span><span style="color: #000000"> BuildContext</span><span style="color: #000000">.</span><span style="color: #000000">compile</span>
<span style="color: #000000">BuildContext</span><span style="color: #000000">.</span><span style="color: #000000">compile </span><span style="color: #000000">=</span><span style="color: #000000"> ncomp</span></tt></pre></div></div>
<div class="paragraph"><p>これは前のセクションで説明したビルドのベンチマークのアウトプットだ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">Fri Jul 23 15:11:15 2010    profi.txt</span>

<span style="color: #000000">         1114979 function calls (1099879 primitive calls) in 5.768 CPU seconds</span>

<span style="color: #000000">   Ordered by: internal time</span>
<span style="color: #000000">   List reduced from 139 to 45 due to restriction 45</span>

<span style="color: #000000">   ncalls  tottime  percall  cumtime  percall filename:lineno(function)</span>
<span style="color: #000000">   109500    0.523    0.000    1.775    0.000 /comp/waf/waflib/Node.py:615(get_bld_sig)</span>
<span style="color: #000000">     5000    0.381    0.000    1.631    0.000 /comp/waf/waflib/Task.py:475(compute_sig_implicit_deps)</span>
<span style="color: #000000">   154550    0.286    0.000    0.286    0.000 {method 'update' of '_hashlib.HASH' objects}</span>
<span style="color: #000000">   265350    0.232    0.000    0.232    0.000 {id}</span>
<span style="color: #000000">40201/25101    0.228    0.000    0.228    0.000 /comp/waf/waflib/Node.py:319(abspath)</span>
<span style="color: #000000">    10000    0.223    0.000    0.223    0.000 {open}</span>
<span style="color: #000000">    20000    0.197    0.000    0.197    0.000 {method 'read' of 'file' objects}</span>
<span style="color: #000000">    15000    0.193    0.000    0.349    0.000 /comp/waf/waflib/Task.py:270(uid)</span>
<span style="color: #000000">    10000    0.189    0.000    0.850    0.000 /comp/waf/waflib/Utils.py:96(h_file)</span></tt></pre></div></div>
<div class="paragraph"><p>既知のいくつかのホットスポットがライブラリに存在する：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
cPickleモジュールによって実装された永続化(シリアライズのためのキャッシュファイルは数メガバイト消費することがある)
</p>
</li>
<li>
<p>
Environmentインスタンスからのコンフィギュレーションデータへのアクセス
</p>
</li>
<li>
<p>
一般的な暗黙の依存関係の計算
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_最適化のtips">12.2.3. 最適化のTips</h4>
<div class="paragraph"><p>wafのソースコードはすでにさまざまな方法で最適化が施されている。
実際、プロジェクトでは追加的な想定が使われておりビルドスクリプトのあるメソッドやパラメータは置換される。
例えば、Windowsで実行されるならば、変数 <em>framework</em> と <em>rpath</em> は削除される：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Tools</span><span style="color: #000000">.</span><span style="color: #000000">ccroot </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> USELIB_VARS</span>
<span style="color: #000000">USELIB_VARS</span><span style="color: #000000">[</span><span style="color: #009900">'cprogram'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> USELIB_VARS</span><span style="color: #000000">[</span><span style="color: #009900">'cxxprogram'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">\</span>
<span style="color: #000000">        </span><span style="color: #000000">set</span><span style="color: #000000">([</span><span style="color: #009900">'LIB'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'STLIB'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'LIBPATH'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'STLIBPATH'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'LINKFLAGS'</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #009900">'LINKDEPS'</span><span style="color: #000000">])</span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_wafプログラミング">12.3. Wafプログラミング</h3>
<div class="sect3">
<h4 id="_開発用のwafディレクトリのセットアップ">12.3.1. 開発用のWafディレクトリのセットアップ</h4>
<div class="paragraph"><p>Wafは <a href="http://code.google.com/p/waf/source">Google code</a> でホスティングされており、ソースコントロールにSubversionを使用している。
開発バージョンのコピーを得るには、次を使用：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ svn checkout http://waf.googlecode.com/svn/trunk/ waf-read-only</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ cd waf-read-only</span></span>
<span style="font-weight: bold"><span style="color: #993399">$ ./waf-light --make-waf</span></span></tt></pre></div></div>
<div class="paragraph"><p>Wafを毎回生成するのを避けるために、環境変数 <strong>WAFDIR</strong> は <em>waflib</em> を含むディレクトリを指し示すべきだ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ export WAFDIR=/path/to/directory/</span></span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_特定のガイドライン">12.3.2. 特定のガイドライン</h4>
<div class="paragraph"><p>Wafはpythonで書かれているが、ソースコードには他にも追加で制限が適用されている：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
インデントはタブのみで1行の最大の文字数は200
</p>
</li>
<li>
<p>
開発コードはToolsディレクトリ以下のデコレータは例外だが、Python2.3との互換性を保っている。特にWafのバイナリはPython2.3で生成できる
</p>
</li>
<li>
<p>
Wafのコアを小さく、言語から独立に保つために <em>waflib</em> モジュールは <em>Tools</em> モジュールから隔離されなくてはならない
</p>
</li>
<li>
<p>
APIの互換性はマイナーバージョンのサイクルでメンテナンスされる(1.5.0から1.5.n)
</p>
</li>
</ol></div>
<div class="paragraph"><p>備考: コードが多くなると常にバグが増える。可能ならばいつでも不要なコードは削除されなくてはならないし、存在するコードベースはシンプルであるべきだ。</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wafアーキテクチャ概要">13. Wafアーキテクチャ概要</h2>
<div class="sectionbody">
<div class="paragraph"><p>この章では、Wafライブラリとコンポーネント間のインタラクションについて記述する。</p></div>
<div class="sect2">
<h3 id="_モジュールとクラス">13.1. モジュールとクラス</h3>
<div class="sect3">
<h4 id="_コアとなるモジュール">13.1.1. コアとなるモジュール</h4>
<div class="paragraph"><p>Wafはコアライブラリを構成する次のモジュールにより構成される。
これらのモジュールは <tt>waflib/</tt> ディレクトリに置かれている。
<tt>waflib/Tools</tt> と <tt>waflib/extras</tt> に配置されているモジュールはWafのコアモジュールには含まれない拡張モジュールだ。</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 4. コアモジュールのリスト</caption>
<col width="14%" />
<col width="85%" />
<thead>
<tr>
<th align="left" valign="top">モジュール   </th>
<th align="left" valign="top"> 役割</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">Build</p></td>
<td align="left" valign="top"><p class="table">ひとつのビルドに対するデータ(パス、コンフィギュレーションデータ)を保持するビルドコンテキストクラス(build, clean, install, uninstall)の定義</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Configure</p></td>
<td align="left" valign="top"><p class="table">コンフィギュレーションコンテキストクラスを含む。言語のコンフィギュレーションテストおよびビルド用のコンフィギュレーションセッティングの記述のために使われる</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">ConfigSet</p></td>
<td align="left" valign="top"><p class="table">軽量のコピースキームをサポートし、永続サービスを提供するディクショナリクラスを提供する</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Context</p></td>
<td align="left" valign="top"><p class="table">すべてのWafコマンドのベースクラスを含む (Wafコマンドのコンテキストパラメータ)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Errors</p></td>
<td align="left" valign="top"><p class="table">Wafのコードで使われる例外</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Logs</p></td>
<td align="left" valign="top"><p class="table">Pythonのloggingモジュールの呼出をラップするロギングシステム</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Node</p></td>
<td align="left" valign="top"><p class="table">ファイルシステムを表現するクラスを含む</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Options</p></td>
<td align="left" valign="top"><p class="table">optparseを元にした、カスタムのコマンドラインを処理するシステムを提供する</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Runner</p></td>
<td align="left" valign="top"><p class="table">タスク実行システムを含む (スレッドベースのプロデューサ-コンシューマ)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Scripting</p></td>
<td align="left" valign="top"><p class="table">Wafのエントリポイント、ビルドなどのユーザーコマンドの実行、コンフィギュレーション、インストールを構成する</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">TaskGen</p></td>
<td align="left" valign="top"><p class="table">タスクジェネレータシステムとメソッドの追加に基づくその実行システムを提供する</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Task</p></td>
<td align="left" valign="top"><p class="table">タスククラスの定義と新たなタスククラスを作るためのファクトリ関数を含む</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Utils</p></td>
<td align="left" valign="top"><p class="table">他のWafモジュールから使われる補助関数およびクラスを含む</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>Wafをライブラリとして使うためにすべてのコアモジュールが必要というわけではない。
モジュール間の依存関係は次のダイアグラムにより表現される。
例えば、 <em>Node</em> モジュールは <em>Utils</em> と <em>Errors</em> モジュールを必要とする。
逆に、 <em>Build</em> モジュールが単独で使われるならば 、 <em>Scripting</em> と <em>Configure</em> モジュールは安全に取り除くことができる。</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="core.png" alt="モジュールの依存関係" />
</div>
</div>
</div>
<div class="sect3">
<h4 id="_コンテキストクラス">13.1.2. コンテキストクラス</h4>
<div class="paragraph"><p><em>configure</em> や <em>build</em> などのユーザーコマンドは <em>waflib.Context.Context</em> から派生したクラスとして表現される。
関連付けられたクラスがないコマンドの場合、 <em>waflib.Context.Context</em> が替わりに使われる。</p></div>
<div class="paragraph"><p><em>execute</em> メソッドはコンテキスト実行のスタートポイントで、ユーザーのスクリプトを読込み、 <em>fun</em> クラスアトリビュートで参照される関数の実行を開始する <em>recurse</em> メソッドを度々呼び出す。</p></div>
<div class="paragraph"><p>コマンドは <em>cmd</em> クラスアトリビュートによってコンテキストクラスに関連付けられる。
コンテキストサブクラスは <em>store_context</em> メタクラスによって <em>waflib.Context.classes</em> に追加され、 <em>waflib.Context.create_context</em> を通してロードされる。
最後に定義されたクラスによって既存のコマンドを上書きされる。</p></div>
<div class="paragraph"><p>例のように、次のコンテキストクラスは <em>configure</em> コマンドを定義または上書きする。
<em>waf configure</em> を呼び出す場合、wscriptから <em>foo</em> 関数が呼び出される：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Context </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Context</span>
<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">somename</span><span style="color: #000000">(</span><span style="color: #000000">Context</span><span style="color: #000000">):</span>
<span style="color: #000000">    cmd </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'configure'</span>
<span style="color: #000000">    fun </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'foo'</span></tt></pre></div></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="classes.png" alt="コンテキストクラス" />
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ビルドクラス">13.1.3. ビルドクラス</h4>
<div class="paragraph"><p>クラス <em>waflib.Build.BuildContext</em> と <em>waflib.Build.InstallContext</em> や <em>waflib.Build.StepContext</em> のような、そのサブクラスはユーザースクリプトを読んだときに作られるタスクジェネレータをもつ。
タスクジェネレータは通常タスクインスタンスをもち、すべてのタスクジェネレータ処理後に実行されるオペレーションに依存する。</p></div>
<div class="paragraph"><p><em>ConfigSet</em> インスタンスはタスク(<em>waflib.ConfigSet.ConfigSet.derive</em>)に対するビルドコンテキストからコピーされ、コンフィギュレーションフラグのような値が伝搬する。
コピーオンライトはそのクラスのほとんどのメソッド(append_value, prepend_value, append_unique)を通じて実行される。</p></div>
<div class="paragraph"><p><em>Parallel</em> オブジェクトはビルドコンテキストのすべてのタスクに対するイテレーションをカプセル化し、スレッドオブジェクトに実行を移譲する(producer-consumer)。</p></div>
<div class="paragraph"><p>全体の構造は次のダイアグラムに表現される：</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<img src="classes_build.png" alt="ビルドクラス" />
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_コンテキストオブジェクト">13.2. コンテキストオブジェクト</h3>
<div class="sect3">
<h4 id="_コンテキストコマンドと再帰">13.2.1. コンテキストコマンドと再帰</h4>
<div class="paragraph"><p>コンテキストコマンドは可能な限り独立なものとして設計されており、並列に実行することができる。
主な適用例はコンフィギュレーションテストの一部として小さなビルドを実行することである。
例えば、メソッド <em>waflib.Tools.c_config.run_c_code</em> はテストを実行するためにプライベートなビルドコンテキストを内部的に作成する。
これは単純なコンフィギュレーションコンテキストの作成と実行を並列に行うビルドの例だ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> os</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Configure </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> conf</span><span style="color: #000000">,</span><span style="color: #000000"> ConfigurationContext</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span><span style="color: #000000">,</span><span style="color: #000000"> Build</span><span style="color: #000000">,</span><span style="color: #000000"> Logs</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">options</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'compiler_c'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #000000">run_test</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> header_name</span><span style="color: #000000">=</span><span style="color: #009900">'stdio.h'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">rule</span><span style="color: #000000">=</span><span style="color: #000000">run_test</span><span style="color: #000000">,</span><span style="color: #000000"> always</span><span style="color: #000000">=</span><span style="color: #000000">True</span><span style="color: #000000">,</span><span style="color: #000000"> header_name</span><span style="color: #000000">=</span><span style="color: #009900">'unistd.h'</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">run_test</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span>
<span style="color: #000000">        top </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">srcnode</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span>
<span style="color: #000000">        out </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">bldnode</span><span style="color: #000000">.</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span>

<span style="color: #000000">        ctx </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">ConfigurationContext</span><span style="color: #000000">(</span><span style="color: #000000">top_dir</span><span style="color: #000000">=</span><span style="color: #000000">top</span><span style="color: #000000">,</span><span style="color: #000000"> out_dir</span><span style="color: #000000">=</span><span style="color: #000000">out</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">init_dirs</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>

<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">in_msg </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #000000">1</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">msg</span><span style="color: #000000">(</span><span style="color: #009900">'test'</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/5.png" alt="5" /></span>

<span style="color: #000000">        header </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">header_name</span>
<span style="color: #000000">        logfile </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">generator</span><span style="color: #000000">.</span><span style="color: #000000">path</span><span style="color: #000000">.</span><span style="color: #000000">get_bld</span><span style="color: #000000">().</span><span style="color: #000000">abspath</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000">+</span><span style="color: #000000"> os</span><span style="color: #000000">.</span><span style="color: #000000">sep </span><span style="color: #000000">\</span>
<span style="color: #000000">                </span><span style="color: #000000">+</span><span style="color: #000000"> header </span><span style="color: #000000">+</span><span style="color: #000000"> </span><span style="color: #009900">'.log'</span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">logger </span><span style="color: #000000">=</span><span style="color: #000000"> Logs</span><span style="color: #000000">.</span><span style="color: #000000">make_logger</span><span style="color: #000000">(</span><span style="color: #000000">logfile</span><span style="color: #000000">,</span><span style="color: #000000"> header</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/6.png" alt="6" /></span>

<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">env </span><span style="color: #000000">=</span><span style="color: #000000"> self</span><span style="color: #000000">.</span><span style="color: #000000">env</span><span style="color: #000000">.</span><span style="color: #000000">derive</span><span style="color: #000000">()</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/7.png" alt="7" /></span>
<span style="color: #000000">        ctx</span><span style="color: #000000">.</span><span style="color: #000000">check</span><span style="color: #000000">(</span><span style="color: #000000">header_name</span><span style="color: #000000">=</span><span style="color: #000000">header</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/8.png" alt="8" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
下で定義された <em>run_test</em> メソッドを実行するタスクジェネレータの作成
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
<em>Task.run</em> の呼出しの一部である新たなコンフィギュレーションコンテキストの作成
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
ctx.srcnodeとctx.bldnodeの初期化 (ビルドコンテキストとコンフィギュレーションコンテキストのみ)
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
メソッド <em>msg</em> 、 <em>start_msg</em> 、 <em>end_msg</em> への内部カウンタを設定
</td></tr>
<tr><td><img src="./callouts/5.png" alt="5" /></td><td>
コンソール出力を無効化(カウンター値が非ゼロでネストされたメッセージの無効化)
</td></tr>
<tr><td><img src="./callouts/6.png" alt="6" /></td><td>
それぞれのコンテキストはエラーメッセージに対してリダイレクトするロガーをもつことができる。
</td></tr>
<tr><td><img src="./callouts/7.png" alt="7" /></td><td>
コピーされたタスクに対するデフォルト環境の初期化
</td></tr>
<tr><td><img src="./callouts/8.png" alt="8" /></td><td>
コンフィギュレーションチェックの実行
</td></tr>
</table></div>
<div class="paragraph"><p><em>waf build</em> の実行後、プロジェクトフォルダは新しいログファイルができる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ tree</span></span>
<span style="color: #000000">.</span>
<span style="color: #000000">|-- build</span>
<span style="color: #000000">|   |-- c4che</span>
<span style="color: #000000">|   |   |-- build.config.py</span>
<span style="color: #000000">|   |   `-- _cache.py</span>
<span style="color: #000000">|   |-- config.log</span>
<span style="color: #000000">|   |-- stdio.h.log</span>
<span style="color: #000000">|   `-- unistd.h.log</span>
<span style="color: #000000">`-- wscript</span></tt></pre></div></div>
<div class="paragraph"><p>コンテキストが並列に実行されることを保証するために、いくつかのmeasuresが設定されている：</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
コンテキストオブジェクトは <em>waflib.Logs</em> モジュールから派生した異なるロガーを使うことができる。
</p>
</li>
<li>
<p>
それぞれのコンテキストオブジェクトは <em>waflib.Node.Node</em> のプライベートなサブクラスに関連付けられており、ノードオブジェクトがユニークであることが保証される。 ノードオブジェクトをピックル化するために、ロックオブジェクト <em>waflib.Node.pickle_lock</em> によって並行アクセスを避けることが重要である。
</p>
</li>
</ol></div>
</div>
<div class="sect3">
<h4 id="_ビルドコンテキストと永続性">13.2.2. ビルドコンテキストと永続性</h4>
<div class="paragraph"><p>ビルドコンテキストはビルドに必要なすべての情報を保持する。
起動を高速化するために、一部の情報は起動の合間で保存され読み込まれる。
永続化されるアトリビュートを次に示す：</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 5. Persistent attributes</caption>
<col width="14%" />
<col width="42%" />
<col width="42%" />
<thead>
<tr>
<th align="left" valign="top">アトリビュート       </th>
<th align="left" valign="top"> Description                    </th>
<th align="left" valign="top"> タイプ</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">root</p></td>
<td align="left" valign="top"><p class="table">ファイルシステムのルートを表現するノード</p></td>
<td align="left" valign="top"><p class="table">ノード</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">node_deps</p></td>
<td align="left" valign="top"><p class="table">暗黙の依存性</p></td>
<td align="left" valign="top"><p class="table">ノードとシグネチャを結びつけるdict</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">raw_deps</p></td>
<td align="left" valign="top"><p class="table">解決できない暗黙のファイル依存性</p></td>
<td align="left" valign="top"><p class="table">ノードIDとシリアライズの型を結びつけるdict</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">task_sigs</p></td>
<td align="left" valign="top"><p class="table">実行されるタスクのシグネチャ</p></td>
<td align="left" valign="top"><p class="table">タスクの計算されたuidとハッシュを結びつけるdict</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_c_likeな言語のサポート">13.3. c-likeな言語のサポート</h3>
<div class="sect3">
<h4 id="_コンパイルタスクとリンクタスク">13.3.1. コンパイルタスクとリンクタスク</h4>
<div class="paragraph"><p><em>waflib.Tools.ccroot</em> はオブジェクトファイルを生成し、それらをひとつの最終的なファイルにリンクするシステムを提供する。
メソッド <em>waflib.Tools.ccroot.apply_link</em> はメソッド <em>waflib.TaskGen.process_source</em> の後に呼び出されリンクタスクを生成する。
疑似コード:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">call the method process_source:</span>
<span style="color: #000000">  for each source file foo.ext:</span>
<span style="color: #000000">    process the file by extension</span>
<span style="color: #000000">      if the method create_compiled_task is used:</span>
<span style="color: #000000">        create a new task</span>
<span style="color: #000000">        set the output file name to be foo.ext.o</span>
<span style="color: #000000">        add the task to the list self.compiled_tasks</span>

<span style="color: #000000">call the method apply_link</span>
<span style="color: #000000">  for each name N in self.features:</span>
<span style="color: #000000">    find a class named N:</span>
<span style="color: #000000">      if the class N derives from 'waflib.Tools.ccroot.link_task':</span>
<span style="color: #000000">        create a task of that class, assign it to self.link_task</span>
<span style="color: #000000">        set the link_task inputs from self.compiled_tasks</span>
<span style="color: #000000">        set the link_task output name to be env.N_PATTERN % self.target</span>
<span style="color: #000000">        stop</span></tt></pre></div></div>
<div class="paragraph"><p>このシステムは <em>assembly</em>, <em>C</em>, <em>C++</em>, <em>D</em> と <em>fortran</em> にデフォルトで使われる。
ちなみにメソッド <em>apply_link</em> はメソッド <em>process_source</em> の後で呼ばれることが想定されている。</p></div>
<div class="paragraph"><p>ここで、ミニ言語のサポートの仕方を示そう：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">cp: .ext -&gt; .o</span>
<span style="color: #000000">cat: *.o -&gt; .exe</span></tt></pre></div></div>
<div class="paragraph"><p>これがプロジェクトファイルだ：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000080">pass</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">        </span><span style="color: #000000">ctx</span><span style="color: #000000">(</span><span style="color: #000000">features</span><span style="color: #000000">=</span><span style="color: #009900">'mylink'</span><span style="color: #000000">,</span><span style="color: #000000"> source</span><span style="color: #000000">=</span><span style="color: #009900">'foo.ext faa.ext'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'bingo'</span><span style="color: #000000">)</span>

<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Task </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> Task</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">TaskGen </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> feature</span><span style="color: #000000">,</span><span style="color: #000000"> extension</span><span style="color: #000000">,</span><span style="color: #000000"> after_method</span>
<span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Tools </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> ccroot </span><span style="color: #000000"><img src="./callouts/1.png" alt="1" /></span>

<span style="color: #000000">@</span><span style="color: #000000">after_method</span><span style="color: #000000">(</span><span style="color: #009900">'process_source'</span><span style="color: #000000">)</span>
<span style="color: #000000">@</span><span style="color: #000000">feature</span><span style="color: #000000">(</span><span style="color: #009900">'mylink'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">call_apply_link</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/2.png" alt="2" /></span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">apply_link</span><span style="color: #000000">()</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">mylink</span><span style="color: #000000">(</span><span style="color: #000000">ccroot</span><span style="color: #000000">.</span><span style="color: #000000">link_task</span><span style="color: #000000">):</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/3.png" alt="3" /></span>
<span style="color: #000000">        run_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cat ${SRC} &gt; ${TGT}'</span>

<span style="color: #000080">class</span><span style="color: #000000"> </span><span style="color: #000000">ext2o</span><span style="color: #000000">(</span><span style="color: #000000">Task</span><span style="color: #000000">):</span>
<span style="color: #000000">        run_str </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'cp ${SRC} ${TGT}'</span>

<span style="color: #000000">@</span><span style="color: #000000">extension</span><span style="color: #000000">(</span><span style="color: #009900">'.ext'</span><span style="color: #000000">)</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">process_ext</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">):</span>
<span style="color: #000000">        self</span><span style="color: #000000">.</span><span style="color: #000000">create_compiled_task</span><span style="color: #000000">(</span><span style="color: #009900">'ext2o'</span><span style="color: #000000">,</span><span style="color: #000000"> node</span><span style="color: #000000">)</span><span style="color: #000000"> </span><span style="color: #000000"><img src="./callouts/4.png" alt="4" /></span></tt></pre></div></div>
<div class="colist arabic"><table>
<tr><td><img src="./callouts/1.png" alt="1" /></td><td>
このインポートは <em>create_compiled_task</em> や <em>apply_link_task</em> のようなメソッドをバインドする
</td></tr>
<tr><td><img src="./callouts/2.png" alt="2" /></td><td>
代替の定義は <em>waflib.TaskGen.feats[&#8216;mylink&#8217;] = [&#8216;apply_link&#8217;]</em> を呼ぶ
</td></tr>
<tr><td><img src="./callouts/3.png" alt="3" /></td><td>
リンクタスクは他のリンクタスククラスのサブクラスでなくてはならない
</td></tr>
<tr><td><img src="./callouts/4.png" alt="4" /></td><td>
<em>create_compiled_task</em> メソッドの呼出し
</td></tr>
</table></div>
<div class="paragraph"><p>実行結果は次のようになる：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #993399">$ waf distclean configure build -v</span></span>
<span style="color: #000000">'distclean' finished successfully (0.005s)</span>
<span style="color: #000000">Setting top to   : /tmp/architecture_link</span>
<span style="color: #000000">Setting out to   : /tmp/architecture_link/build</span>
<span style="color: #000000">'configure' finished successfully (0.008s)</span>
<span style="color: #000000">Waf: Entering directory `/tmp/architecture_link/build'</span>
<span style="color: #000000">[1/3] ext2o: foo.ext -&gt; build/foo.ext.0.o</span>
<span style="color: #000000">12:50:25 runner ['cp', '../foo.ext', 'foo.ext.0.o']</span>
<span style="color: #000000">[2/3] ext2o: faa.ext -&gt; build/faa.ext.0.o</span>
<span style="color: #000000">12:50:25 runner ['cp', '../faa.ext', 'faa.ext.0.o']</span>
<span style="color: #000000">[3/3] mylink: build/foo.ext.0.o build/faa.ext.0.o -&gt; build/bingo</span>
<span style="color: #000000">12:50:25 runner 'cat foo.ext.0.o faa.ext.0.o &gt; bingo'</span>
<span style="color: #000000">Waf: Leaving directory `/tmp/architecture_link/build'</span>
<span style="color: #000000">'build' finished successfully (0.041s)</span></tt></pre></div></div>
<div class="paragraph"><p>備考： タスクジェネレータのインスタンスは最大1つのリンクタスクのインスタンスを持つ</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_再利用可能なwafツールを書く">13.4. 再利用可能なwafツールを書く</h3>
<div class="sect3">
<h4 id="_wafツールの追加">13.4.1. Wafツールの追加</h4>
<div class="sect4">
<h5 id="_コードのインポート">コードのインポート</h5>
<div class="paragraph"><p>Wafツールの目的は、すべての概念的に関連したメソッドとクラスを分離されたファイルに移動し、Wafのコアから隠蔽し、可能な限り互いを独立させることで高い凝縮度をすすめることだ。</p></div>
<div class="paragraph"><p>カスタムのWafツールはプオジェクトに残すことができ、<em>waflib/extras</em> フォルダもしくは <em>sys.path</em> の変更によってカスタムのWafファイルに追加することができる。</p></div>
<div class="paragraph"><p>ツールは <em>import</em> キーワードによって直接他のツールをインポートすることができる。
しかしながら、カップリングを制限するために常に <em>ctx.load</em> にツールをインポートするべきである。
例を比較：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">extras</span><span style="color: #000000">.</span><span style="color: #000000">foo </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> method1</span>
<span style="color: #000000">    </span><span style="color: #000000">method1</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>そして:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">configure</span><span style="color: #000000">(</span><span style="color: #000000">ctx</span><span style="color: #000000">):</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">load</span><span style="color: #000000">(</span><span style="color: #009900">'foo'</span><span style="color: #000000">)</span>
<span style="color: #000000">    ctx</span><span style="color: #000000">.</span><span style="color: #000000">method1</span><span style="color: #000000">()</span></tt></pre></div></div>
<div class="paragraph"><p><em>method1</em> がモジュール <em>foo</em> からきたのか否か、モジュール <em>foo</em> が存在する場所、それぞれに関しての想定が少ないため、2番目のバージョンの方が望ましい。</p></div>
</div>
<div class="sect4">
<h5 id="_c_c_fortranの命名の慣習">C/C++/Fortranの命名の慣習</h5>
<div class="paragraph"><p>ツール <em>compiler_c</em> や <em>compiler_cxx</em> 、 <em>compiler_fc</em> は特定のコンパイラの検出のために他のWafツールを使う。
ユーザースクリプトで新しいツールにそれ自身を自動的に登録しインポートを保存する機会を与えるために、特定の命名の慣習を提供する。
名前が <em>c_</em> や <em>cxx_</em> もしくは <em>fc_</em> ではじまるツールがテストされる。</p></div>
<div class="paragraph"><p>レジストレーションコードは次のようなものになるだろう：</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Tools</span><span style="color: #000000">.</span><span style="color: #000000">compiler_X </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> X_compiler</span>
<span style="color: #000000">X_compiler</span><span style="color: #000000">[</span><span style="color: #009900">'platform'</span><span style="color: #000000">].</span><span style="color: #000000">append</span><span style="color: #000000">(</span><span style="color: #009900">'module_name'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>ここで <strong>X</strong> はコンパイラのタイプ(<em>c</em>, <em>cxx</em> や <em>fc</em>)を表し, <strong>platform</strong> は判定が行われるプラットフォーム(linux, win32, など)を表し、<strong>module_name</strong> はツールの名前を表す。</p></div>
</div>
</div>
<div class="sect3">
<h4 id="_コマンドメソッド">13.4.2. コマンドメソッド</h4>
<div class="sect4">
<h5 id="_サブクラス化はコマンドのためだけ">サブクラス化はコマンドのためだけ</h5>
<div class="paragraph"><p>一般的なルールとして、 <em>waflib.Context.Context</em> のサブクラスは新しいコマンドが必要なときにのみ作られる。
これは特定のvariant(アウトプットフォルダ)向けのコマンドが必要な場合や、新たな振舞いを提供する例でのケースだ。
このことが起きる場合、クラスメソッド <em>recurse</em> 、 <em>execute</em> やクラスアトリビュート <em>cmd</em> 、 <em>fun</em> は通常上書きされる。</p></div>
<div class="paragraph"><p>備考： もし新しいコマンドが必要ないならばサブクラス化は使わなくてよい</p></div>
</div>
<div class="sect4">
<h5 id="_エンドユーザーへの利便性のためのドメイン固有のメソッド">エンドユーザーへの利便性のためのドメイン固有のメソッド</h5>
<div class="paragraph"><p>Wafフレームワークはタスクジェネレータを宣言する最大限柔軟な方法を推進するが、巨大なプロジェクトではドメイン固有のラッパーを宣言することがしばしばより便利なことがある。
例えば、sambaプロジェクトでは次のように使われる関数を提供する:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #000000">bld</span><span style="color: #000000">.</span><span style="color: #000000">SAMBA_SUBSYSTEM</span><span style="color: #000000">(</span><span style="color: #009900">'NDR_NBT_BUF'</span><span style="color: #000000">,</span>
<span style="color: #000000">    source    </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'nbtname.c'</span><span style="color: #000000">,</span>
<span style="color: #000000">    deps      </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'talloc'</span><span style="color: #000000">,</span>
<span style="color: #000000">    autoproto </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'nbtname.h'</span>
<span style="color: #000000">    </span><span style="color: #000000">)</span></tt></pre></div></div>
</div>
<div class="sect4">
<h5 id="_新しいメソッドへのバインド方法">新しいメソッドへのバインド方法</h5>
<div class="paragraph"><p>新しいメソッドは <em>@conf</em> デコレータを使って、ビルドコンテキストもしくはコンフィギュレーションコンテキストに共通にバインドされる:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.4
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #008080">from</span></span><span style="color: #000000"> waflib</span><span style="color: #000000">.</span><span style="color: #000000">Configure </span><span style="font-weight: bold"><span style="color: #008080">import</span></span><span style="color: #000000"> conf</span>

<span style="color: #000000">@conf</span>
<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">enterprise_program</span><span style="color: #000000">(</span><span style="color: #000000">self</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">*</span><span style="color: #000000">k</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">**</span><span style="color: #000000">kw</span><span style="color: #000000">):</span>
<span style="color: #000000">    kw</span><span style="color: #000000">[</span><span style="color: #009900">'features'</span><span style="color: #000000">]</span><span style="color: #000000"> </span><span style="color: #000000">=</span><span style="color: #000000"> </span><span style="color: #009900">'c cprogram debug_tasks'</span>
<span style="color: #000000">    </span><span style="color: #000080">return</span><span style="color: #000000"> </span><span style="color: #000000">self</span><span style="color: #000000">(*</span><span style="color: #000000">k</span><span style="color: #000000">,</span><span style="color: #000000"> </span><span style="color: #000000">**</span><span style="color: #000000">kw</span><span style="color: #000000">)</span>

<span style="color: #000080">def</span><span style="color: #000000"> </span><span style="color: #000000">build</span><span style="color: #000000">(</span><span style="color: #000000">bld</span><span style="color: #000000">):</span>
<span style="color: #000000">    </span><span style="color: #808080"># no feature line</span>
<span style="color: #000000">    bld</span><span style="color: #000000">.</span><span style="color: #000000">enterprise_program</span><span style="color: #000000">(</span><span style="color: #000000">source</span><span style="color: #000000">=</span><span style="color: #009900">'main.c'</span><span style="color: #000000">,</span><span style="color: #000000"> target</span><span style="color: #000000">=</span><span style="color: #009900">'app'</span><span style="color: #000000">)</span></tt></pre></div></div>
<div class="paragraph"><p>サブクラス化では異なる目的のために書かれたツール間での衝突が起り得るため、メソッドは常にこのような方法か手動でバインドするべきだ。</p></div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_further_reading">14. Further reading</h2>
<div class="sectionbody">
<div class="paragraph"><p>Wafが提供する機能が多いため、この本では機能を網羅し最新の情報を伝えることはできない。
さらなる理解と実践のために、読者に次のリンクを推奨する：</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 6. Recommended links</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top">リンク</th>
<th align="left" valign="top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><a href="http://docs.waf.googlecode.com/git/apidocs_16/index.html">http://docs.waf.googlecode.com/git/apidocs_16/index.html</a></p></td>
<td align="left" valign="top"><p class="table">APIドキュメント</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><a href="http://code.google.com/p/waf">http://code.google.com/p/waf</a></p></td>
<td align="left" valign="top"><p class="table">Wafプロジェクトのページ</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><a href="http://code.google.com/p/waf/w/list">http://code.google.com/p/waf/w/list</a></p></td>
<td align="left" valign="top"><p class="table">FAQを含むWafのwiki</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><a href="http://groups.google.com/group/waf-users">http://groups.google.com/group/waf-users</a></p></td>
<td align="left" valign="top"><p class="table">Wafのメーリングリスト</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><a href="http://waf-devel.blogspot.com/2011/01/python-32-and-build-system-kit.html">http://waf-devel.blogspot.com/2011/01/python-32-and-build-system-kit.html</a></p></td>
<td align="left" valign="top"><p class="table">ビルドシステムキットに関する情報</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_用語集">15. 用語集</h2>
<div class="sectionbody">
<div class="dlist glossary"><dl>
<dt>
ビルド順序
</dt>
<dd>
<p>
        ビルド順序はタスクが実行される順序だ。タスクは並列に実行される可能性があり、ビルド順序はタスク間の制約から計算することができる。(通常、矛盾する順序制約によって)ビルド順序が計算できない場合、ビルドはデッドロックの状態にあるといわれる。
</p>
</dd>
<dt>
依存関係
</dt>
<dd>
<p>
        依存関係はタスクが最新の状態とみなせるか否かの条件を表す(実行ステータス)。依存関係は明示的(ファイルのインプットとアウトプット)もしくは抽象的(例えば値に対する依存関係)だ。
</p>
</dd>
<dt>
タスクジェネレータ
</dt>
<dd>
<p>
        タスクジェネレータはTask.task_genクラスのインスタンスだ。タスクジェネレータはさまざまなタスクインスタンスの生成をカプセル化し、それらのタスク間の順序制約の生成を簡略化する(例えば、コンパイルタスクはリンクタスクの前に実行される)。
</p>
</dd>
<dt>
タスク
</dt>
<dd>
<p>
        WafのタスクはTask.TaskBaseクラスのインスタンスだ。Wafのタスクは単純なもの(Task.TaskBase)、もしくはファイルシステムに関連付けられている(Task.Task)。タスクはビルドでの成果物(一般的にファイル)を表現し、(順序制約により)シーケンシャルもしくは並列に実行される。
</p>
</dd>
<dt>
ツール
</dt>
<dd>
<p>
        WafツールはWaf特有の拡張を含んだPythonモジュールだ。Wafツールは <tt>waflib/Tools/</tt> フォルダに存在し、通常、configureで実行される関数を参照するグローバル変数 <em>configure</em> を含む。
</p>
</dd>
<dt>
ノード
</dt>
<dd>
<p>
        Nodeクラスはファイルシステムを効率的に表現するために使われるデータ構造だ。ノードオブジェクトはファイルもしくはフォルダだ。ファイルノードはシグネチャオブジェクトと関連付けられている。シグネチャはファイルの中身のハッシュ(ソースファイル)かタスクシグネチャ(ビルドファイル)だ。
</p>
</dd>
<dt>
コマンド
</dt>
<dd>
<p>
        トップレベルのプロジェクトファイル(wscript)に存在する関数で <em>waflib.Context.Context</em> インスタンスを唯一の入力パラメータとして受け付ける。関数名がコマンドラインで与えられるとその関数が実行される(例えば <em>waf configure</em> を実行すると関数 <em>configure</em> が実行される)
</p>
</dd>
<dt>
バリアント
</dt>
<dd>
<p>
        異なるコンパイルフラグで同じターゲットを生成するための(ビルド)コマンドを有効にするために使われる、追加のアウトプットディレクトリ
</p>
</dd>
</dl></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2012-02-17 18:36:47 JST
</div>
</div>
</body>
</html>
